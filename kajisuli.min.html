<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>KAJISU</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.55.2/phaser.min.js"></script>

    <script>
const ProjectileComponentSystem={componentTypes:{},registerComponent:function(e,t){this.componentTypes[e]=t},addComponent:function(e,t,i={}){if(e.components=e.components||{},e.components[t]||!this.componentTypes[t])return e;const n={...this.componentTypes[t]};return Object.assign(n,i),e.components[t]=n,n.initialize&&n.initialize(e),e},processEvent:function(e,t,...i){e&&e.components&&Object.values(e.components).forEach((n=>{n[t]&&n[t](e,...i,e.scene)}))}},CRIMSON_SCATTER_CONFIG={maxDamageMultiplier:1.6,minDamageMultiplier:.4,distanceMultiplier:400};function applyPoisonEffect(e,t,i){if(t.health<=0)return;t.originalColor=t.style.color||"#ff5555",t.setColor("#2aad27");const n=.5*i;let o=0;const a=`poison_${Date.now()}_${Math.random()}`,r=registerTimer(e.time.addEvent({delay:1e3,callback:function(){t&&t.active&&(applyContactDamage.call(e,{damageSourceId:a,damage:n,active:!0},t,n,0),o++,4===o&&t.active&&t.setColor(t.originalColor))},callbackScope:e,repeat:3}));window.registerEffect("timer",r)}function createPersistentEffect(e,t,i,n={}){const o={...{symbol:"火",color:"#FF4500",fontSize:"24px",damage:playerDamage/10,tickInterval:200,duration:4e3,pulsing:!0,bodyScale:.8,startScale:.5,alpha:1,sourceEffect:null},...n},a=e.add.text(t,i,o.symbol,{fontFamily:"Arial",fontSize:o.fontSize,color:o.color,fontStyle:"bold"}).setOrigin(.5);a.setAlpha(o.alpha),e.physics.world.enable(a),a.body.setSize(a.width*o.bodyScale,a.height*o.bodyScale),a.body.setAllowGravity(!1),a.body.setImmovable(!0),a.damagePerTick=o.damage,a.tickInterval=o.tickInterval,a.damageSourceId=`effect_${Date.now()}_${Math.random()}`,a.sourceEffect=o.sourceEffect,window.registerEffect("entity",a);const r=registerTimer(e.time.addEvent({delay:o.tickInterval,callback:function(){a.active&&e.physics.overlap(a,EnemySystem.enemiesGroup,((t,i)=>{applyContactDamage.call(e,t,i,t.damagePerTick,t.tickInterval-100)}))},callbackScope:e,loop:!0}));let s=null;o.pulsing&&(s=e.tweens.add({targets:a,scale:{from:.9,to:1.1},duration:500,yoyo:!0,repeat:-1}));e.tweens.add({targets:a,alpha:{from:o.alpha,to:0},duration:o.duration,delay:100,onComplete:function(){r.remove(),s&&s.stop(),a.destroy()}});return a.setScale(o.startScale),e.tweens.add({targets:a,scale:1,duration:200,ease:"Back.out"}),a}ProjectileComponentSystem.registerComponent("distanceDamage",{initialize:function(e){this.startX=e.x,this.startY=e.y,this.baseDamage=playerDamage,this.maxDistance=Math.sqrt(playerFireRate/BASE_STATS.AGI)*CRIMSON_SCATTER_CONFIG.distanceMultiplier,e.setScale(CRIMSON_SCATTER_CONFIG.maxDamageMultiplier),e.damage=this.baseDamage*CRIMSON_SCATTER_CONFIG.maxDamageMultiplier},update:function(e){const t=e.x-this.startX,i=e.y-this.startY,n=Math.sqrt(t*t+i*i);let o=CRIMSON_SCATTER_CONFIG.maxDamageMultiplier-(CRIMSON_SCATTER_CONFIG.maxDamageMultiplier-CRIMSON_SCATTER_CONFIG.minDamageMultiplier)*Math.min(n,this.maxDistance)/this.maxDistance;e.damage=this.baseDamage*o,e.setScale(o)}}),ProjectileComponentSystem.registerComponent("slowEffect",{initialize:function(e){if(e&&e.active)try{e.setColor("#00ffff")}catch(e){console.log("Error setting projectile color in slowEffect:",e)}},onHit:function(e,t,i){if(t&&t.active&&!(t.health<=0)&&!t.isSlowed){t.isSlowed=!0,t.originalSpeed=t.speed||50;try{t.speed=Math.max(10,.5*t.speed),t.originalColor=t.style&&t.style.color?t.style.color:"#ff5555","function"==typeof t.setColor&&t.setColor("#00ffff")}catch(e){console.log("Error in slowEffect onHit:",e)}}}}),ProjectileComponentSystem.registerComponent("explosionEffect",{initialize:function(e){e.setColor("#FF9500"),this.damageMultiplier=1,this.radiusMultiplier=80,this.falloffMultiplier=0,this.radius=this.radiusMultiplier*Math.sqrt(playerLuck/BASE_STATS.LUK),e.explosionSourceId=`explosion_${Date.now()}_${Math.random()}`},onHit:function(e,t,i){if(e.effectTriggered)return;e.effectTriggered=!0;const n=t.x,o=t.y;this.createExplosionEffect(n,o,i);const a=playerDamage*this.damageMultiplier,r=EnemySystem.enemiesGroup.getChildren(),s=t;r.forEach((t=>{if(t===s||!t.active)return;const r=t.x-n,l=t.y-o,c=Math.sqrt(r*r+l*l);if(c<=this.radius){let n=a;if(this.falloffMultiplier>0){const e=1-c/this.radius*this.falloffMultiplier;n=a*e}applyContactDamage.call(i,{damageSourceId:e.explosionSourceId,damage:n,active:!0},t,n,0)}}))},createExplosionEffect:function(e,t,i){return VisualEffects.createExplosion(i,e,t,this.radius,16749824,{startScale:.2})}}),window.applyPoisonEffect=applyPoisonEffect,ProjectileComponentSystem.registerComponent("poisonEffect",{initialize:function(e){e.setColor("#2aad27")},onHit:function(e,t,i){t.health>0&&applyPoisonEffect(i,t,e.damage)}}),ProjectileComponentSystem.registerComponent("splitEffect",{initialize:function(e){e.setColor("#1E90FF")},onHit:function(e,t,i){if(t.health>0&&!e.hasSplit){e.hasSplit=!0;let n=0;0===e.body.velocity.x&&0===e.body.velocity.y||(n=Math.atan2(e.body.velocity.y,e.body.velocity.x));const o=n+Math.PI/2,a=n-Math.PI/2;for(const n of[o,a]){const o=WeaponSystem.createProjectile(i,{x:t.x,y:t.y,angle:n,color:"#1E90FF",symbol:"✧",damage:e.damage/2,speed:300,skipComponents:!0});o.hasSplit=!0,i.tweens.add({targets:o,alpha:{from:.7,to:1},scale:{from:.7,to:1},duration:200})}}}}),ProjectileComponentSystem.registerComponent("stompEffect",{initialize:function(e){this.createStompEffect(e,e.scene),e.stompTriggered=!0},createStompEffect:function(e,t){const i=96*Math.sqrt(playerLuck/BASE_STATS.LUK),n=player.x,o=player.y,a=`stomp_${Date.now()}_${Math.random()}`;VisualEffects.createExplosion(t,n,o,i,9127187,{startScale:.2});EnemySystem.enemiesGroup.getChildren().forEach((e=>{if(!e.active)return;const r=e.x-n,s=e.y-o;Math.sqrt(r*r+s*s)<=i&&applyContactDamage.call(t,{damageSourceId:a,damage:playerDamage,active:!0},e,playerDamage,0)}))}}),window.createPersistentEffect=createPersistentEffect,ProjectileComponentSystem.registerComponent("fireEffect",{initialize:function(e){e.setColor("#FF4500"),this.fireDamage=playerDamage/10,this.fireDuration=4e3,this.fireTickInterval=200},onHit:function(e,t,i){!t||!t.active||t.health<=0||e.effectTriggered||(e.effectTriggered=!0,createPersistentEffect(i,e.x,e.y,{symbol:"火",color:"#FF4500",fontSize:"24px",damage:this.fireDamage,tickInterval:this.fireTickInterval,duration:this.fireDuration,sourceEffect:"fire"}))}}),ProjectileComponentSystem.registerComponent("magmaDropEffect",{initialize:function(e){e.setColor("#FF6600"),this.magmaDamage=playerDamage,this.magmaDuration=1e3*playerLuck,this.magmaTickInterval=1e3},onHit:function(e,t,i){!t||!t.active||t.health<=0||e.effectTriggered||(e.effectTriggered=!0,createPersistentEffect(i,e.x,e.y,{symbol:"熔",color:"#FF4400",fontSize:"32px",damage:this.magmaDamage,tickInterval:this.magmaTickInterval,duration:this.magmaDuration,sourceEffect:"magma"}))}}),ProjectileComponentSystem.registerComponent("piercingEffect",{initialize:function(e){e.piercing=!0}}),ProjectileComponentSystem.registerComponent("healingAuraEffect",{initialize:function(e){e.setColor("#00ff00"),this.healRadius=128},onHit:function(e,t,i){const n=t.x,o=t.y,a=VisualEffects.convertToColorValue("#00ff00");VisualEffects.createExplosion(i,n,o,this.healRadius,a,{startScale:.2,duration:1e3});const r=player.x-n,s=player.y-o;Math.sqrt(r*r+s*s)<=this.healRadius&&LifeSystem.regenerateHealth.call(i)}}),ProjectileComponentSystem.registerComponent("boomerangEffect",{initialize:function(e){e.piercing=!0,this.startX=e.x,this.startY=e.y,this.maxDistance=400,this.returning=!1,this.initialized=!1,e.scene.tweens.add({targets:e,angle:360,duration:1e3,repeat:-1,ease:"Linear"}),e.needsOnFireEvent=!0},onFire:function(e,t,i){if(e.body&&e.body.velocity){const t=e.body.velocity;this.originalVelocity={x:t.x,y:t.y},this.originalSpeed=Math.sqrt(t.x*t.x+t.y*t.y),this.direction={x:t.x/this.originalSpeed,y:t.y/this.originalSpeed},this.initialized=!0}},update:function(e){if(e.active&&e.body){if(!this.initialized){if(!e.body||!e.body.velocity)return;{const t=e.body.velocity;this.originalVelocity={x:t.x,y:t.y},this.originalSpeed=Math.sqrt(t.x*t.x+t.y*t.y),this.direction={x:t.x/this.originalSpeed,y:t.y/this.originalSpeed},this.initialized=!0}}if(player&&player.active){if(!this.returning){const t=e.x-this.startX,i=e.y-this.startY;Math.sqrt(t*t+i*i)>=this.maxDistance&&(this.returning=!0,e.scene.tweens.add({targets:e,alpha:.3,scale:1.5,duration:100,yoyo:!0,repeat:1}))}if(this.returning){const t=player.x-e.x,i=player.y-e.y,n=Math.sqrt(t*t+i*i);if(n<30)return void e.destroy();const o=1.2*this.originalSpeed,a=t/n*o,r=i/n*o;e.body.setVelocity(a,r)}}else e.destroy()}}});const BackgroundAnimationSystem={config:{particleCount:200,particleSize:{min:1,max:3},particleSpeed:{min:5,max:50},baseColor:14540253,bossColor:16726072,normalOpacity:.2,bossOpacity:.3,bossModeActive:!1,debugMode:!1},scene:null,particles:[],particleContainer:null,testParticle:null,isInitialized:!1,init:function(e){if(!this.isInitialized)return console.log("Initializing background system..."),this.scene=e,this.calculateParticleCount(),this.createParticleContainer(),this.createParticles(),this.config.debugMode&&this.createTestParticle(),this.isInitialized=!0,console.log("Background system initialized with",this.particles.length,"particles"),this},calculateParticleCount:function(){if(!this.scene)return;const e=this.scene.sys.game.config.width*this.scene.sys.game.config.height;this.config.particleCount=Math.floor(e/4e3),this.config.particleCount=Math.min(Math.max(this.config.particleCount,100),1e3)},createParticleContainer:function(){this.particleContainer=this.scene.add.container(0,0),this.particleContainer.setDepth(-1e3)},createParticles:function(){this.particles.forEach((e=>e.destroy())),this.particles=[];for(let e=0;e<this.config.particleCount;e++)this.createOneParticle()},createOneParticle:function(){const e=Math.random()*this.scene.sys.game.config.width,t=Math.random()*this.scene.sys.game.config.height,i=Phaser.Math.Between(this.config.particleSize.min,this.config.particleSize.max),n=Phaser.Math.FloatBetween(this.config.particleSpeed.min,this.config.particleSpeed.max),o=Phaser.Math.FloatBetween(0,2*Math.PI),a=Math.cos(o)*n,r=Math.sin(o)*n,s=this.config.bossModeActive?this.config.bossOpacity:this.config.normalOpacity,l=this.config.bossModeActive?this.config.bossColor:this.config.baseColor,c=this.scene.add.circle(e,t,i,l,s);return c.velocityX=a,c.velocityY=r,this.particleContainer.add(c),this.particles.push(c),c},createTestParticle:function(){this.testParticle=this.scene.add.circle(this.scene.sys.game.config.width/2,this.scene.sys.game.config.height/2,20,16711680,1),this.particleContainer.add(this.testParticle),console.log("Created test particle at center of screen")},update:function(e,t){if(!this.isInitialized||!this.particleContainer)return;const i=t/1e3;this.particles.forEach((e=>{e.x+=e.velocityX*i,e.y+=e.velocityY*i,e.x<-e.radius?e.x=this.scene.sys.game.config.width+e.radius:e.x>this.scene.sys.game.config.width+e.radius&&(e.x=-e.radius),e.y<-e.radius?e.y=this.scene.sys.game.config.height+e.radius:e.y>this.scene.sys.game.config.height+e.radius&&(e.y=-e.radius)})),this.config.debugMode&&this.testParticle&&(this.testParticle.fillColor=e%2e3<1e3?16711680:65280)},setBossMode:function(e){if(this.config.bossModeActive===e)return;this.config.bossModeActive=e;const t=e?this.config.bossColor:this.config.baseColor,i=e?this.config.bossOpacity:this.config.normalOpacity;this.particles.forEach((e=>{e.fillColor=t,e.fillAlpha=i})),console.log("Background animation boss mode:",e?"ACTIVE":"INACTIVE")},setOpacity:function(e,t=!1){t?this.config.bossOpacity=Math.max(0,Math.min(1,e)):this.config.normalOpacity=Math.max(0,Math.min(1,e)),this.config.bossModeActive===t&&this.particles.forEach((t=>{t.fillAlpha=e})),console.log(`Background ${t?"boss":"normal"} opacity set to:`,e)},cleanup:function(){console.log("Cleaning up background system"),this.particles.forEach((e=>e.destroy())),this.particles=[],this.testParticle&&(this.testParticle.destroy(),this.testParticle=null),this.particleContainer&&(this.particleContainer.destroy(),this.particleContainer=null),this.scene=null,this.isInitialized=!1}};window.BackgroundAnimationSystem=BackgroundAnimationSystem;const ProjectilePerkRegistry={perkEffects:{},registerPerkEffect:function(e,t){this.perkEffects[e]={componentName:t.componentName??null,chanceMultiplier:t.chanceMultiplier??1,applyChance:t.applyChance??!0,configGenerator:t.configGenerator??null}},applyPerkEffects:function(e,t){return Object.entries(this.perkEffects).forEach((([i,n])=>{if(hasPerk(i)){let i=!0;if(n.applyChance){const e=calculateProcChance(playerLuck,baseProcChance)*n.chanceMultiplier;i=Math.random()<e}if(i&&n.componentName){let i={};n.configGenerator&&(i=n.configGenerator(t)),ProjectileComponentSystem.addComponent(e,n.componentName,i)}}})),e}};ProjectilePerkRegistry.registerPerkEffect("CRIMSON_SCATTER",{componentName:"distanceDamage",applyChance:!1,configGenerator:e=>({startX:player.x,startY:player.y,baseDamage:playerDamage})}),ProjectilePerkRegistry.registerPerkEffect("AZURE_FROST",{componentName:"slowEffect",applyChance:!0}),ProjectilePerkRegistry.registerPerkEffect("GREEN_VENOM",{componentName:"poisonEffect",applyChance:!0}),ProjectilePerkRegistry.registerPerkEffect("AZURE_FORK",{componentName:"splitEffect",applyChance:!0}),ProjectilePerkRegistry.registerPerkEffect("SCARLET_EMBER",{componentName:"fireEffect",applyChance:!0}),ProjectilePerkRegistry.registerPerkEffect("PURPLE_OWL",{componentName:"multiShot",applyChance:!0,configGenerator:function(e){return{maxExtraShots:1}}}),ProjectilePerkRegistry.registerPerkEffect("TITAN_STOMP",{componentName:"stompEffect",applyChance:!0,configGenerator:function(e){return{}}}),ProjectilePerkRegistry.registerPerkEffect("AMBER_NOVA",{componentName:"explosionEffect",applyChance:!0,configGenerator:function(e){return{}}}),ProjectilePerkRegistry.registerPerkEffect("PIERCING_SHOTS",{componentName:"piercingEffect",applyChance:!0}),ProjectilePerkRegistry.registerPerkEffect("YELLOW_BOOMERANG",{componentName:"boomerangEffect",chanceMultiplier:.5,applyChance:!0});const ENEMY_RANK_DEFAULTS={1:{healthMultiplier:1,speedMin:25,speedMax:100,damage:1,color:"#ff5555",size:32,expValue:1},2:{healthMultiplier:4,speedMin:25,speedMax:100,damage:1,color:"#ff5555",size:48,expValue:4},3:{healthMultiplier:16,speedMin:25,speedMax:100,damage:1,color:"#ff5555",size:64,expValue:16},4:{healthMultiplier:64,speedMin:25,speedMax:100,damage:1,color:"#ff5555",size:80,expValue:64},5:{healthMultiplier:256,speedMin:25,speedMax:100,damage:1,color:"#ff5555",size:96,expValue:256},6:{healthMultiplier:1024,speedMin:25,speedMax:100,damage:1,color:"#ff5555",size:128,expValue:1024}},ENEMY_RANK_NAMES={1:"壱",2:"弐",3:"参",4:"肆",5:"伍",6:"陸"},BOSS_CONFIG={max_rank:4,health_multiplier:10,speed:100},ENEMY_TYPES={"鬼":{kana:"おに",romaji:"oni",english:"Demon"},"龍":{kana:"りゅう",romaji:"ryuu",english:"Dragon"},"蛇":{kana:"へび",romaji:"hebi",english:"Snake"},"魔":{kana:"ま",romaji:"ma",english:"Demon"},"死":{kana:"し",romaji:"shi",english:"Death"},"獣":{kana:"けもの",romaji:"kemono",english:"Beast"},"骨":{kana:"ほね",romaji:"hone",english:"Bone"},"影":{kana:"かげ",romaji:"kage",english:"Shadow"},"鮫":{kana:"さめ",romaji:"same",english:"Shark"},"妖":{kana:"よう",romaji:"you",english:"Bewitching"},"霊":{kana:"れい",romaji:"rei",english:"Spirit"},"怨":{kana:"うらみ",romaji:"urami",english:"Grudge"},"邪":{kana:"じゃ",romaji:"ja",english:"Evil"},"呪":{kana:"のろい",romaji:"noroi",english:"Curse"},"魂":{kana:"たましい",romaji:"tamashii",english:"Soul"},"闇":{kana:"やみ",romaji:"yami",english:"Darkness"},"煉":{kana:"れん",romaji:"ren",english:"Refine"},"殺":{kana:"さつ",romaji:"satsu",english:"Kill"},"禍":{kana:"わざわい",romaji:"wazawai",english:"Calamity"},"悪":{kana:"あく",romaji:"aku",english:"Evil"},"屍":{kana:"しかばね",romaji:"shikabane",english:"Corpse"},"凶":{kana:"きょう",romaji:"kyou",english:"Misfortune"},"餓":{kana:"が",romaji:"ga",english:"Hunger"},"狂":{kana:"きょう",romaji:"kyou",english:"Madness"},"災":{kana:"わざわい",romaji:"wazawai",english:"Disaster"},"亡":{kana:"ぼう",romaji:"bou",english:"Death"},"滅":{kana:"めつ",romaji:"metsu",english:"Destruction"},"崩":{kana:"ほう",romaji:"hou",english:"Collapse"},"破":{kana:"は",romaji:"ha",english:"Break"},"裂":{kana:"れつ",romaji:"retsu",english:"Tear"},"灰":{kana:"はい",romaji:"hai",english:"Ash"},"焦":{kana:"しょう",romaji:"shou",english:"Scorch"},"血":{kana:"ち",romaji:"chi",english:"Blood"},"斬":{kana:"ざん",romaji:"zan",english:"Slash"},"刺":{kana:"し",romaji:"shi",english:"Stab"},"砕":{kana:"さい",romaji:"sai",english:"Crush"},"毒":{kana:"どく",romaji:"doku",english:"Poison"},"疫":{kana:"えき",romaji:"eki",english:"Plague"},"病":{kana:"びょう",romaji:"byou",english:"Disease"},"腐":{kana:"ふ",romaji:"fu",english:"Rot"},"蝕":{kana:"しょく",romaji:"shoku",english:"Eclipse"},"墓":{kana:"はか",romaji:"haka",english:"Tomb"},"棺":{kana:"かん",romaji:"kan",english:"Coffin"},"葬":{kana:"そう",romaji:"sou",english:"Burial"},"鎖":{kana:"くさり",romaji:"kusari",english:"Chain"},"縛":{kana:"ばく",romaji:"baku",english:"Bind"},"罠":{kana:"わな",romaji:"wana",english:"Trap"},"恐":{kana:"きょう",romaji:"kyou",english:"Fear"},"脅":{kana:"きょう",romaji:"kyou",english:"Threaten"},"絶":{kana:"ぜつ",romaji:"zetsu",english:"Sever"},"終":{kana:"しゅう",romaji:"shuu",english:"End"},"喪":{kana:"そう",romaji:"sou",english:"Mourning"},"虚":{kana:"きょ",romaji:"kyo",english:"Void"},"空":{kana:"くう",romaji:"kuu",english:"Empty"},"虫":{kana:"むし",romaji:"mushi",english:"Insect"},"蜘":{kana:"くも",romaji:"kumo",english:"Spider"},"蛛":{kana:"くも",romaji:"kumo",english:"Spider"},"蠍":{kana:"さそり",romaji:"sasori",english:"Scorpion"},"蟹":{kana:"かに",romaji:"kani",english:"Crab"},"蛾":{kana:"が",romaji:"ga",english:"Moth"},"蝶":{kana:"ちょう",romaji:"chou",english:"Butterfly"},"蜂":{kana:"はち",romaji:"hachi",english:"Bee"},"蟻":{kana:"あり",romaji:"ari",english:"Ant"},"蛭":{kana:"ひる",romaji:"hiru",english:"Leech"},"蚊":{kana:"か",romaji:"ka",english:"Mosquito"},"蠅":{kana:"はえ",romaji:"hae",english:"Fly"},"蝙":{kana:"へん",romaji:"hen",english:"Bat"},"蟲":{kana:"むし",romaji:"mushi",english:"Bug"},"髑":{kana:"どく",romaji:"doku",english:"Skull"},"髏":{kana:"ろ",romaji:"ro",english:"Skeleton"},"怪":{kana:"かい",romaji:"kai",english:"Monster"},"妄":{kana:"もう",romaji:"mou",english:"Delusion"},"憑":{kana:"ひょう",romaji:"hyou",english:"Possession"},"鵺":{kana:"ぬえ",romaji:"nue",english:"Nue"},"魘":{kana:"えん",romaji:"en",english:"Nightmare"}};let ENEMY_TIER_ASSIGNMENTS={1:[],2:[],3:[],4:[],5:[],6:[]};function initializeEnemyTiers(e={1:8,2:4,3:2,4:2,5:2,6:2}){ENEMY_TIER_ASSIGNMENTS={1:[],2:[],3:[],4:[],5:[],6:[]};const t=[...Object.keys(ENEMY_TYPES)];for(let e=t.length-1;e>0;e--){const i=Math.floor(Math.random()*(e+1));[t[e],t[i]]=[t[i],t[e]]}let i=0;for(let n=1;n<=6;n++){const o=e[n]??0;if(!(i+o<=t.length)){ENEMY_TIER_ASSIGNMENTS[n]=t.slice(i),console.log(`Warning: Not enough enemy types for tier ${n}. Requested ${o}, assigned ${t.length-i}`);break}ENEMY_TIER_ASSIGNMENTS[n]=t.slice(i,i+o),i+=o}return console.log("Enemy tier assignments initialized:",Object.entries(ENEMY_TIER_ASSIGNMENTS).map((([e,t])=>`Tier ${e}: ${t.length} enemies`)).join(", ")),ENEMY_TIER_ASSIGNMENTS}function getEnemyData(e){if(!ENEMY_TYPES[e]){const t=Object.keys(ENEMY_TYPES);e=t[Math.floor(Math.random()*t.length)]}let t=1;for(let i=1;i<=6;i++)if(ENEMY_TIER_ASSIGNMENTS[i].includes(e)){t=i;break}return{...ENEMY_RANK_DEFAULTS[t]||ENEMY_RANK_DEFAULTS[1],...ENEMY_TYPES[e],type:e,rank:t}}function getAllEnemyTypes(){return Object.keys(ENEMY_TYPES)}function getEnemyTypesByRank(e){return ENEMY_TIER_ASSIGNMENTS[e]||[]}function getRandomEnemyType(){const e=getAllEnemyTypes();return e[Math.floor(Math.random()*e.length)]}function getRandomEnemyTypeByRank(e){const t=getEnemyTypesByRank(e);return 0===t.length?getRandomEnemyType():t[Math.floor(Math.random()*t.length)]}const CARD_COLORS={DEFAULT_BG:4473924,HOVER_BG:6710886,STROKE:15658734,STROKE_HOVER:16777215};function getActiveScene(){return window.game&&window.game.scene&&window.game.scene.scenes&&window.game.scene.scenes.length>0?window.game.scene.scenes[0]:"undefined"!=typeof game&&game&&game.scene&&game.scene.scenes&&game.scene.scenes.length>0?game.scene.scenes[0]:(console.error("Unable to access active game scene"),null)}function getPerks(){return window.PERKS?window.PERKS:void 0!==PERKS?PERKS:(console.error("PERKS object not found in global scope"),{})}function createPerkCardElements(e,t,i,n={}){const o=getActiveScene();if(!o||!o.add)return console.error("Cannot access active scene in createPerkCardElements"),[];if(!e)return console.error("Invalid perk provided to createPerkCardElements"),[];const a={...{container:null,showBackground:!0,showKana:!0,showRomaji:!0,showEnglish:!0,showDescription:!0,backgroundColor:CARD_COLORS.DEFAULT_BG,width:200,height:300,strokeWidth:2,strokeColor:CARD_COLORS.STROKE,makeInteractive:!1,perkCallback:null,fontSize:1},...n},r=[];if(a.showBackground){const n=o.add.rectangle(t,i,a.width,a.height,a.backgroundColor,1).setStrokeStyle(a.strokeWidth,a.strokeColor);a.container&&a.container.add&&a.container.add(n),a.makeInteractive&&e&&(n.setInteractive({useHandCursor:!0}),n.perkId=e.id,n.on("pointerover",(function(){this.fillColor=e.hoverColor??CARD_COLORS.HOVER_BG,this.setStrokeStyle(4,CARD_COLORS.STROKE_HOVER)})),n.on("pointerout",(function(){this.fillColor=a.backgroundColor,this.setStrokeStyle(a.strokeWidth,a.strokeColor)})),a.perkCallback&&"function"==typeof a.perkCallback&&n.on("pointerdown",(function(){a.perkCallback(e.id)}))),r.push(n)}const s="undefined"!=typeof KAJISULI_MODE&&KAJISULI_MODE,l={kanji:s?i-90:i-60,kana:s?i-44:i-15,romaji:s?i-16:i+10,english:i+40,description:s?i+120:i+85};if(e){const i=o.add.text(t,l.kanji,e.kanji,{fontFamily:"Arial",fontSize:36*a.fontSize+"px",color:e.color||"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:4}).setOrigin(.5);if(a.container&&a.container.add&&a.container.add(i),r.push(i),a.showKana){const i=o.add.text(t,l.kana,e.kana||"",{fontFamily:"Arial",fontSize:18*a.fontSize+"px",color:"#ffffff"}).setOrigin(.5);a.container&&a.container.add&&a.container.add(i),r.push(i)}if(a.showRomaji){const i=o.add.text(t,l.romaji,e.romaji||"",{fontFamily:"Arial",fontSize:16*a.fontSize+"px",color:"#dddddd",fontStyle:"italic"}).setOrigin(.5);a.container&&a.container.add&&a.container.add(i),r.push(i)}if(a.showEnglish){const i=o.add.text(t,l.english,e.english||"",{fontFamily:"Arial",fontSize:20*a.fontSize+"px",color:e.color||"#ffffff",fontStyle:"bold"}).setOrigin(.5);a.container&&a.container.add&&a.container.add(i),r.push(i)}if(a.showDescription){const i=o.add.text(t,l.description,e.description||"",{fontFamily:"Arial",fontSize:16*a.fontSize+"px",color:"#ffffff",align:"center",wordWrap:{width:a.width-20}}).setOrigin(.5);a.container&&a.container.add&&a.container.add(i),r.push(i)}}return r}function createPerkCard(e,t,i,n={}){const o=getPerks();if(0===Object.keys(o).length){console.error("PERKS not defined when calling createPerkCard");return createPerkCardElements({id:e||"undefined",kanji:"?",kana:"unknown",romaji:"unknown",english:"Unknown Perk",description:"Perk data could not be loaded",color:"#ff0000"},t,i,n)}const a=o[e];if(!a){console.error("Invalid perk ID provided to createPerkCard:",e);return createPerkCardElements({id:e,kanji:e.substring(0,1),kana:e,romaji:e,english:`Unknown: ${e}`,description:"This perk data could not be found",color:"#ff0000"},t,i,n)}return createPerkCardElements(a,t,i,{...n,showKana:!0,showRomaji:!0,showEnglish:!0,showDescription:!0})}function generateRandomPerkCards(e,t=[]){if(window.PerkSystem&&window.PerkSystem.getRandomPerks)return window.PerkSystem.getRandomPerks(e,t);const i=getPerks(),n=Object.keys(i).filter((e=>!t.includes(e))).map((e=>({id:e,...i[e]})));for(let e=n.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[n[e],n[t]]=[n[t],n[e]]}return n.slice(0,e)}function showMobileLevelUpScreen(e){PauseSystem.pauseGame();const t=PerkSystem.getRandomPerks(4,acquiredPerks),i=e.add.container(0,0);i.setDepth(1e3);const n=game.config.width/2,o=game.config.height/2,a=e.add.rectangle(n,o,game.config.width,game.config.height,0,.7),r=e.add.text(n,game.config.height*(KAJISULI_MODE?.12:.15),"LEVEL UP!",{fontFamily:"Arial",fontSize:KAJISULI_MODE?"48px":"32px",color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:4}).setOrigin(.5),s=e.add.text(n,game.config.height*(KAJISULI_MODE?.18:.22),"Choose a perk to continue",{fontFamily:"Arial",fontSize:KAJISULI_MODE?"27px":"18px",color:"#ffffff"}).setOrigin(.5);i.add(a),i.add(r),i.add(s),KAJISULI_MODE&&PauseSystem.showStatsDisplay(e,{container:i,positionY:.28*game.config.height,storeInElements:!1,clearContainer:!1,setVisible:!1,fontSize:"36px"});let l=0,c=[];function d(){c.forEach((e=>{e&&e.destroy&&e.destroy()})),c=[];const a=t[l];if(a){c=CardSystem.createPerkCardElements(a,n,o,{showKana:!0,showRomaji:!0,showEnglish:!0,showDescription:!0,width:KAJISULI_MODE?Math.min(300,.9*game.config.width):Math.min(200,.6*game.config.width),height:KAJISULI_MODE?450:300,fontSize:KAJISULI_MODE?1.5:1}),c.forEach((e=>{i.add(e)}));const t=c[0];t.setInteractive({useHandCursor:!0}),t.on("pointerdown",(()=>{y(a.id)})),e.tweens.add({targets:t,strokeStyle:{value:16776960},easeParams:[1,.5],yoyo:!0,duration:700,repeat:-1})}}const m={fontSize:"80px",color:"#ffffff",stroke:"#000000",strokeThickness:4},u=e.add.text(n-.3*game.config.width,o,"◀",m).setOrigin(.5);u.setInteractive({useHandCursor:!0}),u.on("pointerdown",(()=>{l=(l-1+4)%4,d(),f()}));const h=e.add.text(n+.3*game.config.width,o,"▶",m).setOrigin(.5);h.setInteractive({useHandCursor:!0}),h.on("pointerdown",(()=>{l=(l+1)%4,d(),f()})),i.add(u),i.add(h);const p=e.add.text(n,o+.21*game.config.height,`${l+1}/4`,{fontFamily:"Arial",fontSize:"36px",color:"#ffffff"}).setOrigin(.5);function f(){p.setText(`${l+1}/4`),u.setVisible(!0),h.setVisible(!0),u.setAlpha(0===l?.5:1),h.setAlpha(3===l?.5:1)}i.add(p);const g=e.add.text(n,.8*game.config.height,"Select This Perk",{fontFamily:"Arial",fontSize:"40px",color:"#ffffff",backgroundColor:"#008800",padding:{left:30,right:30,top:20,bottom:20}}).setOrigin(.5);function y(t){acquirePerk(e,t),GameUI.updateStatCircles(e),GameUI.updateHealthBar(e),e.tweens.add({targets:player,alpha:.2,scale:1.5,duration:200,yoyo:!0,repeat:1,onComplete:function(){player.setScale(1),player.alpha=1,window.levelUpInProgress=!1,heroExp>=xpForNextLevel(playerLevel)&&setTimeout((()=>{heroExp>=xpForNextLevel(playerLevel)&&!window.levelUpInProgress&&(window.levelUpInProgress=!0,levelUp.call(e))}),100)}}),i.destroy(),levelUpCards=[],PauseSystem.resumeGame()}g.setInteractive({useHandCursor:!0}),g.on("pointerover",(function(){this.setStyle({backgroundColor:"#00aa00"})})),g.on("pointerout",(function(){this.setStyle({backgroundColor:"#008800"})})),g.on("pointerdown",(()=>{const e=t[l];e&&y(e.id)})),i.add(g),d(),f(),levelUpCards=[i]}function showLevelUpScreen(e){"undefined"!=typeof KAJISULI_MODE&&KAJISULI_MODE?showMobileLevelUpScreen(e):window.RomajiChallengeSystem?window.RomajiChallengeSystem.showLevelUpChallenge(e):(console.error("RomajiChallengeSystem not found, falling back to mobile implementation"),showMobileLevelUpScreen(e))}const CardSystem={createPerkCardElements:createPerkCardElements,createPerkCard:createPerkCard,getActiveScene:getActiveScene,showLevelUpScreen:showLevelUpScreen,showMobileLevelUpScreen:showMobileLevelUpScreen,generateRandomPerkCards:generateRandomPerkCards,CARD_COLORS:CARD_COLORS};window.CardSystem=CardSystem;const RomajiChallengeSystem={state:{currentCards:1,maxCards:4,selectedPerks:[],inputActive:!0,attempts:0,currentIndex:0,cardElements:[]},elements:{inputBox:null,inputText:null,submitButton:null,inputPrompt:null,levelUpContainer:null,perkCardContainer:null},handlers:{keydownHandler:null},originalDebugKeysState:null,init:function(e){this.resetState(),console.log("Romaji Challenge System initialized")},resetState:function(){this.state={currentCards:1,maxCards:4,selectedPerks:[],inputActive:!0,attempts:0,currentIndex:0,cardElements:[]},this.elements={inputBox:null,inputText:null,submitButton:null,inputPrompt:null,levelUpContainer:null,perkCardContainer:null},this.handlers.keydownHandler&&(window.removeEventListener("keydown",this.handlers.keydownHandler),this.handlers.keydownHandler=null),this.restoreDebugKeys()},showLevelUpChallenge:function(e){PauseSystem.pauseGame(),this.elements.levelUpContainer=e.add.container(0,0),this.elements.levelUpContainer.setDepth(1e3);const t=game.config.width/2,i=game.config.height/2,n=e.add.rectangle(t,i,game.config.width,game.config.height,0,.7),o=e.add.text(t,.1875*game.config.height,"LEVEL UP!",{fontFamily:"Arial",fontSize:"32px",color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:4}).setOrigin(.5);this.elements.levelUpContainer.add(n),this.elements.levelUpContainer.add(o),this.state.selectedPerks=PerkSystem.getRandomPerks(4,acquiredPerks),this.elements.perkCardContainer=e.add.container(0,0),this.elements.levelUpContainer.add(this.elements.perkCardContainer),this.createRomajiInput(e,t,.725*game.config.height),this.updatePerkCardDisplay(e),levelUpCards=[this.elements.levelUpContainer],this.disableDebugKeys(e)},disableDebugKeys:function(e){this.originalDebugKeysState=e.debugKeysDisabled,e.debugKeysDisabled=!0},restoreDebugKeys:function(){const e=game.scene.scenes[0];e&&(null!==this.originalDebugKeysState?(e.debugKeysDisabled=this.originalDebugKeysState,this.originalDebugKeysState=null):e.debugKeysDisabled=!1)},createRomajiInput:function(e,t,i){this.elements.inputPrompt=e.add.text(t,i-.0625*game.config.height,"TYPE ROMAJI TO UNLOCK MORE",{fontFamily:"Arial",fontSize:"18px",color:"#ffffff"}).setOrigin(.5);const n=.25*game.config.width;this.elements.inputBox=e.add.rectangle(t,i,n,40,3355443,1).setStrokeStyle(2,11184810),this.elements.inputText=e.add.text(t-n/2+10,i-15,"",{fontFamily:"Arial",fontSize:"20px",color:"#ffffff"}),this.elements.submitButton=e.add.text(t,i+.0625*game.config.height,"Submit",{fontFamily:"Arial",fontSize:"18px",color:"#ffffff",backgroundColor:"#008800",padding:{left:15,right:15,top:8,bottom:8}}).setOrigin(.5),this.elements.levelUpContainer.add(this.elements.inputPrompt),this.elements.levelUpContainer.add(this.elements.inputBox),this.elements.levelUpContainer.add(this.elements.inputText),this.elements.levelUpContainer.add(this.elements.submitButton),this.elements.submitButton.setInteractive({useHandCursor:!0}),this.elements.submitButton.on("pointerover",(function(){this.setStyle({backgroundColor:"#00aa00"})})),this.elements.submitButton.on("pointerout",(function(){this.setStyle({backgroundColor:"#008800"})})),this.elements.submitButton.on("pointerdown",(()=>{this.validateRomajiInput(e)})),this.handlers.keydownHandler=t=>{this.state.inputActive&&("Backspace"===t.key?this.elements.inputText.text.length>0&&this.elements.inputText.setText(this.elements.inputText.text.slice(0,-1)):"Enter"===t.key?this.validateRomajiInput(e):/^[a-zA-Z\-]$/.test(t.key)&&this.elements.inputText.setText(this.elements.inputText.text+t.key.toLowerCase()))},window.addEventListener("keydown",this.handlers.keydownHandler)},updatePerkCardDisplay:function(e){this.elements.perkCardContainer.removeAll(!0),this.state.cardElements=[];const t=this.state.currentCards,i=.0167*game.config.width,n=220*t+(t-1)*i,o=game.config.width/2-n/2+110;for(let n=0;n<t;n++){const t=o+n*(220+i),a=this.state.selectedPerks[n];if(!a){console.log("Warning: No perk found for index "+n);continue}const r=n===this.state.currentCards-1&&this.state.inputActive&&n===this.state.currentIndex,s=!r||this.state.attempts>=1,l=!r||this.state.attempts>=2,c=!r||this.state.attempts>=2,d=!r||this.state.attempts>=2,m=window.CardSystem.createPerkCardElements(a,t,.4125*game.config.height,{container:this.elements.perkCardContainer,showKana:s,showRomaji:l,showEnglish:c,showDescription:d,makeInteractive:!0,perkCallback:t=>{this.selectCard(e,t)}});this.state.cardElements.push({background:m[0],elements:m.slice(1)})}this.updateInputVisibility()},validateRomajiInput:function(e){if(!this.state.inputActive)return;const t=this.elements.inputText.text.trim().toLowerCase(),i=this.state.selectedPerks[this.state.currentIndex];if(!i)return;t===i.romaji.toLowerCase()?this.handleCorrectRomaji(e):this.handleWrongRomaji(e),this.elements.inputText.setText("")},handleCorrectRomaji:function(e){const t=this.elements.inputBox;if(!t)return;e.tweens.add({targets:t,strokeStyle:{value:65280},alpha:{value:.8},yoyo:!0,duration:200,repeat:1,onComplete:function(){t&&t.active&&(t.setStrokeStyle(2,11184810),t.alpha=1)}});const i=game.config.width/2,n=.8125*game.config.height,o=e.add.text(i,n,"Correct!",{fontFamily:"Arial",fontSize:"24px",color:"#00ff00",fontStyle:"bold"}).setOrigin(.5);if(this.elements.levelUpContainer.add(o),e.tweens.add({targets:o,y:o.y-30,alpha:0,duration:1e3,onComplete:function(){o.destroy()}}),this.state.attempts=2,this.state.currentCards>=this.state.maxCards){const t=playerLevel,n=(xpForNextLevel(playerLevel),heroExp,Math.ceil(.25*xpForNextLevel(playerLevel)));heroExp+=n,setTimeout((()=>{console.log(`Post-update check: Level ${playerLevel}, XP ${heroExp}/${xpForNextLevel(playerLevel)}`),playerLevel>t&&console.log(`WARNING: Level changed from ${t} to ${playerLevel} after challenge reward!`)}),100),GameUI.updateExpBar(e);const o=.85*game.config.height,a=e.add.text(i,o,`+${n} XP Bonus!`,{fontFamily:"Arial",fontSize:"20px",color:"#00ffff",fontStyle:"bold"}).setOrigin(.5);e.tweens.add({targets:a,y:a.y-30,alpha:0,duration:1500,onComplete:function(){a.destroy()}}),this.state.inputActive=!1}else this.state.currentCards=Math.min(this.state.currentCards+1,this.state.maxCards),this.state.currentIndex=this.state.currentCards-1,this.state.attempts=0;this.updatePerkCardDisplay(e)},handleWrongRomaji:function(e){const t=this.elements.inputBox;if(!t)return;e.tweens.add({targets:t,strokeStyle:{value:16711680},alpha:{value:.8},yoyo:!0,duration:200,repeat:1,onComplete:function(){t&&t.active&&(t.setStrokeStyle(2,11184810),t.alpha=1)}}),this.state.attempts++;const i=game.config.width/2,n=.8125*game.config.height;if(1===this.state.attempts){const t=e.add.text(i,n,"Hint: Check the kana!",{fontFamily:"Arial",fontSize:"18px",color:"#ffff00"}).setOrigin(.5);this.elements.levelUpContainer.add(t),e.tweens.add({targets:t,y:t.y-20,alpha:0,duration:1500,onComplete:function(){t.destroy()}});const o=this.state.selectedPerks[this.state.currentIndex],a=this.state.cardElements[this.state.currentIndex].background.x,r=.39375*game.config.height,s=e.add.text(a,r,o.kana,{fontFamily:"Arial",fontSize:"20px",color:"#ffffff"}).setOrigin(.5);this.elements.perkCardContainer.add(s),this.state.cardElements[this.state.currentIndex].elements.push(s)}else{const t=e.add.text(i,n,"Challenge ended - pick a perk",{fontFamily:"Arial",fontSize:"18px",color:"#ff6666"}).setOrigin(.5);this.elements.levelUpContainer.add(t),e.tweens.add({targets:t,y:t.y-20,alpha:0,duration:1500,onComplete:function(){t.destroy()}}),this.state.inputActive=!1,this.elements.perkCardContainer.removeAll(!0),this.updatePerkCardDisplay(e)}},updateInputVisibility:function(){const e=this.state.inputActive;this.elements.inputBox&&this.elements.inputBox.setVisible(e),this.elements.inputText&&this.elements.inputText.setVisible(e),this.elements.submitButton&&this.elements.submitButton.setVisible(e),this.elements.inputPrompt&&this.elements.inputPrompt.setVisible(e),e||levelUpCards.forEach((e=>{e&&"Type romaji to unlock more choices"===e.text&&e.setText("Choose a perk to continue")}))},selectCard:function(e,t){acquirePerk(e,t),GameUI.updateStatCircles(e),GameUI.updateHealthBar(e),levelUpCards.forEach((e=>{e&&e.setVisible&&e.setVisible(!1)})),this.elements.perkCardContainer&&this.elements.perkCardContainer.setVisible(!1),this.closeLevelUpCards(e),e.tweens.add({targets:player,alpha:.2,scale:1.5,duration:200,yoyo:!0,repeat:1,onComplete:function(){player.setScale(1),player.alpha=1,window.levelUpInProgress=!1,heroExp>=xpForNextLevel(playerLevel)&&setTimeout((()=>{heroExp>=xpForNextLevel(playerLevel)&&!window.levelUpInProgress&&(window.levelUpInProgress=!0,levelUp.call(e))}),100)}}),console.log("Level up complete, game resumed")},closeLevelUpCards:function(e){if(this.handlers.keydownHandler&&(window.removeEventListener("keydown",this.handlers.keydownHandler),this.handlers.keydownHandler=null),this.restoreDebugKeys(),!e.add)return console.log("Not in a valid scene, forcing cleanup"),levelUpCards=[],void this.resetState();this.elements.levelUpContainer&&(this.elements.levelUpContainer.destroy(),this.elements.levelUpContainer=null),this.resetState(),levelUpCards=[],PauseSystem.resumeGame()}};window.RomajiChallengeSystem=RomajiChallengeSystem;const CooldownManager={registeredTimers:[],lastStats:{luck:null,fireRate:null,damage:null,health:null},initialize:function(){this.registeredTimers=[],this.lastStats.luck=playerLuck,this.lastStats.fireRate=playerFireRate,this.lastStats.damage=playerDamage,this.lastStats.health=maxPlayerHealth,console.log("CooldownManager initialized with stats:",this.lastStats)},createTimer:function(e){const t=game.scene.scenes[0];if(!t)return null;const i="luck"===e.statName?playerLuck:"fireRate"===e.statName?playerFireRate:"damage"===e.statName?playerDamage:"health"===e.statName?maxPlayerHealth:1;let n;if("multiply"===e.formula)n=e.baseCooldown*i;else if("sqrt"===e.formula){const t="luck"===e.statName?BASE_STATS.LUK:"fireRate"===e.statName?BASE_STATS.AGI:"damage"===e.statName?BASE_STATS.POW:"health"===e.statName?BASE_STATS.END:4;n=e.baseCooldown/Math.sqrt(i/t)}else n=e.baseCooldown/i;const o=t.time.addEvent({delay:n,callback:e.callback,callbackScope:e.callbackScope,loop:e.loop??!0});window.registerEffect("timer",o);const a={timer:o,statName:e.statName??"luck",baseCooldown:e.baseCooldown??3e4,formula:e.formula??"divide",component:e.component??null,callback:e.callback,callbackScope:e.callbackScope,loop:e.loop??!0};return this.registeredTimers.push(a),o},removeTimer:function(e){e&&(this.registeredTimers=this.registeredTimers.filter((t=>t.timer!==e)),e&&!e.hasOwnProperty("removed")&&e.remove())},update:function(){let e=!1;const t={};Math.abs(this.lastStats.luck-playerLuck)>=.1*this.lastStats.luck&&(t.luck=playerLuck,e=!0),Math.abs(this.lastStats.fireRate-playerFireRate)>=.1*this.lastStats.fireRate&&(t.fireRate=playerFireRate,e=!0),Math.abs(this.lastStats.damage-playerDamage)>=.1*this.lastStats.damage&&(t.damage=playerDamage,e=!0),Math.abs(this.lastStats.health-maxPlayerHealth)>=.1*this.lastStats.health&&(t.health=maxPlayerHealth,e=!0),e&&(console.log("Significant stat changes detected:",t),this.registeredTimers.forEach((e=>{t.hasOwnProperty(e.statName)&&this.updateTimer(e,t[e.statName])})),Object.assign(this.lastStats,t))},updateTimer:function(e,t){if(!e.timer||e.timer.hasOwnProperty("removed"))return;let i;if("multiply"===e.formula)i=e.baseCooldown*t;else if("sqrt"===e.formula){const n="luck"===e.statName?BASE_STATS.LUK:"fireRate"===e.statName?BASE_STATS.AGI:"damage"===e.statName?BASE_STATS.POW:"health"===e.statName?BASE_STATS.END:4;i=e.baseCooldown/Math.sqrt(t/n)}else i=e.baseCooldown/t;const n=e.timer.elapsed/e.timer.delay;console.log(`Updating timer: old delay=${e.timer.delay}ms, new delay=${i}ms, progress=${n.toFixed(2)}`);const o=game.scene.scenes[0];if(!o)return;e.timer.remove();const a=o.time.addEvent({delay:i,callback:e.callback,callbackScope:e.callbackScope,loop:e.loop});if(a.elapsed=n*i,window.registerEffect("timer",a),e.timer=a,e.component&&"object"==typeof e.component)if(e.component.firingTimer===e.timer)e.component.firingTimer=a;else for(const t in e.component)if(e.component[t]===e.timer){e.component[t]=a;break}}};window.CooldownManager=CooldownManager;const DebugSystem={debugModeEnabled:!1,statsVisible:!1,statsText:null,init:function(e){this.setupPerformanceMonitor(e),this.setupDebugKeys(e),console.log("Debug system initialized (press O to toggle)")},toggleDebugMode:function(e){this.debugModeEnabled=!this.debugModeEnabled,this.statsText&&(this.statsText.visible=this.debugModeEnabled,this.statsVisible=this.debugModeEnabled),e.physics.world.drawDebug=this.debugModeEnabled,this.debugModeEnabled&&!e.physics.world.debugGraphic&&e.physics.world.createDebugGraphic(),e.physics.world.debugGraphic&&(e.physics.world.debugGraphic.visible=this.debugModeEnabled),console.log("Debug mode "+(this.debugModeEnabled?"enabled":"disabled"))},setupPerformanceMonitor:function(e){const t=game.config.width-20;this.statsText=e.add.text(t,10,"FPS: 0",{fontFamily:"Arial",fontSize:"14px",color:"#00ff00",backgroundColor:"#000000",padding:{x:5,y:5}}),this.statsText.setOrigin(1,0),this.statsText.setDepth(1e3),this.statsText.visible=!1,this.statsVisible=!1},updatePerformanceStats:function(e,t,i){if(this.statsText&&this.statsVisible){const t=Math.round(e.game.loop.actualFps);let n=0;e.physics&&e.physics.world&&(n=e.physics.world.bodies.size);const o=e.children.list.length;let a=0,r=0;window.EnemySystem&&window.EnemySystem.enemiesGroup&&(a=window.EnemySystem.enemiesGroup.getChildren().length),window.projectiles&&(r=window.projectiles.getChildren().length);const s=i.toFixed(2);let l="N/A";window.performance&&window.performance.memory&&(l=Math.round(window.performance.memory.usedJSHeapSize/1048576)+" MB"),this.statsText.setText(`DEBUG MODE ON\nFPS: ${t}\nFrame Time: ${s}ms\nMemory: ${l}\nTotal Objects: ${o}\nEnemies: ${a}\nProjectiles: ${r}\nPhysics Bodies: ${n}`)}},setupDebugKeys:function(e){e.input.keyboard.on("keydown-R",(function(){if(!this.debugKeysDisabled&&!gamePaused&&!gameOver){const e=xpForNextLevel(playerLevel)-heroExp;heroExp+=e,GameUI.updateExpBar(this),console.log("Debug: Instant level up triggered")}}),e),e.input.keyboard.on("keydown-T",(function(){if(!this.debugKeysDisabled&&!gamePaused&&!gameOver){const e=this;e&&(window.spawnEnemyOfRank.call(e,1),console.log("Debug: Rank 1 enemy spawned"))}}),e),e.input.keyboard.on("keydown-K",(function(){this.debugKeysDisabled||gamePaused||gameOver||DebugSystem.skipToNextPhase.call(this)}),e),e.input.keyboard.on("keydown-O",(function(){this.debugKeysDisabled||DebugSystem.toggleDebugMode(this)}),e),e.input.keyboard.on("keydown-M",(function(){if(!this.debugKeysDisabled)if(window.MusicSystem){const e=MusicSystem.setMusicEnabled(!MusicSystem.musicEnabled);console.log("Debug: Music "+(e?"enabled":"disabled"))}else console.log("Debug: MusicSystem not available")}),e)},skipToNextPhase:function(){const e=elapsedTime/60,t=Object.values(rankEnemyStartTimes).map((e=>e/60));t.sort(((e,t)=>e-t));let i=null;for(const n of t)if(n>e){i=n;break}if(null===i){Math.max(...t);i=12*Math.floor(e/12)+12,i<=e&&(i=e+12)}const n=elapsedTime;elapsedTime=60*i,console.log(`Debug: Time skipped from ${Math.floor(n/60)} minutes to ${i} minutes`),GameUI.updateStatusDisplay(this,elapsedTime,score),EnemySystem.updateEnemySpawners()},disableDebugKeys:function(e){e.debugKeysDisabled=!0},restoreDebugKeys:function(e){e.debugKeysDisabled=!1},cleanup:function(){this.statsText&&(this.statsText.destroy(),this.statsText=null),this.debugModeEnabled=!1,this.statsVisible=!1}};window.DebugSystem=DebugSystem;const drops=[],DropBehaviors={projectile:function(e,t,i){if(applyContactDamage.call(e,t.entity,i,t.entity.damage,t.damageInterval),t.options&&t.options.effectComponent){const n=t.options.effectComponent,o=ProjectileComponentSystem.componentTypes[n];if(o&&o.onHit){const n={damage:t.entity.damage,x:t.entity.x,y:t.entity.y,damageSourceId:t.entity.damageSourceId+"_effect"};o.onHit(n,i,e)}}t.health-=1,VisualEffects.createDamageFlash(e,t.entity),t.health<=0&&DropperSystem.destroyDrop(t)},persistent:function(e,t,i){applyContactDamage.call(e,t.entity,i,t.entity.damage,t.damageInterval)},areaEffect:function(e,t,i){t.health-=1,VisualEffects.createDamageFlash(e,t.entity),t.health<=0&&DropperSystem.destroyDrop(t)}},DropperSystem={init:function(){this.clearAll(),console.log("Dropper system initialized")},create:function(e,t){const i={...{symbol:"★",color:"#ffff00",fontSize:32,x:player.x,y:player.y,behaviorType:"projectile",damage:playerDamage,damageInterval:500,colliderSize:.8,lifespan:null,health:1,options:{}},...t},n=e.add.text(i.x,i.y,i.symbol,{fontFamily:"Arial",fontSize:`${i.fontSize}px`,color:i.color,fontStyle:"bold"}).setOrigin(.5);void 0!==i.options.opacity&&n.setAlpha(i.options.opacity),e.physics.world.enable(n),n.body.setSize(n.width*i.colliderSize,n.height*i.colliderSize),n.body.setImmovable(!0),n.damageSourceId=`drop_${Date.now()}_${Math.random()}`,n.damage=i.damage;const o={entity:n,behaviorType:i.behaviorType,damageInterval:i.damageInterval,createdAt:e.time.now,lifespan:i.lifespan,areaEffectInterval:i.options.areaEffectInterval??1e3,areaEffectRadius:i.options.areaEffectRadius??100,health:i.health,options:i.options,destroyed:!1};drops.push(o),window.registerEffect("entity",n),"areaEffect"===o.behaviorType&&(o.areaEffectTimer=CooldownManager.createTimer({statName:"luck",baseCooldown:o.areaEffectInterval,formula:"sqrt",component:o,callback:function(){gameOver||gamePaused||o.destroyed||!o.entity||!o.entity.active||DropperSystem.processAreaEffect(e,o,e.time.now)},callbackScope:e,loop:!0}));const a=DropBehaviors[i.behaviorType]??DropBehaviors.projectile;if(e.physics.add.overlap(n,EnemySystem.enemiesGroup,(function(t,i){o.destroyed||a(e,o,i)}),null,e),e.tweens.add({targets:n,scale:{from:i.initialScale,to:1},duration:500,ease:"Back.out"}),applyVisualEffects(e,n,i.options),null!==o.lifespan){const t=e.time.delayedCall(o.lifespan,(function(){DropperSystem.destroyDrop(o)}));window.registerEffect("timer",t)}return o},update:function(e,t){gameOver||gamePaused||0===drops.length||this.cleanupInactive()},processAreaEffect:function(e,t,i){const n=EnemySystem.enemiesGroup.getChildren(),o=t.entity.x,a=t.entity.y;let r=t.areaEffectRadius;t.options.radiusScalesWithLuck&&(r*=Math.sqrt(playerLuck/BASE_STATS.LUK));const s=t.options.pulseColor??16776960;this.createPulseEffect(e,o,a,r,s);const l=t.options.effectComponent,c=l?ProjectileComponentSystem.componentTypes[l]:null;n.forEach((i=>{if(!i.active)return;const n=i.x-o,s=i.y-a;if(Math.sqrt(n*n+s*s)<=r){const n=t.entity.damage,r=`${t.entity.damageSourceId}_area_${i.id??Math.random()}`;if(applyContactDamage.call(e,{damageSourceId:r,damage:n,active:!0},i,n,0),c&&c.onHit){const n={damage:t.entity.damage,x:o,y:a,damageSourceId:`${t.entity.damageSourceId}_component_${Date.now()}_${Math.random()}`};c.onHit(n,i,e)}0}}))},createPulseEffect:function(e,t,i,n,o){return VisualEffects.createExplosion(e,t,i,n,o)},cleanupInactive:function(){for(let e=drops.length-1;e>=0;e--){const t=drops[e];!t.destroyed&&t.entity&&t.entity.active||drops.splice(e,1)}},clearAll:function(){drops.forEach((e=>{e.entity&&e.entity.active&&e.entity.destroy()})),drops.length=0},getAll:function(){return drops.filter((e=>!e.destroyed&&e.entity&&e.entity.active))},getCount:function(){return this.getAll().length},setupPeriodicDrops:function(e,t){const i={getConfig:function(){return{}},cooldown:4e3,positionMode:"player",trailInterval:32,lastDropPos:{x:0,y:0},enabled:!0,...t};"trail"===i.positionMode&&player&&(i.lastDropPos.x=player.x,i.lastDropPos.y=player.y);let n=i.cooldown;"function"==typeof n&&(n=n());const o=e.time.addEvent({delay:n,callback:function(){if(!i.enabled)return;if(gameOver||gamePaused)return;const t=i.getConfig();let n,o,a=!0;switch(i.positionMode){case"random":n=Phaser.Math.Between(0,game.config.width),o=Phaser.Math.Between(0,game.config.height);break;case"trail":if(!player||!player.active){a=!1;break}const e=player.x-i.lastDropPos.x,t=player.y-i.lastDropPos.y;Math.sqrt(e*e+t*t)>=i.trailInterval?(n=player.x,o=player.y,i.lastDropPos.x=n,i.lastDropPos.y=o):a=!1;break;default:n=player.x,o=player.y}a&&(t.x=n,t.y=o,DropperSystem.create(e,t))},callbackScope:e,loop:!0});return window.registerEffect("timer",o),{timer:o,config:i,setEnabled:function(e){i.enabled=e},setCooldown:function(e){o&&o.delay&&(o.delay=e,o.reset({delay:e,callback:o.callback,callbackScope:o.callbackScope,loop:o.loop}))}}},processDropEffect:function(e,t){"花"===t.entity.text&&window.createDefensiveBurst(e,t.entity.x,t.entity.y,{projectileCount:2*playerLuck,visualEffect:!0})},createDropEffectTimer:function(e,t){const i=t.options.periodicEffectCooldown??1e4;t.options.fireImmediately&&!t.hasInitiallyFired&&(t.hasInitiallyFired=!0,this.processDropEffect(e,t)),t.effectTimer=CooldownManager.createTimer({statName:"luck",baseCooldown:i,formula:"sqrt",component:t,callback:function(){gameOver||gamePaused||t.entity&&t.entity.active&&!t.destroyed&&DropperSystem.processDropEffect(e,t)},callbackScope:e,loop:!0})},setupPeriodicEffectsSystem:function(e){const t=CooldownManager.createTimer({statName:"luck",baseCooldown:1e3,formula:"divide",callback:function(){if(gameOver||gamePaused)return;DropperSystem.getAll().filter((e=>e.options&&e.options.hasPeriodicEffect)).forEach((t=>{t.destroyed||t.effectTimer||DropperSystem.createDropEffectTimer(e,t)}))},callbackScope:e,loop:!0});window.registerEffect("timer",t)},destroyDrop:function(e){e.effectTimer&&(CooldownManager.removeTimer(e.effectTimer),e.effectTimer=null),e.areaEffectTimer&&(CooldownManager.removeTimer(e.areaEffectTimer),e.areaEffectTimer=null),e.entity&&e.entity.active&&e.entity.destroy(),e.destroyed=!0}};function applyVisualEffects(e,t,i){if(i&&window.VisualEffects&&(i.needsPulsing&&VisualEffects.createPulsing(e,t),i.visualEffect))if("string"==typeof i.visualEffect){const n=i.visualEffect;"function"==typeof VisualEffects[n]&&("createPulsing"===n?VisualEffects[n](e,t):VisualEffects[n](e,t.x,t.y))}else if("object"==typeof i.visualEffect){const n=i.visualEffect.type,o=i.visualEffect.config||{};"function"==typeof VisualEffects[n]&&("createPulsing"===n?VisualEffects[n](e,t,o):VisualEffects[n](e,t.x,t.y,o))}}window.setupPeriodicEffectsSystem=DropperSystem.setupPeriodicEffectsSystem.bind(DropperSystem),window.DropperSystem=DropperSystem;let enemyCountScaleFactor=1.25,enemySpeedFactor=1,currentEnemyRank=1,currentEnemyHealth=40,bossMode=!1,activeBoss=null,bossSpawned=!1;const rankEnemyStartTimes={1:0,2:480,3:840,4:1200,5:1800,6:2160},rankSpawnDelays={1:{base:4e3,min:400},2:{base:8e3,min:800},3:{base:12e3,min:1200},4:{base:16e3,min:2e3},5:{base:2e4,min:3e3},6:{base:24e3,min:4e3}},EnemySystem={enemiesGroup:null,enemySpawners:{},scene:null,initialize:function(e){return this.scene=e,this.enemiesGroup=e.physics.add.group(),window.enemies=this.enemiesGroup,initializeEnemyTiers(),console.log("Enemy system initialized"),this},spawnEnemyOfRank:function(e){if(gameOver)return null;const t=this.scene;if(!t)return null;const i=getRandomEnemyTypeByRank(e),n=getEnemyData(i);let o,a;Math.random()<.5?(o=Math.random()<.5?-50:game.config.width+50,a=Phaser.Math.Between(50,game.config.height-50)):(o=Phaser.Math.Between(50,game.config.width-50),a=Math.random()<.5?-50:game.config.height+50);const r=t.add.text(o,a,i,{fontFamily:"Arial",fontSize:`${n.size}px`,color:n.color,fontStyle:"bold"}).setOrigin(.5);return this.enemiesGroup.add(r),r.body.setSize(r.width,r.height),r.body.setCollideWorldBounds(!1),r.body.setImmovable(!1),r.body.pushable=!0,r.body.setMass(1),r.body.setDrag(1),r.body.setBounce(.5),r.health=Math.ceil(currentEnemyHealth*n.healthMultiplier),r.speed=Phaser.Math.Between(n.speedMin,n.speedMax),r.damage=n.damage,r.rank=n.rank,r.expValue=n.expValue||1,r.kana=n.kana,r.romaji=n.romaji,r.english=n.english,r},applyDamage:function(e,t,i,n=1e3){if(!e.active||!t.active)return!1;t.lastContactDamage=t.lastContactDamage??{};const o=e.damageSourceId??(e.damageSourceId=`damage_${Date.now()}_${Math.random()}`),a=this.scene.time.now;return(!t.lastContactDamage[o]||a-t.lastContactDamage[o]>n)&&(t.health-=i,t.lastContactDamage[o]=a,this.showDamageEffect(t),t.health<=0?(this.defeatEnemy(t),!0):(t.isBoss&&this.updateBossHealthBar(t),!0))},defeatEnemy:function(e){if(e.isBoss&&this.onBossDefeated(),this.scene.learningFeedback&&e.rank===currentEnemyRank){this.scene.learningFeedback.setText(`${e.text} (${e.kana}) [${e.romaji}] - ${e.english}`),this.scene.learningFeedback.setScale(1),this.scene.tweens.add({targets:this.scene.learningFeedback,scale:{from:.95,to:1},duration:80,ease:"Sine.easeOut"})}e.destroy(),score++,heroExp+=e.expValue,GameUI.updateExpBar(this.scene)},showDamageEffect:function(e){e&&e.active&&VisualEffects.createDamageFlash(this.scene,e)},updateEnemySpawners:function(){if(!gameOver&&!gamePaused){if(!bossSpawned&&elapsedTime>=rankEnemyStartTimes[BOSS_CONFIG.max_rank]){console.log("Boss spawn condition met - spawning boss!"),bossSpawned=!0,this.spawnBoss(),currentEnemyRank=BOSS_CONFIG.max_rank;for(let e=BOSS_CONFIG.max_rank;e<=6;e++)this.enemySpawners[e]&&(console.log(`Removing spawner for rank ${e}`),this.enemySpawners[e].remove(),delete this.enemySpawners[e])}Object.keys(rankEnemyStartTimes).forEach((e=>{const t=parseInt(e);if(bossSpawned&&t>=BOSS_CONFIG.max_rank)return;const i=rankEnemyStartTimes[e],n=rankSpawnDelays[e];if(elapsedTime>=i)if(this.enemySpawners[e]){const o=(elapsedTime-i)/60,a=Math.min(12,o),r=Math.max(n.min,n.base/Math.pow(enemyCountScaleFactor,a));Math.abs(this.enemySpawners[e].delay-r)>.1*this.enemySpawners[e].delay&&(this.enemySpawners[e].delay=r,this.enemySpawners[e].reset({delay:r,callback:()=>{this.spawnEnemyOfRank(t)},callbackScope:this,loop:!0}))}else this.enemySpawners[e]=registerTimer(this.scene.time.addEvent({delay:n.base,callback:()=>{this.spawnEnemyOfRank(t)},callbackScope:this,loop:!0})),t>1&&this.showRankIntroduction(t)}))}},showRankIntroduction:function(e){currentEnemyRank=e;const t=Math.min(1.5,1+.25*(e-1));for(let e=0;e<8;e++){const e=Math.random()*Math.PI*2,i=300*Math.random()+100,n=game.config.width/2+Math.cos(e)*i,o=game.config.height/2+Math.sin(e)*i,a=3e3*Math.random(),r=this.scene.add.text(n,o,"危",{fontFamily:"Arial",fontSize:128*t+"px",color:"#ff0000",stroke:"#000000",strokeThickness:6}).setOrigin(.5);r.setAlpha(0),this.scene.tweens.add({targets:r,alpha:{from:0,to:.7},scale:{from:.8,to:1.2},duration:500,delay:a,ease:"Sine.easeInOut",onComplete:()=>{this.scene.tweens.add({targets:r,alpha:{from:.7,to:0},scale:{from:1.2,to:1.5},duration:500,ease:"Sine.easeInOut",onComplete:()=>{r.destroy()}})}})}const i=ENEMY_RANK_NAMES[e]||`${e}`;this.scene.time.delayedCall(2500,(()=>{const e=this.scene.add.text(game.config.width/2,game.config.height/2,i,{fontFamily:"Arial",fontSize:"200px",color:"#ff0000",stroke:"#000000",strokeThickness:8}).setOrigin(.5);e.setAlpha(0),this.scene.tweens.add({targets:e,alpha:{from:0,to:.9},scale:{from:.5,to:1.2},duration:800,ease:"Cubic.easeOut",onComplete:()=>{this.scene.tweens.add({targets:e,alpha:{from:.9,to:0},scale:{from:1.2,to:1.5},duration:700,delay:300,ease:"Cubic.easeIn",onComplete:()=>{e.destroy()}})}})}))},initializeEnemySpawners:function(){Object.values(this.enemySpawners).forEach((e=>{e&&e.remove()})),this.enemySpawners={}},updateEnemies:function(){if(gameOver||gamePaused)return;this.enemiesGroup.getChildren().forEach((e=>{if(e&&e.active&&e.body){const t=player.x,i=player.y,n=t-e.x,o=i-e.y,a=Math.sqrt(n*n+o*o),r=e.speed*enemySpeedFactor,s=8*r;if(a>1){const t=n/a*s,i=o/a*s;e.body.setAcceleration(t,i)}else e.body.setAcceleration(0,0);const l=e.body.velocity,c=l.lengthSq();if(c>r*r){const t=r/Math.sqrt(c);e.body.setVelocity(l.x*t,l.y*t)}}}))},countEnemiesByRank:function(e){return this.enemiesGroup.getChildren().filter((t=>t&&t.active&&t.rank===e)).length},getEnemyCount:function(){return this.enemiesGroup.getChildren().filter((e=>e&&e.active)).length},spawnBoss:function(){const e=this.scene;if(!e)return null;const t=getRandomEnemyTypeByRank(BOSS_CONFIG.max_rank),i=getEnemyData(t),n=game.config.width/2,o=e.add.text(n,-250,t,{fontFamily:"Arial",fontSize:`${i.size}px`,color:i.color,fontStyle:"bold"}).setOrigin(.5);return this.enemiesGroup.add(o),o.body.setSize(o.width,o.height),o.body.setCollideWorldBounds(!1),o.body.setImmovable(!1),o.body.pushable=!0,o.body.setMass(4),o.body.setDrag(1),o.body.setBounce(.5),o.health=Math.ceil(currentEnemyHealth*i.healthMultiplier*BOSS_CONFIG.health_multiplier),o.maxHealth=o.health,o.speed=BOSS_CONFIG.speed,o.damage=i.damage,o.rank=i.rank,o.expValue=i.expValue,o.kana=i.kana,o.romaji=i.romaji,o.english=i.english,o.isBoss=!0,activeBoss=o,window.BackgroundAnimationSystem&&BackgroundAnimationSystem.setBossMode(!0),MusicSystem.applyBossFightEffect(),this.showBossUI(o),o},showBossUI:function(e){const t=this.scene;t&&(t.learningFeedback&&!t.originalFeedbackText&&(t.originalFeedbackText=t.learningFeedback.text),t.learningFeedback&&t.learningFeedback.setText(`${e.text} (${e.kana}) [${e.romaji}] - ${e.english}`),this.createBossHealthBar(t),this.updateBossHealthBar(e))},createBossHealthBar:function(e){e.bossHealthBar&&e.bossHealthBar.destroy(),e.bossHealthBarBg&&e.bossHealthBarBg.destroy(),e.bossHealthBarBorder&&e.bossHealthBarBorder.destroy();const t="undefined"!=typeof KAJISULI_MODE&&KAJISULI_MODE?1.5:1,i=UI.healthBar.width()*t,n=UI.healthBar.height(),o=UI.healthBar.borderWidth,a=UI.healthBar.innerMargin,r=UI.healthBar.centerX(),s=.9125*game.config.height;e.bossHealthBarBorder=e.add.rectangle(r,s,i+2*o,n+2*o,UI.colors.gold).setDepth(100),e.bossHealthBarBg=e.add.rectangle(r,s,i,n,UI.colors.black).setDepth(100);const l=r-i/2+a;e.bossHealthBar=e.add.rectangle(l,s,i-2*a,n-2*a,16711680).setOrigin(0,.5).setDepth(101)},updateBossHealthBar:function(e){const t=this.scene;if(!t||!t.bossHealthBar||!e)return;const i=e.health/e.maxHealth,n="undefined"!=typeof KAJISULI_MODE&&KAJISULI_MODE?1.5:1,o=UI.healthBar.width()*n-2*UI.healthBar.innerMargin;t.bossHealthBar.width=o*i},onBossDefeated:function(){const e=this.scene;e&&(window.BackgroundAnimationSystem&&BackgroundAnimationSystem.setBossMode(!1),MusicSystem.removeBossFightEffect(),this.showVictoryScreen(),this.cleanupBossUI(e),bossMode=!1,activeBoss=null)},cleanupBossUI:function(e){e.bossHealthBar&&(e.bossHealthBar.destroy(),e.bossHealthBar=null),e.bossHealthBarBg&&(e.bossHealthBarBg.destroy(),e.bossHealthBarBg=null),e.bossHealthBarBorder&&(e.bossHealthBarBorder.destroy(),e.bossHealthBarBorder=null),e.learningFeedback&&e.originalFeedbackText&&(e.learningFeedback.setText(e.originalFeedbackText),e.originalFeedbackText=null)},showVictoryScreen:function(){const e=this.scene;e&&(gameOver=!0,PauseSystem.pauseGame(),window.GameEndMenu.showVictoryScreen(e),"undefined"!=typeof gameOverText&&gameOverText.setVisible&&gameOverText.setVisible(!1),"undefined"!=typeof restartButton&&restartButton.setVisible&&restartButton.setVisible(!1))},reset:function(){this.enemiesGroup&&this.enemiesGroup.clear(!0,!0),Object.values(this.enemySpawners).forEach((e=>{e&&e.remove()})),this.enemySpawners={},bossMode=!1,activeBoss=null,bossSpawned=!1,window.BackgroundAnimationSystem&&BackgroundAnimationSystem.setBossMode(!1);const e=this.scene;e&&this.cleanupBossUI(e),currentEnemyRank=1,initializeEnemyTiers(),console.log("Enemy system reset")}};window.EnemySystem=EnemySystem,window.enemyCountScaleFactor=enemyCountScaleFactor,window.enemySpeedFactor=enemySpeedFactor,window.currentEnemyRank=currentEnemyRank,window.currentEnemyHealth=currentEnemyHealth,window.rankEnemyStartTimes=rankEnemyStartTimes,window.rankSpawnDelays=rankSpawnDelays,window.bossMode=bossMode,window.activeBoss=activeBoss,window.bossSpawned=bossSpawned,window.BOSS_CONFIG=BOSS_CONFIG,EnemySystem.setEnemyCountScaleFactor=function(e){enemyCountScaleFactor=e,window.enemyCountScaleFactor=e},EnemySystem.setEnemySpeedFactor=function(e){enemySpeedFactor=e,window.enemySpeedFactor=e},EnemySystem.setCurrentEnemyHealth=function(e){currentEnemyHealth=e,window.currentEnemyHealth=e},window.applyContactDamage=function(e,t,i,n=1e3){return EnemySystem.scene||(EnemySystem.scene=this),EnemySystem.applyDamage(e,t,i,n)},window.spawnEnemyOfRank=function(e){return EnemySystem.spawnEnemyOfRank(e)};const DropperPerkRegistry={perkDropperConfigs:{},registerDropperPerk:function(e,t){this.perkDropperConfigs[e]={getConfig:t.getConfig??function(){return{}},cooldown:t.cooldown??4e3,positionMode:t.positionMode??"player",activationMethod:t.activationMethod??"periodic"}},applyDropperPerk:function(e,t){const i=this.perkDropperConfigs[t];if(!i)return!1;switch(console.log(`Applying dropper perk: ${t}`),i.activationMethod){case"immediate":const t=i.getConfig();t.x=player.x,t.y=player.y,DropperSystem.create(e,t);break;case"periodic":return DropperSystem.setupPeriodicDrops(e,{getConfig:i.getConfig,cooldown:i.cooldown,positionMode:i.positionMode});default:return console.log(`Unknown activation method: ${i.activationMethod}`),!1}return!0}};DropperPerkRegistry.registerDropperPerk("AMBER_BEETLE",{getConfig:function(){const e=2*playerDamage;return{symbol:"★",color:"#ffbf00",fontSize:getEffectiveSize(projectileSizeFactor,e),behaviorType:"projectile",damage:e,lifespan:null,options:{visualEffect:"createPulsing"}}},cooldown:function(){return 4e3/Math.sqrt(playerFireRate/BASE_STATS.AGI)},positionMode:"player",activationMethod:"periodic"}),window.activateLandmines=function(){const e=game.scene.scenes[0];e&&DropperPerkRegistry.applyDropperPerk(e,"AMBER_BEETLE")},DropperPerkRegistry.registerDropperPerk("MAGMA_FLOOR",{getConfig:function(){return{symbol:"熔",color:"#FF4400",fontSize:64,behaviorType:"persistent",damage:playerDamage,damageInterval:1e3,lifespan:1e3*playerLuck,options:{visualEffect:"createPulsing",opacity:.8}}},cooldown:function(){return 8e3/Math.sqrt(playerLuck/BASE_STATS.LUK)},positionMode:"player",activationMethod:"periodic"}),window.activateMagmaFloor=function(){const e=game.scene.scenes[0];if(!e)return;const t=DropperPerkRegistry.perkDropperConfigs.MAGMA_FLOOR.getConfig();return t.x=player.x,t.y=player.y,DropperSystem.create(e,t),DropperPerkRegistry.applyDropperPerk(e,"MAGMA_FLOOR")},DropperPerkRegistry.registerDropperPerk("GREEN_DREAM",{getConfig:function(){return{symbol:HERO_CHARACTER,color:"#00cc66",fontSize:32,initialScale:1,behaviorType:"persistent",damage:playerDamage,damageInterval:500,lifespan:1e3*playerLuck,options:{opacity:.5}}},cooldown:2e3,positionMode:"player",activationMethod:"periodic"}),window.activateAfterImages=function(){const e=game.scene.scenes[0];e&&DropperPerkRegistry.applyDropperPerk(e,"GREEN_DREAM")},DropperPerkRegistry.registerDropperPerk("BLOOMING_FLOWER",{getConfig:function(){return{symbol:"花",color:"#FF66AA",fontSize:24,behaviorType:"projectile",damage:playerDamage,lifespan:null,options:{hasPeriodicEffect:!0,periodicEffectCooldown:6e3,fireImmediately:!0,visualEffect:"createPulsing"}}},cooldown:function(){return 31e3/Math.sqrt(playerLuck/BASE_STATS.LUK)},positionMode:"random",activationMethod:"periodic"}),window.activateBloomingFlower=function(){const e=game.scene.scenes[0];if(!e)return;setupPeriodicEffectsSystem(e);const t=DropperPerkRegistry.perkDropperConfigs.BLOOMING_FLOWER.getConfig();t.x=Phaser.Math.Between(0,game.config.width),t.y=Phaser.Math.Between(0,game.config.height),DropperSystem.create(e,t);return DropperPerkRegistry.applyDropperPerk(e,"BLOOMING_FLOWER")},DropperPerkRegistry.registerDropperPerk("AREA_PULSE",{getConfig:function(){return{symbol:"◯",color:"#ff00ff",fontSize:24,behaviorType:"areaEffect",damage:5*playerDamage,damageInterval:0,lifespan:null,options:{areaEffectInterval:6e3,areaEffectRadius:400,pulseColor:16711935}}},cooldown:3500,positionMode:"player",activationMethod:"periodic"}),window.activateAreaPulse=function(){const e=game.scene.scenes[0];e&&DropperPerkRegistry.applyDropperPerk(e,"AREA_PULSE")},DropperPerkRegistry.registerDropperPerk("POISON_FLOWER",{getConfig:function(){return{symbol:"毒",color:"#2aad27",fontSize:28,behaviorType:"areaEffect",damage:1*playerDamage,damageInterval:0,lifespan:null,options:{areaEffectInterval:9e3,areaEffectRadius:320,pulseColor:2796839,visualEffect:"createPulsing",effectComponent:"poisonEffect"}}},cooldown:function(){return 15e3/Math.sqrt(playerLuck/BASE_STATS.LUK)},positionMode:"random",activationMethod:"periodic"}),window.activatePoisonFlower=function(){const e=game.scene.scenes[0];if(!e)return;const t=DropperPerkRegistry.perkDropperConfigs.POISON_FLOWER.getConfig();return t.x=Phaser.Math.Between(0,game.config.width),t.y=Phaser.Math.Between(0,game.config.height),DropperSystem.create(e,t),DropperPerkRegistry.applyDropperPerk(e,"POISON_FLOWER")},DropperPerkRegistry.registerDropperPerk("COLD_FLOWER",{getConfig:function(){return{symbol:"冷",color:"#00ffff",fontSize:28,behaviorType:"areaEffect",damage:playerDamage,damageInterval:0,lifespan:null,options:{areaEffectInterval:7e3,areaEffectRadius:240,pulseColor:65535,visualEffect:"createPulsing",effectComponent:"slowEffect"}}},cooldown:function(){return 2e4/Math.sqrt(playerLuck/BASE_STATS.LUK)},positionMode:"random",activationMethod:"periodic"}),window.activateColdFlower=function(){const e=game.scene.scenes[0];if(!e)return;const t=DropperPerkRegistry.perkDropperConfigs.COLD_FLOWER.getConfig();return t.x=Phaser.Math.Between(0,game.config.width),t.y=Phaser.Math.Between(0,game.config.height),DropperSystem.create(e,t),DropperPerkRegistry.applyDropperPerk(e,"COLD_FLOWER")},DropperPerkRegistry.registerDropperPerk("FROST_SHRAPNEL",{getConfig:function(){return{symbol:"氷",color:"#00FFFF",fontSize:16,behaviorType:"projectile",damage:.2*playerDamage,damageInterval:1e3,lifespan:null,options:{effectComponent:"slowEffect"}}},cooldown:function(){return 4e3/Math.sqrt(playerFireRate/BASE_STATS.AGI)},positionMode:"player",activationMethod:"periodic"}),window.activateFrostShrapnel=function(){const e=game.scene.scenes[0];if(!e)return;const t=DropperPerkRegistry.perkDropperConfigs.FROST_SHRAPNEL.getConfig();return t.x=player.x,t.y=player.y,DropperSystem.create(e,t),DropperPerkRegistry.applyDropperPerk(e,"FROST_SHRAPNEL")},DropperPerkRegistry.registerDropperPerk("TOXIC_TRAIL",{getConfig:function(){return{symbol:"毒",color:"#33cc33",fontSize:16,behaviorType:"projectile",damage:.5*playerDamage,lifespan:Math.ceil(4e3*Math.sqrt(playerLuck/BASE_STATS.LUK)),options:{effectComponent:"poisonEffect",visualEffect:"createPulsing"}}},cooldown:200,positionMode:"trail",trailInterval:32,activationMethod:"periodic"}),window.activateToxicTrail=function(){const e=game.scene.scenes[0];if(!e)return;const t=DropperPerkRegistry.perkDropperConfigs.TOXIC_TRAIL.getConfig();return t.x=player.x,t.y=player.y,DropperSystem.create(e,t),DropperPerkRegistry.applyDropperPerk(e,"TOXIC_TRAIL")},window.DropperPerkRegistry=DropperPerkRegistry;const FamiliarBehaviors={sniper:function(e,t,i){const n=2*playerDamage,o=findRandomVisibleEnemy(e);return!!o&&(fireFamiliarProjectile(e,t,o,{damage:n,speed:800,color:"#FF55AA"}),!0)},copy:function(e,t,i){const n=.5*playerDamage,o=findClosestVisibleEnemy(e);return!!o&&(fireFamiliarProjectile(e,t,o,{damage:n}),!0)},cold:function(e,t,i){const n=.5*playerDamage,o=findClosestVisibleEnemy(e);if(o){const i=fireFamiliarProjectile(e,t,o,{damage:n,color:"#00FFFF"});return i&&ProjectileComponentSystem.addComponent(i,"slowEffect"),!0}return!1},fun:function(e,t,i){const n=.5*playerDamage,o=[{component:"slowEffect",color:"#00FFFF"},{component:"poisonEffect",color:"#2AAD27"},{component:"fireEffect",color:"#FF4500"},{component:"explosionEffect",color:"#FF9500"},{component:"splitEffect",color:"#1E90FF"}],a=o[Math.floor(Math.random()*o.length)],r=findRandomVisibleEnemy(e);if(r){const i=fireFamiliarProjectile(e,t,r,{damage:n,color:a.color,symbol:a.symbol});return i&&ProjectileComponentSystem.addComponent(i,a.component),!0}return!1},berserk:function(e,t,i){const n=.5*playerDamage,o=findRandomVisibleEnemy(e);return!!o&&(fireFamiliarProjectile(e,t,o,{damage:n}),!0)},healer:function(e,t,i){const n=.5*playerDamage,o=findClosestVisibleEnemy(e);if(o){const i=fireFamiliarProjectile(e,t,o,{damage:n,color:"#00ff00",symbol:"癒"});return i&&ProjectileComponentSystem.addComponent(i,"healingAuraEffect"),!0}return!1},finger:function(e,t,i,n={}){const o={...{damage:playerDamage,speed:1e3,color:"#FFFF00",symbol:"　",componentName:null},...n},a=t.angle,r=fireFamiliarProjectile(e,t,null,{damage:o.damage,color:o.color,symbol:o.symbol,speed:o.speed,overrideAngle:a});return r&&ProjectileComponentSystem.addComponent(r,"piercingEffect"),r&&o.componentName&&ProjectileComponentSystem.componentTypes[o.componentName]&&ProjectileComponentSystem.addComponent(r,o.componentName),!0},deathFinger:function(e,t,i){return FamiliarBehaviors.finger(e,t,i,{damage:playerDamage/2,speed:1e3,color:"#FFFF00",symbol:"　",componentName:null})},decayFinger:function(e,t,i){return FamiliarBehaviors.finger(e,t,i,{damage:.2*playerDamage,speed:1e3,color:"#FFFF00",symbol:"　",componentName:"poisonEffect"})}};function findRandomVisibleEnemy(e,t=400){const i=EnemySystem.enemiesGroup.getChildren().filter((e=>{if(!e||!e.active)return!1;if(t!==1/0){const i=player.x-e.x,n=player.y-e.y;return Math.sqrt(i*i+n*n)<=t}return!0}));return 0===i.length?null:Phaser.Utils.Array.GetRandom(i)}function findClosestVisibleEnemy(e,t=400){const i=EnemySystem.enemiesGroup.getChildren().filter((e=>e&&e.active));if(0===i.length)return null;let n=null,o=t;return i.forEach((e=>{const t=player.x-e.x,i=player.y-e.y,a=Math.sqrt(t*t+i*i);a<o&&(o=a,n=e)})),n}function fireFamiliarProjectile(e,t,i,n={}){const o={damage:.5*playerDamage,speed:400,color:"#ffff00",symbol:"★",...n},a=i?Phaser.Math.Angle.Between(t.entity.x,t.entity.y,i.x,i.y):o.overrideAngle??0,r=getEffectiveSize(projectileSizeFactor,o.damage),s=WeaponSystem.createProjectile(e,{x:t.entity.x,y:t.entity.y,angle:a,symbol:o.symbol,color:o.color,speed:o.speed,damage:o.damage,fontSize:r,skipComponents:!0});return e.tweens.add({targets:s,alpha:{from:.7,to:1},scale:{from:.7,to:1},duration:200}),s}function setupFamiliarFiringTimer(e,t,i,n=4e3){if(!t||!t.entity||!t.entity.active)return null;const o=FamiliarBehaviors[i];if(!o)return console.warn(`Unknown familiar behavior type: ${i}`),null;t.baseCooldown=n,t.behaviorType=i;return CooldownManager.createTimer({statName:"luck",baseCooldown:n,formula:"sqrt",component:t,callback:function(){if(gameOver||gamePaused||!t||t.destroyed||!t.entity||!t.entity.active)return;let i=400*Math.sqrt(playerFireRate/BASE_STATS.AGI);if(i*=t.options?.rangeModifier??1,t.options?.useRangeVariation){i*=1+.2*Math.sin(.001*e.time.now)}o(e,t,e.time.now,i)},callbackScope:e,loop:!0})}function setupFairyColorChanger(e,t){if(!t||!t.entity||!e)return;const i=["#FF55FF","#55FFFF","#FFFF55","#55FF55","#FF5555","#5555FF"];let n=0;const o=e.time.addEvent({delay:2e3,callback:function(){t.entity&&t.entity.active?(n=(n+1)%i.length,e.tweens.add({targets:t.entity,duration:500,onUpdate:function(){t.entity.setColor(i[n])}})):o.remove()},callbackScope:e,loop:!0});return window.registerEffect("timer",o),t.colorTimer=o,o}window.FamiliarSystem={behaviors:FamiliarBehaviors,findRandomVisibleEnemy:findRandomVisibleEnemy,findClosestVisibleEnemy:findClosestVisibleEnemy,fireFamiliarProjectile:fireFamiliarProjectile,setupFamiliarFiringTimer:setupFamiliarFiringTimer,setupFairyColorChanger:setupFairyColorChanger};const HERO_CHARACTER="勇",HERO_KANA="ゆう",HERO_ROMAJI="yuu",HERO_ENGLISH="Brave",BASE_STATS={POW:4,AGI:4,LUK:4,END:4},shieldBaseCd=8e4,godHammerBaseCd=12e4,divineBeaconBaseCd=12e4,fatedShieldBaseCd=6e4,angelHoneyBaseCd=18e4,PlayerComponentSystem={componentTypes:{},activeComponents:{},registerComponent:function(e,t){this.componentTypes[e]=t},addComponent:function(e,t={}){if(this.activeComponents[e]||!this.componentTypes[e])return!1;const i={...this.componentTypes[e]};return Object.assign(i,t),this.activeComponents[e]=i,i.initialize&&i.initialize(player),!0},removeComponent:function(e){const t=this.activeComponents[e];if(!t)return!1;console.log(`Removing component: ${e}`),t.cleanup&&t.cleanup(player);for(const i in t){const n=t[i];!n||"object"!=typeof n||void 0===n.delay&&void 0===n.paused&&void 0===n.elapsed||(console.log(`Found potential timer in ${e}.${i}`),window.CooldownManager&&window.CooldownManager.removeTimer&&window.CooldownManager.removeTimer(n),n.remove&&n.remove(),t[i]=null)}return delete this.activeComponents[e],!0},processEvent:function(e,...t){Object.values(this.activeComponents).forEach((i=>{i[e]&&i[e](player,...t)}))},hasComponent:function(e){return!!this.activeComponents[e]},getComponent:function(e){return this.activeComponents[e]},resetAll:function(){console.log("Resetting all player components...");Object.keys(this.activeComponents).forEach((e=>{this.removeComponent(e)})),this.activeComponents={},console.log("All player components reset complete")}};PlayerComponentSystem.registerComponent("berserkerState",{originalColor:null,damageMultiplier:1,colorTween:null,initialize:function(e){this.originalColor=e.style.color||"#ffffff";const t=game.scene.scenes[0];t&&(this.colorTween=t.tweens.add({targets:e,colorTween:{from:0,to:1},duration:1e3,yoyo:!0,repeat:-1,onUpdate:function(t,i){const n=i.colorTween,o=Math.floor(255),a=Math.floor(255*(1-n)),r=Math.floor(255*(1-n));e.setColor(`rgb(${o},${a},${r})`)}})),berserkMultiplier+=this.damageMultiplier,console.log("BERSERK!"),GameUI.updateStatCircles(t)},update:function(e){playerHealth/maxPlayerHealth>.25&&PlayerComponentSystem.removeComponent("berserkerState")},cleanup:function(e){berserkMultiplier-=this.damageMultiplier,berserkMultiplier<1&&(berserkMultiplier=1),this.colorTween&&(this.colorTween.stop(),this.colorTween=null),e.setColor(this.originalColor||"#ffffff");const t=game.scene.scenes[0];t&&GameUI.updateStatCircles(t)}});const PlayerPerkRegistry={perkEffects:{},registerPerkEffect:function(e,t){this.perkEffects[e]={componentName:t.componentName||null,configGenerator:t.configGenerator||null,condition:t.condition||null}},checkAndApplyEffects:function(){Object.entries(this.perkEffects).forEach((([e,t])=>{if(hasPerk(e)){let e=!0;if(t.condition&&(e=t.condition()),e){if(!PlayerComponentSystem.hasComponent(t.componentName)){let e={};t.configGenerator&&(e=t.configGenerator()),PlayerComponentSystem.addComponent(t.componentName,e)}}else PlayerComponentSystem.hasComponent(t.componentName)&&PlayerComponentSystem.removeComponent(t.componentName)}}))}};PlayerPerkRegistry.registerPerkEffect("CRIMSON_FURY",{componentName:"berserkerState",condition:function(){return playerHealth/maxPlayerHealth<=.25}}),PlayerComponentSystem.registerComponent("eternalRhythmState",{maxMultiplier:2,currentMultiplier:1,isActive:!1,accumulator:0,lastUpdateTime:0,velocityThreshold:10,particles:[],particleTimer:null,initialize:function(e){this.accumulator=0,this.currentMultiplier=1,archerMultiplier=1,this.lastUpdateTime=game.scene.scenes[0].time.now;const t=game.scene.scenes[0];t&&(this.particles=[],this.particleTimer&&this.particleTimer.remove(),this.particleTimer=t.time.addEvent({delay:this.currentMultiplier-1,callback:this.createParticle,callbackScope:this,loop:!0,paused:!0}),window.registerEffect("timer",this.particleTimer))},createParticle:function(){const e=game.scene.scenes[0];if(!e||!player||!player.active)return;const t=Math.random()*Math.PI*2,i=20+10*Math.random(),n=player.x+Math.cos(t)*i,o=player.y+Math.sin(t)*i,a=e.add.text(n,o,"✦",{fontFamily:"Arial",fontSize:"12px",color:"#FFDD00"}).setOrigin(.5);this.particles.push(a),e.tweens.add({targets:a,alpha:{from:.7,to:0},scale:{from:.5,to:1.5},x:a.x+30*(Math.random()-.5),y:a.y+30*(Math.random()-.5),duration:500,onComplete:()=>{const e=this.particles.indexOf(a);-1!==e&&this.particles.splice(e,1),a.destroy()}})},update:function(e){const t=game.scene.scenes[0],i=t.time.now,n=(i-this.lastUpdateTime)/1e3;if(this.lastUpdateTime=i,n>.5)return;const o=e.body.velocity,a=Math.sqrt(o.x*o.x+o.y*o.y)>this.velocityThreshold;this.accumulator>0&&this.currentMultiplier;if(a){const e=n/(60/playerLuck);this.accumulator=Math.min(1,this.accumulator+e);const i=1+this.accumulator*(this.maxMultiplier-1);if(Math.abs(this.currentMultiplier-i)>.01&&(this.currentMultiplier=i,archerMultiplier=this.currentMultiplier,this.updateProjectileFiringRate(t),this.particleTimer)){const e=Math.max(50,150-100*(this.currentMultiplier-1));Math.abs(this.particleTimer.delay-e)>10&&(this.particleTimer.delay=e,this.particleTimer.reset({delay:e,callback:this.createParticle,callbackScope:this,loop:!0})),this.particleTimer.paused&&(this.particleTimer.paused=!1)}if(!this.isActive&&this.accumulator>=.99){this.isActive=!0;for(let e=0;e<15;e++)this.createParticle()}}else(this.accumulator>0||this.currentMultiplier>1)&&(this.accumulator=0,this.currentMultiplier=1,archerMultiplier=1,this.isActive=!1,this.particleTimer&&!this.particleTimer.paused&&(this.particleTimer.paused=!0),this.updateProjectileFiringRate(t))},updateProjectileFiringRate:function(e){if(!e||!WeaponSystem)return;playerFireRate,archerMultiplier;WeaponSystem.updateFiringRate(e),GameUI.updateStatCircles(e)},cleanup:function(e){archerMultiplier=1,this.particleTimer&&(this.particleTimer.remove(),this.particleTimer=null),this.particles.forEach((e=>{e&&e.active&&e.destroy()})),this.particles=[]}}),PlayerPerkRegistry.registerPerkEffect("ETERNAL_RHYTHM",{componentName:"eternalRhythmState",condition:function(){return!0}});const ShieldSystem={isShieldActive:!1,activateShield:function(e={}){if(this.isShieldActive=!0,shieldVisual){shieldVisual.setVisible(!0);const t=game.scene.scenes[0];t&&t.tweens.add({targets:shieldVisual,scale:{from:e.startScale??.5,to:e.endScale??1},alpha:{from:e.startAlpha??.8,to:e.endAlpha??.4},duration:e.animDuration??500,ease:e.easeFunction??"Cubic.out"})}return!0},deactivateShield:function(){this.isShieldActive=!1,shieldVisual&&shieldVisual.setVisible(!1)},onShieldHit:function(){if(this.deactivateShield(),PlayerComponentSystem.hasComponent("permanentShieldAbility")){PlayerComponentSystem.getComponent("permanentShieldAbility").startCooldown()}},isActive:function(){return this.isShieldActive}};function dropGodHammer(){if(!EnemySystem.enemiesGroup||0===EnemySystem.enemiesGroup.getChildren().length)return;const e=EnemySystem.enemiesGroup.getChildren().filter((e=>e.active&&e.x>=0&&e.x<=game.config.width&&e.y>=0&&e.y<=game.config.height));if(0===e.length)return;const t=Phaser.Utils.Array.GetRandom(e),i=t.x,n=t.y-300,o=this.add.text(i,n,"鎚",{fontFamily:"Arial",fontSize:"96px",color:"#FFD700",stroke:"#000000",strokeThickness:4}).setOrigin(.5);this.physics.world.enable(o),o.body.setSize(1*o.width,1*o.height),o.damage=10*playerDamage,o.damageSourceId="godHammer",window.registerEffect("entity",o),this.physics.add.overlap(o,EnemySystem.enemiesGroup,(function(e,t){applyContactDamage.call(this,e,t,e.damage)}),null,this),this.tweens.add({targets:o,y:t.y,duration:500,ease:"Bounce.easeOut",onComplete:function(){this.parent.scene.tweens.add({targets:o,alpha:0,duration:500,delay:500,onComplete:function(){o.destroy()}})}})}function createLightningStrike(e,t,i,n={}){if(gameOver||gamePaused)return;const o=n.damage??4*playerDamage,a=n.color??"#FFDD00",r=n.size??32,s=n.symbol??"雷",l=n.segmentCount??8,c=[],d=e.add.text(t,i,s,{fontFamily:"Arial",fontSize:`${r}px`,color:a,fontStyle:"bold"}).setOrigin(.5);window.registerEffect("entity",d),c.push(d);for(let n=1;n<l;n++){const o=.8-.1*n,l=e.add.text(t,i-n*r,s,{fontFamily:"Arial",fontSize:`${r}px`,color:a,fontStyle:"bold"}).setOrigin(.5).setAlpha(o);window.registerEffect("entity",l),c.push(l)}VisualEffects.createLightningFlash(e,t,i,{radius:48,color:16777062,alpha:.7,duration:1e3});const m=e.physics.overlapCirc(t,i,64,!0,!0),u=`lightning_${Date.now()}_${Math.random()}`;return m.forEach((t=>{t.gameObject&&t.gameObject.active&&applyContactDamage.call(e,{damageSourceId:u,damage:o,active:!0},t.gameObject,o,0)})),e.tweens.add({targets:c,alpha:0,duration:1e3,onComplete:function(){c.forEach((e=>e.destroy()))}}),c}function updatePlayerStatus(){gameOver||gamePaused||(PlayerPerkRegistry.checkAndApplyEffects(),PlayerComponentSystem.processEvent("update"),CooldownManager.update())}function resetPlayerStatus(){PlayerComponentSystem.resetAll(),berserkMultiplier=1}PlayerComponentSystem.registerComponent("secondChanceShieldAbility",{cooldownTimer:null,readyForUse:!0,initialize:function(e){this.readyForUse=!0},update:function(e){this.readyForUse&&1===playerHealth&&this.activateEmergencyShield()},activateEmergencyShield:function(){this.readyForUse=!1,ShieldSystem.activateShield();game.scene.scenes[0]&&(this.cooldownTimer&&CooldownManager.removeTimer(this.cooldownTimer),this.cooldownTimer=CooldownManager.createTimer({statName:"luck",baseCooldown:6e4,formula:"divide",component:this,callback:this.resetAbility,callbackScope:this,loop:!1}))},resetAbility:function(){this.readyForUse=!0},cleanup:function(){this.cooldownTimer&&(CooldownManager.removeTimer(this.cooldownTimer),this.cooldownTimer.remove&&this.cooldownTimer.remove(),this.cooldownTimer=null),ShieldSystem.deactivateShield()}}),PlayerPerkRegistry.registerPerkEffect("FATED_SHIELD",{componentName:"secondChanceShieldAbility",condition:function(){return!0}}),PlayerComponentSystem.registerComponent("permanentShieldAbility",{cooldownTimer:null,initialize:function(e){ShieldSystem.activateShield()},startCooldown:function(){this.cooldownTimer&&CooldownManager.removeTimer(this.cooldownTimer);game.scene.scenes[0]&&(this.cooldownTimer=CooldownManager.createTimer({statName:"luck",baseCooldown:8e4,formula:"divide",component:this,callback:this.reactivateShield,callbackScope:this,loop:!1}))},reactivateShield:function(){ShieldSystem.activateShield()},cleanup:function(){this.cooldownTimer&&(CooldownManager.removeTimer(this.cooldownTimer),this.cooldownTimer.remove&&this.cooldownTimer.remove(),this.cooldownTimer=null),ShieldSystem.deactivateShield()}}),PlayerPerkRegistry.registerPerkEffect("BLUE_WHALE",{componentName:"permanentShieldAbility",condition:function(){return!0}}),PlayerComponentSystem.registerComponent("temporaryShieldAbility",{initialize:function(e){ShieldSystem.activateShield({startScale:.2,endScale:1.2,startAlpha:1,endAlpha:.3,animDuration:800,notificationText:"TEMPORARY SHIELD ACTIVE!",notificationColor:"#FF9900"})},cleanup:function(){}}),window.isShieldActive=function(){return ShieldSystem.isActive()},window.triggerShieldHit=function(){ShieldSystem.onShieldHit()},window.activateShield=function(e){return ShieldSystem.activateShield(e)},PlayerComponentSystem.registerComponent("godHammerAbility",{hammerTimer:null,sceneReference:null,initialize:function(e){const t=game.scene.scenes[0];t&&(this.sceneReference=t,this.hammerTimer=CooldownManager.createTimer({statName:"luck",baseCooldown:12e4,formula:"divide",component:this,callback:this.dropHammer,callbackScope:this,loop:!0}),this.dropHammer())},dropHammer:function(){const e=this.sceneReference??game.scene.scenes[0];!e||gameOver||gamePaused||dropGodHammer.call(e)},cleanup:function(e){this.hammerTimer&&(CooldownManager.removeTimer(this.hammerTimer),this.hammerTimer.remove&&this.hammerTimer.remove(),this.hammerTimer.countdown&&this.hammerTimer.countdown.remove(!1),this.hammerTimer=null),this.sceneReference=null}}),PlayerPerkRegistry.registerPerkEffect("GOD_HAMMER",{componentName:"godHammerAbility",condition:function(){return!0}}),window.activateGodHammer=function(){PlayerComponentSystem.addComponent("godHammerAbility")},PlayerComponentSystem.registerComponent("divineBeaconAbility",{beaconTimer:null,initialize:function(e){const t=game.scene.scenes[0];t&&(this.beaconTimer=CooldownManager.createTimer({statName:"luck",baseCooldown:12e4,formula:"divide",component:this,callback:this.spawnBeacon,callbackScope:t}),this.spawnBeacon.call(t))},spawnBeacon:function(){if(gameOver||gamePaused)return;const e=Phaser.Math.Between(.017*game.config.width,.983*game.config.width),t=Phaser.Math.Between(.025*game.config.height,.975*game.config.height),i=this.add.text(e,t,"天",{fontFamily:"Arial",fontSize:"16px",color:"#FFD700",stroke:"#FFFFFF",strokeThickness:4,shadow:{offsetX:0,offsetY:0,color:"#FFFFFF",blur:10,stroke:!0,fill:!0}}).setOrigin(.5);this.physics.world.enable(i),i.body.setSize(.8*i.width,.8*i.height),i.body.immovable=!0,i.beaconId="beacon_"+Date.now()+"_"+Math.random(),window.registerEffect("entity",i),this.physics.add.overlap(i,player,(function(e,t){if(e.collected)return;e.collected=!0,dropGodHammer.call(this),this.tweens.add({targets:e,alpha:0,scale:2,duration:500,onComplete:function(){e.destroy()}});const i=this.add.circle(e.x,e.y,5,16777215,1);this.tweens.add({targets:i,radius:100,alpha:0,duration:500,onComplete:function(){i.destroy()}})}),null,this),VisualEffects.createPulsing(this,i)},cleanup:function(e){CooldownManager.removeTimer(this.beaconTimer),this.beaconTimer&&this.beaconTimer.remove&&this.beaconTimer.remove(),this.beaconTimer=null}}),PlayerPerkRegistry.registerPerkEffect("DIVINE_BEACON",{componentName:"divineBeaconAbility",condition:function(){return!0}}),PlayerComponentSystem.registerComponent("angelHoneyAbility",{honeyTimer:null,initialize:function(e){const t=game.scene.scenes[0];t&&(this.honeyTimer=CooldownManager.createTimer({statName:"luck",baseCooldown:18e4,formula:"divide",component:this,callback:this.spawnHoney,callbackScope:t}),this.spawnHoney.call(t))},spawnHoney:function(){if(gameOver||gamePaused)return;const e=Phaser.Math.Between(.017*game.config.width,.983*game.config.width),t=Phaser.Math.Between(.025*game.config.height,.975*game.config.height),i=this.add.text(e,t,"蜜",{fontFamily:"Arial",fontSize:"20px",color:"#00CC00",stroke:"#FFFFFF",strokeThickness:4,shadow:{offsetX:0,offsetY:0,color:"#FFFFFF",blur:10,stroke:!0,fill:!0}}).setOrigin(.5);this.physics.world.enable(i),i.body.setSize(.8*i.width,.8*i.height),i.body.immovable=!0,i.honeyId="honey_"+Date.now()+"_"+Math.random(),window.registerEffect("entity",i),this.physics.add.overlap(i,player,(function(e,t){if(e.collected)return;e.collected=!0,window.fullHeal(),this.tweens.add({targets:e,alpha:0,scale:2,duration:500,onComplete:function(){e.destroy()}});const i=this.add.circle(e.x,e.y,5,65280,1);this.tweens.add({targets:i,radius:100,alpha:0,duration:500,onComplete:function(){i.destroy()}})}),null,this),VisualEffects.createPulsing(this,i)},cleanup:function(e){CooldownManager.removeTimer(this.honeyTimer),this.honeyTimer&&this.honeyTimer.remove&&this.honeyTimer.remove(),this.honeyTimer=null}}),PlayerPerkRegistry.registerPerkEffect("ANGEL_HONEY",{componentName:"angelHoneyAbility",condition:function(){return!0}}),PlayerComponentSystem.registerComponent("alienClockAbility",{clockTimer:null,beaconCooldown:12e4,initialize:function(e){const t=game.scene.scenes[0];t&&(this.clockTimer=CooldownManager.createTimer({statName:"luck",baseCooldown:this.beaconCooldown,formula:"divide",component:this,callback:this.spawnClockBeacon,callbackScope:t}),this.spawnClockBeacon.call(t))},spawnClockBeacon:function(){if(gameOver||gamePaused)return;const e=Phaser.Math.Between(.08*game.config.width,.92*game.config.width),t=Phaser.Math.Between(.125*game.config.height,.875*game.config.height),i=this.add.text(e,t,"時",{fontFamily:"Arial",fontSize:"20px",color:"#00FFFF",stroke:"#000000",strokeThickness:3,shadow:{offsetX:0,offsetY:0,color:"#00FFFF",blur:8,stroke:!0,fill:!0}}).setOrigin(.5);this.physics.world.enable(i),i.body.setSize(.8*i.width,.8*i.height),i.body.immovable=!0,i.beaconId="timeBeacon_"+Date.now()+"_"+Math.random(),window.registerEffect("entity",i),this.physics.add.overlap(i,player,(function(e,t){if(e.collected)return;e.collected=!0;const i=1e3*Math.sqrt(playerLuck/BASE_STATS.LUK);window.activateTimeDilation(i),this.tweens.add({targets:e,alpha:0,scale:2,duration:500,onComplete:function(){e.destroy()}});const n=this.add.circle(e.x,e.y,5,65535,1);this.tweens.add({targets:n,radius:100,alpha:0,duration:800,onComplete:function(){n.destroy()}})}),null,this),VisualEffects.createPulsing(this,i)},cleanup:function(e){CooldownManager.removeTimer(this.clockTimer),this.clockTimer&&this.clockTimer.remove&&this.clockTimer.remove(),this.clockTimer=null}}),PlayerPerkRegistry.registerPerkEffect("ALIEN_CLOCK",{componentName:"alienClockAbility",condition:function(){return!0}}),window.activateAlienClock=function(){PlayerComponentSystem.addComponent("alienClockAbility")},PlayerComponentSystem.registerComponent("stormCallerAbility",{stormTimer:null,initialize:function(){const e=game.scene.scenes[0];if(!e)return;this.stormTimer=CooldownManager.createTimer({statName:"luck",baseCooldown:2e3,formula:"sqrt",component:this,callback:function(){if(gameOver||gamePaused)return;const t=Phaser.Math.Between(.083*game.config.width,.917*game.config.width),i=Phaser.Math.Between(.125*game.config.height,.875*game.config.height);createLightningStrike(e,t,i)},callbackScope:e,loop:!0});const t=Phaser.Math.Between(.083*game.config.width,.917*game.config.width),i=Phaser.Math.Between(.125*game.config.height,.875*game.config.height);createLightningStrike(e,t,i)},cleanup:function(){this.stormTimer&&(CooldownManager.removeTimer(this.stormTimer),this.stormTimer=null)}}),PlayerPerkRegistry.registerPerkEffect("STORM_CALLER",{componentName:"stormCallerAbility",condition:function(){return!0}}),window.activateStormCaller=function(){PlayerComponentSystem.addComponent("stormCallerAbility")},window.createLightningStrike=createLightningStrike,PlayerComponentSystem.registerComponent("stormBringerAbility",{beaconTimer:null,initialize:function(){const e=game.scene.scenes[0];e&&(this.beaconTimer=CooldownManager.createTimer({statName:"luck",baseCooldown:3e4,formula:"sqrt",component:this,callback:this.spawnBeacon,callbackScope:e,loop:!0}),this.spawnBeacon.call(e))},spawnBeacon:function(){if(gameOver||gamePaused)return;const e=Phaser.Math.Between(.2*game.config.width,.8*game.config.width),t=Phaser.Math.Between(.2*game.config.height,.8*game.config.height),i=this.add.text(e,t,"嵐",{fontFamily:"Arial",fontSize:"24px",color:"#00DDFF",stroke:"#FFFFFF",strokeThickness:2,shadow:{offsetX:0,offsetY:0,color:"#FFFFFF",blur:8,stroke:!0,fill:!0}}).setOrigin(.5);this.physics.world.enable(i),i.body.setSize(.8*i.width,.8*i.height),i.body.immovable=!0,i.beaconId="storm_beacon_"+Date.now()+"_"+Math.random(),window.registerEffect("entity",i),this.physics.add.overlap(i,player,(function(e,t){if(e.collected)return;e.collected=!0;const i=e.x,n=e.y;createLightningStrike(this,i,n);for(let e=1;e<8;e++){const t=Math.random()*Math.PI*2,o=360*Math.random(),a=i+Math.cos(t)*o,r=n+Math.sin(t)*o;this.time.delayedCall(300*e,(function(){gameOver||gamePaused||createLightningStrike(this,a,r)}),[],this)}this.tweens.add({targets:e,alpha:0,scale:2,duration:500,onComplete:function(){e.destroy()}});const o=this.add.circle(e.x,e.y,50,56831,.7);window.registerEffect("entity",o),this.tweens.add({targets:o,radius:200,alpha:0,duration:800,onComplete:function(){o.destroy()}})}),null,this),VisualEffects.createPulsing(this,i)},cleanup:function(){this.beaconTimer&&(CooldownManager.removeTimer(this.beaconTimer),this.beaconTimer=null)}}),PlayerPerkRegistry.registerPerkEffect("STORM_BRINGER",{componentName:"stormBringerAbility",condition:function(){return!0}}),window.activateStormBringer=function(){PlayerComponentSystem.addComponent("stormBringerAbility")};const InputSystem={lastMouseX:0,lastMouseY:0,cursorHideTimer:null,isCursorHidden:!1,cursorHideDelay:1e3,isInitialized:!1,isTabActive:!0,setupCursorHiding:function(e){this.isInitialized||(this.scene=e,e.input.on("pointermove",this.handlePointerMove,this),e.input.on("pointerdown",this.handlePointerDown,this),e.game.canvas.addEventListener("mouseout",this.handleMouseOut.bind(this)),document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this)),window.addEventListener("focus",this.handleWindowFocus.bind(this)),window.addEventListener("blur",this.handleWindowBlur.bind(this)),this.resetCursorState(),this.isInitialized=!0,console.log("Enhanced cursor hiding system initialized"))},handlePointerMove:function(e){e.x===this.lastMouseX&&e.y===this.lastMouseY||(this.lastMouseX=e.x,this.lastMouseY=e.y,this.isCursorHidden&&(document.body.style.cursor="auto",this.isCursorHidden=!1),this.resetCursorTimer())},handlePointerDown:function(){this.isCursorHidden&&(document.body.style.cursor="auto",this.isCursorHidden=!1),this.resetCursorTimer()},handleMouseOut:function(){document.body.style.cursor="auto",this.isCursorHidden=!1,this.clearCursorTimer()},handleVisibilityChange:function(){document.hidden?(this.isTabActive=!1,document.body.style.cursor="auto",this.isCursorHidden=!1,this.clearCursorTimer()):(this.isTabActive=!0,this.resetCursorState())},handleWindowFocus:function(){this.resetCursorState()},handleWindowBlur:function(){document.body.style.cursor="auto",this.isCursorHidden=!1,this.clearCursorTimer()},resetCursorTimer:function(){this.isTabActive&&(this.clearCursorTimer(),this.cursorHideTimer=this.scene.time.delayedCall(this.cursorHideDelay,(function(){this.isTabActive&&(document.body.style.cursor="none",this.isCursorHidden=!0)}),[],this))},clearCursorTimer:function(){this.cursorHideTimer&&(this.scene&&this.scene.time&&this.scene.time.removeEvent&&this.scene.time.removeEvent(this.cursorHideTimer),this.cursorHideTimer=null)},resetCursorState:function(){document.body.style.cursor="auto",this.isCursorHidden=!1,this.clearCursorTimer(),this.resetCursorTimer(),this.scene&&this.scene.time.delayedCall(100,(function(){const e=this.scene.input.activePointer;e&&(this.lastMouseX=e.x,this.lastMouseY=e.y)}),[],this)},cleanup:function(){this.isInitialized&&this.scene&&(this.scene.input.off("pointermove",this.handlePointerMove,this),this.scene.input.off("pointerdown",this.handlePointerDown,this),this.scene.game&&this.scene.game.canvas&&this.scene.game.canvas.removeEventListener("mouseout",this.handleMouseOut),document.removeEventListener("visibilitychange",this.handleVisibilityChange),window.removeEventListener("focus",this.handleWindowFocus),window.removeEventListener("blur",this.handleWindowBlur),this.clearCursorTimer(),document.body.style.cursor="auto",this.isCursorHidden=!1,this.isInitialized=!1,this.scene=null)}};window.InputSystem=InputSystem;const LifeSystem={healthRegenTimer:null,isInitialized:!1,initialize:function(e){this.isInitialized||(this.setupHealthRegeneration(e),this.isInitialized=!0,console.log("Life system initialized"))},setupHealthRegeneration:function(e){const t=Math.ceil(1e5/maxPlayerHealth);this.healthRegenTimer&&this.healthRegenTimer.remove(),this.healthRegenTimer=registerTimer(e.time.addEvent({delay:t,callback:this.regenerateHealth,callbackScope:e,loop:!0})),GameUI.updateHealthBar(e),console.log(`Health regeneration timer set: +1 HP every ${t/1e3} seconds`)},regenerateHealth:function(){gameOver||gamePaused||playerHealth<maxPlayerHealth&&(playerHealth=Math.min(playerHealth+1,maxPlayerHealth),GameUI.updateHealthBar(this),LifeSystem.showRegenEffect(this))},showRegenEffect:function(e){const t=e.add.text(player.x,player.y-20,"+1",{fontFamily:"Arial",fontSize:"16px",color:"#00ff00"}).setOrigin(.5);e.tweens.add({targets:t,y:t.y-15,alpha:0,duration:800,onComplete:function(){t.destroy()}})},fullHeal:function(){playerHealth=maxPlayerHealth;const e=game.scene.scenes[0];if(e){GameUI.updateHealthBar(e);const t=e.add.text(player.x,player.y-40,"+HEAL",{fontFamily:"Arial",fontSize:"18px",color:"#00ff00"}).setOrigin(.5);e.tweens.add({targets:t,y:t.y-30,alpha:0,duration:1e3,onComplete:function(){t.destroy()}})}},reset:function(){this.healthRegenTimer&&(this.healthRegenTimer.remove(),this.healthRegenTimer=null),this.isInitialized=!1,console.log("Life system reset")}};window.LifeSystem=LifeSystem,window.fullHeal=LifeSystem.fullHeal;const UI={kajisuli:{enabled:function(){return"undefined"!=typeof KAJISULI_MODE&&KAJISULI_MODE}},game:{getWidth:function(){return 1200},getHeight:function(){return 800},init:function(e){e&&e.sys&&e.sys.game&&(this.getWidth=function(){const t=e.sys.game.canvas;return t?t.width:e.sys.game.config.width},this.getHeight=function(){const t=e.sys.game.canvas;return t?t.height:e.sys.game.config.height})}},rel:{width:function(e){return UI.game.getWidth()*(e/100)},height:function(e){return UI.game.getHeight()*(e/100)},x:function(e){return UI.game.getWidth()*(e/100)},y:function(e){return UI.game.getHeight()*(e/100)},fontSize:function(e){return Math.floor(UI.game.getHeight()*(e/100))}},healthBar:{width:function(){return UI.rel.width(25)},height:function(){return UI.rel.height(1.25)},borderWidth:2,innerMargin:2,segmentGap:function(){return UI.rel.width(.33)},y:function(){return UI.rel.y(2.5)},centerX:function(){return UI.rel.x(50)},startX:function(){return UI.rel.x(37.5)}},expBar:{width:function(){return UI.rel.width(16.7)},height:function(){return UI.rel.height(.625)},borderWidth:2,innerMargin:1,y:function(){return UI.rel.y(5.5)},centerX:function(){return UI.rel.x(50)},startX:function(){return UI.rel.x(41.7)},textColor:"#00ffff",barColor:65535,bgColor:3355443},statusDisplay:{timerY:function(){return UI.rel.y(3.75)},killsY:function(){return UI.rel.y(3.75)},x:function(){return UI.rel.x(1.33)},timerWidth:function(){return UI.rel.width(10)},killsWidth:function(){return UI.rel.width(10)},killsX:function(){return UI.rel.x(13.33)},height:function(){return UI.rel.height(2.5)},borderWidth:2,textPadding:function(){return UI.rel.width(.33)},clockSymbol:"時",deathSymbol:"殺",fontSize:function(){return UI.rel.fontSize(2)}},statDisplay:{y:function(){return UI.rel.y(3.75)},x:function(){return UI.rel.x(76.7)},spacing:function(){return UI.rel.width(5.83)},width:function(){return UI.rel.width(4.17)},height:function(){return UI.rel.height(3)},borderWidth:2,textPadding:function(){return UI.rel.width(.33)},fontSize:function(){return UI.rel.fontSize(2.5)},symbols:{POW:"力",AGI:"速",LUK:"運",END:"耐"},symbolColors:{POW:"#cc0000",AGI:"#0088ff",LUK:"#aa55cc",END:"#00aa00"}},colors:{gold:16766720,green:52224,black:0,grey:3355443},depth:{ui:100},fonts:{level:{size:function(){return`${UI.rel.fontSize(2.25)}px`},family:"Arial",color:"#FFD700"},xpNeeded:{size:function(){return`${UI.rel.fontSize(1.5)}px`},family:"Arial",color:"#00ffff"},stats:{size:function(){return`${UI.rel.fontSize(2.5)}px`},family:"Arial",color:"#FFFFFF"},timer:{size:function(){return`${UI.rel.fontSize(2.25)}px`},family:"Arial",color:"#FFFFFF"},kills:{size:function(){return`${UI.rel.fontSize(2.25)}px`},family:"Arial",color:"#FFFFFF"}}},HealthBar={create:function(e){UI.game.init(e),e.healthBar&&e.healthBar.destroy(),e.healthBarBg&&e.healthBarBg.destroy(),e.healthText&&e.healthText.destroy();const t=UI.kajisuli.enabled()?1.5:1;e.healthBarScales={width:t,height:1};const i=UI.healthBar.width()*t,n=1*UI.healthBar.height(),o=UI.healthBar.borderWidth,a=(UI.healthBar.innerMargin,UI.healthBar.centerX()),r=UI.healthBar.y();e.healthBarBg=e.add.rectangle(a,r,i+2*o,n+2*o,UI.colors.gold).setDepth(UI.depth.ui),e.healthBarInnerBg=e.add.rectangle(a,r,i,n,UI.colors.black).setDepth(UI.depth.ui),e.healthSegments=e.add.group(),e.healthSeparators=e.add.group(),this.update(e)},update:function(e){if(!e.healthSegments||!e.healthSegments.scene)return;e.healthSegments.clear(!0,!0),e.healthSeparators&&e.healthSeparators.clear(!0,!0);const t=e.healthBarScales?.width??(UI.kajisuli.enabled()?1.5:1),i=e.healthBarScales?.height??1,n=UI.healthBar.width()*t,o=UI.healthBar.height()*i,a=UI.healthBar.innerMargin,r=UI.healthBar.centerX(),s=UI.healthBar.y(),l=n-2*a,c=o-2*a,d=UI.healthBar.segmentGap()*t,m=(l-(maxPlayerHealth-1)*d)/maxPlayerHealth,u=r-n/2+a;for(let t=0;t<maxPlayerHealth;t++){const i=t<playerHealth,n=u+t*(m+d),o=e.add.rectangle(n+m/2,s,m,c,i?UI.colors.green:UI.colors.grey).setDepth(UI.depth.ui);if(e.healthSegments.add(o),t<maxPlayerHealth-1){const t=n+m+d/2,i=e.add.rectangle(t,s,2,c,UI.colors.gold).setDepth(UI.depth.ui);e.healthSeparators.add(i)}}}};function formatLargeNumber(e){if(e<1e4)return e.toString();const t=[{value:1e12,kanji:"兆"},{value:1e11,kanji:"千億"},{value:1e10,kanji:"百億"},{value:1e9,kanji:"十億"},{value:1e8,kanji:"億"},{value:1e7,kanji:"千万"},{value:1e6,kanji:"百万"},{value:1e5,kanji:"十万"},{value:1e4,kanji:"万"},{value:1e3,kanji:"千"},{value:100,kanji:"百"},{value:10,kanji:"十"}];for(const i of t)if(e>=i.value){const t=i.value/1e3;return`${Math.floor(e/t)}${i.kanji}`}return e.toString()}const ExpBar={create:function(e){UI.game.init(e),e.expBar&&e.expBar.destroy(),e.expBarBg&&e.expBarBg.destroy(),e.expText&&e.expText.destroy(),e.levelText&&e.levelText.destroy(),e.xpNeededText&&e.xpNeededText.destroy();const t=UI.kajisuli.enabled()?1.5:1;e.expBarScales={width:t,height:1};const i=UI.expBar.width()*t,n=1*UI.expBar.height(),o=UI.expBar.borderWidth,a=UI.expBar.innerMargin,r=UI.expBar.centerX(),s=UI.expBar.y();e.expBarBg=e.add.rectangle(r,s,i+2*o,n+2*o,UI.colors.gold).setDepth(UI.depth.ui),e.expBarInnerBg=e.add.rectangle(r,s,i,n,UI.colors.black).setDepth(UI.depth.ui);const l=r-i/2+a;e.expBar=e.add.rectangle(l,s,0,n-2*a,UI.expBar.barColor).setOrigin(0,.5).setDepth(UI.depth.ui);const c=UI.kajisuli.enabled()?UI.rel.width(5):UI.rel.width(2.5);e.levelText=e.add.text(r-i/2-c,s,"1",{fontFamily:UI.fonts.level.family,fontSize:UI.kajisuli.enabled()?1.2*parseInt(UI.fonts.level.size())+"px":UI.fonts.level.size(),color:UI.fonts.level.color}).setOrigin(.5).setDepth(UI.depth.ui),e.xpNeededText=e.add.text(r+i/2+c,s,"5",{fontFamily:UI.fonts.xpNeeded.family,fontSize:UI.kajisuli.enabled()?1.2*parseInt(UI.fonts.xpNeeded.size())+"px":UI.fonts.xpNeeded.size(),color:UI.fonts.xpNeeded.color}).setOrigin(.5).setDepth(UI.depth.ui),this.update(e)},update:function(e){if(!e.expBar||!e.levelText||!e.xpNeededText)return;const t=e.expBarScales?.width??(UI.kajisuli.enabled()?1.5:1),i=(e.expBarScales,UI.expBar.width()*t-2*UI.expBar.innerMargin),n=Math.max(0,Math.min(1,heroExp/xpForNextLevel(playerLevel)));e.expBar.width=n*i,e.levelText.setText(`${playerLevel}`);const o=xpForNextLevel(playerLevel)-heroExp;e.xpNeededText.setText(formatLargeNumber(o))}},StatusDisplay={create:function(e){UI.game.init(e),e.timerBox&&e.timerBox.destroy(),e.timerBoxInner&&e.timerBoxInner.destroy(),e.timerText&&e.timerText.destroy(),e.timerSymbol&&e.timerSymbol.destroy(),e.killsBox&&e.killsBox.destroy(),e.killsBoxInner&&e.killsBoxInner.destroy(),e.killsText&&e.killsText.destroy(),e.killsSymbol&&e.killsSymbol.destroy();const t=UI.kajisuli.enabled()?1.4:1,i=UI.kajisuli.enabled()?.9:1,n=UI.kajisuli.enabled()?UI.rel.x(6):UI.statusDisplay.x(),o=UI.kajisuli.enabled()?n+UI.statusDisplay.timerWidth()*t/2:UI.statusDisplay.x()+UI.statusDisplay.timerWidth()*t/2;e.timerBox=e.add.rectangle(o,UI.statusDisplay.timerY(),UI.statusDisplay.timerWidth()*t+2*UI.statusDisplay.borderWidth,UI.statusDisplay.height()+2*UI.statusDisplay.borderWidth,UI.colors.gold).setDepth(UI.depth.ui).setOrigin(.5),e.timerBoxInner=e.add.rectangle(o,UI.statusDisplay.timerY(),UI.statusDisplay.timerWidth()*t,UI.statusDisplay.height(),UI.colors.black).setDepth(UI.depth.ui).setOrigin(.5),UI.kajisuli.enabled()?e.timerText=e.add.text(o,UI.statusDisplay.timerY(),"00:00",{fontFamily:UI.fonts.timer.family,fontSize:parseInt(UI.fonts.timer.size())*i+"px",color:UI.fonts.timer.color}).setDepth(UI.depth.ui).setOrigin(.5):(e.timerSymbol=e.add.text(UI.statusDisplay.x()+UI.statusDisplay.textPadding(),UI.statusDisplay.timerY(),UI.statusDisplay.clockSymbol,{fontFamily:UI.fonts.timer.family,fontSize:UI.fonts.timer.size(),color:UI.fonts.timer.color}).setDepth(UI.depth.ui).setOrigin(0,.5),e.timerText=e.add.text(UI.statusDisplay.x()+UI.statusDisplay.timerWidth()-UI.statusDisplay.textPadding(),UI.statusDisplay.timerY(),"00:00",{fontFamily:UI.fonts.timer.family,fontSize:UI.fonts.timer.size(),color:UI.fonts.timer.color}).setDepth(UI.depth.ui).setOrigin(1,.5));let a=UI.kajisuli.enabled()?UI.game.getWidth()-n-UI.statusDisplay.killsWidth()*t/2:UI.statusDisplay.killsX()+UI.statusDisplay.killsWidth()*t/2;e.killsBox=e.add.rectangle(a,UI.statusDisplay.killsY(),UI.statusDisplay.killsWidth()*t+2*UI.statusDisplay.borderWidth,UI.statusDisplay.height()+2*UI.statusDisplay.borderWidth,UI.colors.gold).setDepth(UI.depth.ui).setOrigin(.5),e.killsBoxInner=e.add.rectangle(a,UI.statusDisplay.killsY(),UI.statusDisplay.killsWidth()*t,UI.statusDisplay.height(),UI.colors.black).setDepth(UI.depth.ui).setOrigin(.5),UI.kajisuli.enabled()?e.killsText=e.add.text(a,UI.statusDisplay.killsY(),"0",{fontFamily:UI.fonts.kills.family,fontSize:parseInt(UI.fonts.kills.size())*i+"px",color:UI.fonts.kills.color}).setDepth(UI.depth.ui).setOrigin(.5):(e.killsSymbol=e.add.text(UI.statusDisplay.killsX()+UI.statusDisplay.textPadding(),UI.statusDisplay.killsY(),UI.statusDisplay.deathSymbol,{fontFamily:UI.fonts.kills.family,fontSize:UI.fonts.kills.size(),color:UI.fonts.kills.color}).setDepth(UI.depth.ui).setOrigin(0,.5),e.killsText=e.add.text(UI.statusDisplay.killsX()+UI.statusDisplay.killsWidth()-UI.statusDisplay.textPadding(),UI.statusDisplay.killsY(),"0",{fontFamily:UI.fonts.kills.family,fontSize:UI.fonts.kills.size(),color:UI.fonts.kills.color}).setDepth(UI.depth.ui).setOrigin(1,.5)),this.update(e)},update:function(e,t,i){e.timerText&&e.timerText.setText(formatTime(t??elapsedTime)),e.killsText&&e.killsText.setText(formatLargeNumber(i??score))}},StatDisplay={create:function(e){if(UI.game.init(e),e.statRects&&e.statRects.forEach((e=>{e.rectBg&&e.rectBg.destroy(),e.rectInner&&e.rectInner.destroy(),e.symbolText&&e.symbolText.destroy(),e.valueText&&e.valueText.destroy()})),UI.kajisuli.enabled())return void(e.statRects=[]);e.statRects=[];["POW","AGI","LUK","END"].forEach(((t,i)=>{const n=UI.statDisplay.x()+i*UI.statDisplay.spacing(),o=e.add.rectangle(n+UI.statDisplay.width()/2,UI.statDisplay.y(),UI.statDisplay.width()+2*UI.statDisplay.borderWidth,UI.statDisplay.height()+2*UI.statDisplay.borderWidth,UI.colors.gold).setDepth(UI.depth.ui).setOrigin(.5),a=e.add.rectangle(n+UI.statDisplay.width()/2,UI.statDisplay.y(),UI.statDisplay.width(),UI.statDisplay.height(),UI.colors.black).setDepth(UI.depth.ui).setOrigin(.5),r=e.add.text(n+UI.statDisplay.textPadding(),UI.statDisplay.y(),UI.statDisplay.symbols[t],{fontFamily:"Arial",fontSize:UI.statDisplay.fontSize(),color:UI.statDisplay.symbolColors[t]}).setDepth(UI.depth.ui).setOrigin(0,.5),s=e.add.text(n+UI.statDisplay.width()-UI.statDisplay.textPadding(),UI.statDisplay.y(),"0",{fontFamily:"Arial",fontSize:UI.fonts.stats.size(),color:UI.fonts.stats.color}).setDepth(UI.depth.ui).setOrigin(1,.5);e.statRects[i]={stat:t,rectBg:o,rectInner:a,symbolText:r,valueText:s}})),this.update(e)},update:function(e){e.statRects&&e.statRects.forEach((e=>{if(!e||!e.valueText)return;let t=0;switch(e.stat){case"POW":t=getEffectiveDamage()??0;break;case"AGI":t=getEffectiveFireRate()??0;break;case"LUK":t=playerLuck??0;break;case"END":t=maxPlayerHealth??0}e.valueText.setText(Math.floor(t).toString())}))}};function createUI(e){UI.game.init(e),HealthBar.create(e),ExpBar.create(e),StatusDisplay.create(e),StatDisplay.create(e)}function resizeUI(e){createUI(e)}window.GameUI={createUI:createUI,updateHealthBar:HealthBar.update,updateExpBar:ExpBar.update,updateStatusDisplay:StatusDisplay.update,updateStatCircles:StatDisplay.update,resize:resizeUI},UI.gameEndScreen={width:function(){return UI.rel.width(50)},height:function(){return UI.rel.height(60)},y:function(){return UI.rel.y(50)},x:function(){return UI.rel.x(50)},borderWidth:4,innerPadding:function(){return UI.rel.width(2)},fontSizes:{title:function(){return`${UI.rel.fontSize(4)}px`},subtitle:function(){return`${UI.rel.fontSize(3)}px`},stats:function(){return`${UI.rel.fontSize(2.5)}px`},button:function(){return`${UI.rel.fontSize(3)}px`}}},UI.gameEndScreen={width:function(){const e=UI.rel.width(50);return Math.max(e,480)},height:function(){return UI.rel.height(60)},y:function(){return UI.rel.y(50)},x:function(){return UI.rel.x(50)},borderWidth:4,innerPadding:function(){return UI.rel.width(2)},scaleFactor:function(){const e=UI.game.getWidth();return Math.max(.8,e/1200)},fontSizes:{title:function(){return UI.rel.fontSize(4)*UI.gameEndScreen.scaleFactor()+"px"},subtitle:function(){return UI.rel.fontSize(3)*UI.gameEndScreen.scaleFactor()+"px"},stats:function(){return UI.rel.fontSize(2.5)*UI.gameEndScreen.scaleFactor()+"px"},button:function(){return UI.rel.fontSize(3)*UI.gameEndScreen.scaleFactor()+"px"}}};const GameEndMenu={elements:{container:null,background:null,borderRect:null,heroKanji:null,titleText:null,enemyKanji:null,subtitleText:null,statsText:null,restartButton:null,restartButtonBorder:null},enterKeyHandler:null,create:function(e,t=!1,i=null,n=null){this.destroy(),this.elements.container=e.add.container(0,0),this.elements.container.setDepth(1e3);const o=e.add.rectangle(UI.game.getWidth()/2,UI.game.getHeight()/2,UI.game.getWidth(),UI.game.getHeight(),0,.7);return this.elements.container.add(o),this.elements.background=e.add.rectangle(UI.gameEndScreen.x(),UI.gameEndScreen.y(),UI.gameEndScreen.width(),UI.gameEndScreen.height(),0),this.elements.container.add(this.elements.background),this.elements.borderRect=e.add.rectangle(UI.gameEndScreen.x(),UI.gameEndScreen.y(),UI.gameEndScreen.width(),UI.gameEndScreen.height()),this.elements.borderRect.setStrokeStyle(UI.gameEndScreen.borderWidth,16766720),this.elements.container.add(this.elements.borderRect),t?this.createVictoryContent(e,n):this.createDefeatContent(e,i),this.createRestartButton(e),this.setupKeyboardHandler(e),this.elements.container},createEndGameContent:function(e,t){const i={isVictory:!1,heroKanjiOffset:-200,titleTextOffset:-150,titleText:"",subtitleText:"",subtitleCentered:!1,subtitleTextOffset:0,enemyKanji:"敵",enemyKanjiOffset:200,statsTemplate:"",...t},n=UI.gameEndScreen.x(),o=UI.gameEndScreen.y()-UI.gameEndScreen.height()/3,a=UI.gameEndScreen.y()-UI.gameEndScreen.height()/6,r=UI.gameEndScreen.scaleFactor(),s=n+i.heroKanjiOffset*r,l=n+i.titleTextOffset*r,c=i.subtitleCentered?n:n+i.subtitleTextOffset*r,d=n+i.enemyKanjiOffset*r;this.elements.heroKanji=e.add.text(s,o,HERO_CHARACTER,{fontFamily:"Arial",fontSize:UI.gameEndScreen.fontSizes.title(),color:"#FFFFFF",fontStyle:"bold"}).setOrigin(.5),this.elements.container.add(this.elements.heroKanji),this.elements.titleText=e.add.text(l,o,i.titleText,{fontFamily:"Arial",fontSize:UI.gameEndScreen.fontSizes.title(),color:"#FFD700",fontStyle:"bold"}).setOrigin(0,.5),this.elements.container.add(this.elements.titleText);const m=(i.subtitleCentered,.5);if(this.elements.subtitleText=e.add.text(c,a,i.subtitleText,{fontFamily:"Arial",fontSize:UI.gameEndScreen.fontSizes.title(),color:"#FFD700",fontStyle:"bold"}).setOrigin(m),this.elements.container.add(this.elements.subtitleText),this.elements.enemyKanji=e.add.text(d,a,i.enemyKanji,{fontFamily:"Arial",fontSize:UI.gameEndScreen.fontSizes.title(),color:"#FF5555",fontStyle:"bold"}).setOrigin(.5),this.elements.container.add(this.elements.enemyKanji),this.elements.statsText=e.add.text(n,UI.gameEndScreen.y()+UI.gameEndScreen.height()/10,i.statsTemplate,{fontFamily:"Arial",fontSize:UI.gameEndScreen.fontSizes.stats(),color:"#FFD700",align:"center"}).setOrigin(.5),this.elements.container.add(this.elements.statsText),window.ScoreSystem){const t=ScoreSystem.calculateScore(i.isVictory);ScoreSystem.animateScoreReveal(e,this.elements.statsText,t)}},createVictoryContent:function(e,t){const i=t??activeBoss?.text??"魔";this.createEndGameContent(e,{isVictory:!0,heroKanjiOffset:-200,titleTextOffset:-150,titleText:"ESCAPED THE LOOP",subtitleText:"VANQUISHING",subtitleCentered:!0,subtitleTextOffset:0,enemyKanji:i,enemyKanjiOffset:180,statsTemplate:`IN ${formatTime(elapsedTime)}          FREED ${score}`})},createDefeatContent:function(e,t){const i=t??"敵";this.createEndGameContent(e,{isVictory:!1,heroKanjiOffset:-220,titleTextOffset:-160,titleText:"FOUND THEIR DEMISE",subtitleText:"AT THE HANDS OF",subtitleCentered:!1,subtitleTextOffset:-60,enemyKanji:i,enemyKanjiOffset:180,statsTemplate:`SURVIVED ${formatTime(elapsedTime)}          DEFEATED ${score}`})},createRestartButton:function(e){const t=UI.gameEndScreen.y()+UI.gameEndScreen.height()/3,i=UI.gameEndScreen.x();this.elements.restartButton=e.add.text(i,t,"RESTART THE LOOP",{fontFamily:"Arial",fontSize:UI.gameEndScreen.fontSizes.button(),color:"#FFD700",fontStyle:"bold"}).setOrigin(.5);const n=this.elements.restartButton.width+40,o=this.elements.restartButton.height+40;this.elements.restartButtonBorder=e.add.rectangle(i,t,n,o),this.elements.restartButtonBorder.setStrokeStyle(2,16766720),this.elements.container.add(this.elements.restartButtonBorder),this.elements.container.add(this.elements.restartButton),this.elements.restartButton.setInteractive({useHandCursor:!0}),this.elements.restartButton.on("pointerover",(()=>{this.elements.restartButton.setColor("#FFFFFF"),this.elements.restartButtonBorder.setStrokeStyle(3,16766720),e.tweens.add({targets:[this.elements.restartButton,this.elements.restartButtonBorder],scale:1.05,duration:100})})),this.elements.restartButton.on("pointerout",(()=>{this.elements.restartButton.setColor("#FFD700"),this.elements.restartButtonBorder.setStrokeStyle(2,16766720),e.tweens.add({targets:[this.elements.restartButton,this.elements.restartButtonBorder],scale:1,duration:100})})),this.elements.restartButton.on("pointerdown",(function(){window.ScoreSystem?.skipToFinalScore?.(e)||!1?e.time.delayedCall(250,(()=>startGame.call(e))):startGame.call(e)}))},setupKeyboardHandler:function(e){this.cleanupKeyboardHandler(),this.enterKeyHandler=function(t){"Enter"===t.key&&(GameEndMenu.cleanupKeyboardHandler(),startGame.call(e))},window.addEventListener("keydown",this.enterKeyHandler)},showVictoryScreen:function(e){const t=activeBoss?activeBoss.text:null;return this.create(e,!0,null,t)},showDefeatScreen:function(e,t){return this.create(e,!1,t)},cleanupKeyboardHandler:function(){this.enterKeyHandler&&(window.removeEventListener("keydown",this.enterKeyHandler),this.enterKeyHandler=null)},destroy:function(){this.cleanupKeyboardHandler(),this.elements.container&&this.elements.container.destroy(),Object.keys(this.elements).forEach((e=>{this.elements[e]=null}))}};window.GameEndMenu=GameEndMenu;const MusicSystem={tracks:[],playQueue:[],currentTrackIndex:-1,currentTrack:null,fadeInTween:null,fadeOutTween:null,silenceTimer:null,nextTrackToPlay:null,isLoading:!1,silenceDuration:4e3,fadeDuration:4e3,volume:.7,musicEnabled:!0,currentRate:1,pausedVolume:.3,savedVolume:null,pausePulseTween:null,lowPassFilter:null,bossFilterNode:null,chorusNodes:[],isInBossFight:!1,originalAudioPath:null,musicTimers:[],initialize:function(e){return console.log("Initializing music system"),this.tracks=[],this.playQueue=[],this.currentTrackIndex=-1,this.currentRate=1,this.nextTrackToPlay=null,this.isLoading=!1,this.scene=e,this},preload:function(e){for(let e=1;e<=23;e++){const t=`track-${String(e).padStart(2,"0")}`;this.tracks.push(t)}this.shuffleArray(this.tracks),this.playQueue=[...this.tracks],this.currentTrackIndex=-1,console.log("Music system ready (tracks will load as needed)")},shuffleArray:function(e){for(let t=e.length-1;t>0;t--){const i=Math.floor(Math.random()*(t+1));[e[t],e[i]]=[e[i],e[t]]}return e},create:function(e){return this},start:function(){this.musicEnabled&&this.scene&&(this.currentTrack||this.playNextTrack())},playNextTrack:function(){if(!this.musicEnabled||!this.scene||this.isLoading)return;this.currentTrackIndex>=this.playQueue.length-1&&this.createNewPlayQueue(),this.currentTrackIndex++;const e=this.playQueue[this.currentTrackIndex];this.nextTrackToPlay=e,console.log(`Preparing to play next track: ${e}`),this.startSilencePeriod(e)},startSilencePeriod:function(e){console.log(`Starting silence period before track: ${e}`),this.silenceTimer&&("number"==typeof this.silenceTimer?clearTimeout(this.silenceTimer):this.silenceTimer.remove&&this.silenceTimer.remove(),this.silenceTimer=null),this.loadTrack(e),this.silenceTimer=setTimeout((()=>{this.scene.sound.get(e)?(console.log("Silence period complete, starting track"),this.startTrackWithFadeIn(e)):(console.log(`Track ${e} not loaded yet, waiting...`),this.silenceTimer=setTimeout((()=>{this.scene.sound.get(e)?this.startTrackWithFadeIn(e):(console.log(`Giving up on track ${e}, skipping to next`),this.playNextTrack())}),2e3))}),this.silenceDuration)},loadTrack:function(e){if(this.scene.sound.get(e))return void console.log(`Track ${e} already loaded`);this.isLoading=!0,console.log(`Loading track: ${e}`);const t=`../music/${e}.mp3`,i=new Phaser.Loader.LoaderPlugin(this.scene);i.audio(e,t),i.once("complete",(()=>{console.log(`Finished loading track: ${e}`),this.scene.sound.add(e,{loop:!1,volume:0}),this.isLoading=!1})),i.once("loaderror",(t=>{console.error(`Error loading track: ${e}`,t),this.isLoading=!1,e===this.nextTrackToPlay&&(console.log("Skipping to next track due to load error"),this.playNextTrack())})),i.start()},startTrackWithFadeIn:function(e){if(console.log("start track with fade in"),!this.musicEnabled||!this.scene)return;console.log("STWFI continues");const t=this.scene.sound.get(e);if(!t)return console.error(`Track not found: ${e}`),void this.playNextTrack();this.currentTrack&&this.currentTrack.isPlaying&&(this.fadeOutTween&&(this.fadeOutTween.stop(),this.fadeOutTween=null),this.fadeOutTween=this.scene.tweens.add({targets:this.currentTrack,volume:0,duration:500,ease:"Linear",onComplete:()=>{this.currentTrack.stop(),this.fadeOutTween=null}})),this.currentTrack=t,t.setRate(this.currentRate),t.setVolume(0),t.play(),this.isInBossFight&&(console.log("Re-applying boss fight effect to new track"),this.applyBossFightEffect()),gamePaused&&this.onGameResume(),this.fadeInTween=this.scene.tweens.add({targets:t,volume:this.volume,duration:this.fadeDuration,ease:"Linear",onComplete:()=>{console.log("Fade-in complete"),this.fadeInTween=null;const e=1e3*t.totalDuration,i=Math.max(0,e-2*this.fadeDuration);if(console.log(`Scheduling fade-out in ${i}ms (real time)`),i>25e3){const e=this.scene.time.delayedCall(i-2e4,(()=>{const e=this.currentTrackIndex+1;if(e<this.playQueue.length){const t=this.playQueue[e];this.loadTrack(t)}}));this.musicTimers.push(e)}const n=this.scene.time.delayedCall(i,(()=>{console.log("Time to start fade-out (from music timer)"),this.startFadeOut()}));this.musicTimers.push(n)}})},createNewPlayQueue:function(){const e=[...this.tracks];if(this.shuffleArray(e),this.playQueue.length>0&&this.currentTrackIndex>=0){const t=this.playQueue[this.currentTrackIndex];if(e[0]===t){const t=1+Math.floor(Math.random()*(e.length-1));[e[0],e[t]]=[e[t],e[0]]}}this.playQueue=e,this.currentTrackIndex=-1},applyTimeDilation:function(e){this.currentTrack&&this.currentTrack.isPlaying&&(this.currentRate=e,this.currentTrack.setRate(e))},setMusicEnabled:function(e){return this.musicEnabled=e,!e&&this.currentTrack?this.stopCurrentTrack():e&&!this.currentTrack&&this.scene&&this.playNextTrack(),this.musicEnabled},setVolume:function(e){return this.volume=Phaser.Math.Clamp(e,0,1),this.currentTrack&&this.currentTrack.isPlaying&&(this.fadeInTween&&this.fadeInTween.isPlaying()?this.fadeInTween.updateTo("volume",this.volume,!0):this.fadeOutTween&&this.fadeOutTween.isPlaying()||this.currentTrack.setVolume(this.volume)),this.volume},stop:function(){this.stopCurrentTrack(),this.silenceTimer&&("number"==typeof this.silenceTimer?clearTimeout(this.silenceTimer):this.silenceTimer.remove&&this.silenceTimer.remove(),this.silenceTimer=null)},startFadeOut:function(){if(console.log("start fade out"),!this.currentTrack||!this.currentTrack.isPlaying)return console.log("No track playing during fade-out, starting next track"),void this.playNextTrack();console.log("continue fade out"),this.fadeOutTween=this.scene.tweens.add({targets:this.currentTrack,volume:0,duration:this.fadeDuration,ease:"Linear",onComplete:()=>{this.stopCurrentTrack(),this.playNextTrack()}})},stopCurrentTrack:function(){this.fadeInTween&&(this.fadeInTween.stop(),this.fadeInTween=null),this.fadeOutTween&&(this.fadeOutTween.stop(),this.fadeOutTween=null),this.currentTrack&&this.currentTrack.isPlaying&&this.currentTrack.stop(),this.currentTrack=null,this.musicTimers.forEach((e=>{e&&e.remove&&e.remove()})),this.musicTimers=[]},update:function(e,t){},cleanup:function(){this.stop(),this.silenceTimer&&("number"==typeof this.silenceTimer?clearTimeout(this.silenceTimer):this.silenceTimer.remove&&this.silenceTimer.remove(),this.silenceTimer=null)},onGamePause:function(){if(console.log("Game paused, applying muffled effect to music"),this.currentTrack&&(this.currentTrack.isPlaying||this.currentTrack.isPaused)){if(this.fadeInTween&&this.fadeInTween.isPlaying())return console.log("Fade-in active, skipping volume changes during pause"),void this.applyLowPassFilter();try{if(this.savedVolume=this.currentTrack.volume,this.currentTrack.setVolume(this.pausedVolume||.3),this.scene&&this.scene.sound&&this.scene.sound.context&&this.currentTrack.source&&this.currentTrack.source.disconnect){const e=this.scene.sound.context;this.lowPassFilter=e.createBiquadFilter(),this.lowPassFilter.type="lowpass",this.lowPassFilter.frequency.value=800,this.lowPassFilter.Q.value=.5;const t=this.currentTrack.source.destination||e.destination;this.currentTrack.source.disconnect(),this.currentTrack.source.connect(this.lowPassFilter),this.lowPassFilter.connect(t),console.log("Applied low-pass filter")}const e={volume:this.pausedVolume||.3};this.pausePulseTween=this.scene.tweens.add({targets:e,volume:.7*(this.pausedVolume||.3),duration:2e3,ease:"Sine.easeInOut",yoyo:!0,repeat:-1,onUpdate:()=>{this.currentTrack&&this.currentTrack.setVolume(e.volume)}})}catch(e){console.log("Error applying pause effects:",e)}}},onGameResume:function(){if(console.log("Game resumed, removing muffled effect"),this.currentTrack)try{if(this.pausePulseTween&&(this.pausePulseTween.stop(),this.pausePulseTween=null),void 0!==this.savedVolume?(this.currentTrack.setVolume(this.savedVolume),this.savedVolume=void 0):this.currentTrack.setVolume(this.volume),this.lowPassFilter&&this.currentTrack.source&&this.currentTrack.source.disconnect)try{const e=this.scene.sound.context,t=this.currentTrack.source.destination||e.destination;this.currentTrack.source.disconnect(),this.currentTrack.source.connect(t),console.log("Removed low-pass filter from track"),this.isInBossFight&&(console.log("Re-applying boss fight effect after pause"),this.applyBossFightEffect())}catch(e){console.log("Error removing filter:",e)}else this.isInBossFight&&(console.log("Re-applying boss fight effect after pause (no low-pass filter)"),this.applyBossFightEffect())}catch(e){console.log("Error removing pause effects:",e)}},applyLowPassFilter:function(){if(this.scene&&this.scene.sound&&this.scene.sound.context)try{const e=this.scene.sound.context;if(this.lowPassFilter||(this.lowPassFilter=e.createBiquadFilter(),this.lowPassFilter.type="lowpass",this.lowPassFilter.frequency.value=800,this.lowPassFilter.Q.value=.5),this.currentTrack.source&&"function"==typeof this.currentTrack.source.disconnect&&"function"==typeof this.currentTrack.source.connect){const t=this.currentTrack.source.destination||e.destination;this.currentTrack.source.disconnect(),this.currentTrack.source.connect(this.lowPassFilter),this.lowPassFilter.connect(t),console.log("Applied low-pass filter")}}catch(e){console.log("Low-pass filter not supported:",e)}},createPauseVolumeEffect:function(){if(!this.scene||!this.currentTrack)return;this.pausePulseTween&&(this.pausePulseTween.stop(),this.pausePulseTween=null);const e={volume:this.pausedVolume};try{this.pausePulseTween=this.scene.tweens.add({targets:e,volume:.7*this.pausedVolume,duration:2e3,ease:"Sine.easeInOut",yoyo:!0,repeat:-1,onUpdate:()=>{this.currentTrack&&this.currentTrack.setVolume(e.volume)}}),console.log("Created pause pulse effect")}catch(e){console.log("Error creating pulse effect:",e)}},removeLowPassFilter:function(){if(this.lowPassFilter&&this.currentTrack&&this.currentTrack.source)try{if("function"==typeof this.currentTrack.source.disconnect&&"function"==typeof this.currentTrack.source.connect){const e=this.scene.sound.context,t=this.currentTrack.source.destination||e.destination;this.currentTrack.source.disconnect(),this.currentTrack.source.connect(t),console.log("Removed low-pass filter")}}catch(e){console.log("Error removing filter:",e)}},applyBossFightEffect:function(){return this.isInBossFight=!0,!0},removeBossFightEffect:function(){return this.isInBossFight=!1,!0}};window.MusicSystem=MusicSystem;const OrbitalPerkRegistry={perkOrbitalConfigs:{},registerPerkOrbital:function(e,t){this.perkOrbitalConfigs[e]={getConfig:t.getConfig??function(){return{}},count:t.count??1,cooldown:t.cooldown??null,activationMethod:t.activationMethod??"immediate"}},applyPerkOrbital:function(e,t){const i=this.perkOrbitalConfigs[t];if(!i)return!1;switch(console.log(`Applying orbital perk: ${t}`),i.activationMethod){case"immediate":this.createOrbitalImmediately(e,i);break;case"timer":this.setupOrbitalTimer(e,i);break;default:return console.log(`Unknown activation method: ${i.activationMethod}`),!1}return!0},createOrbitalImmediately:function(e,t){const i=t.getConfig();t.count>1?OrbitalSystem.createMultiple(e,t.count,i):OrbitalSystem.create(e,i)},setupOrbitalTimer:function(e,t){if(!t.cooldown)return;let i=t.cooldown;"function"==typeof i&&(i=i());const n=e.time.addEvent({delay:i,callback:function(){const i=t.getConfig();t.count>1?OrbitalSystem.createMultiple(e,t.count,i):OrbitalSystem.create(e,i)},callbackScope:e,loop:!0});window.registerEffect("timer",n)}};function launchTentacles(e){const t=[30,50,70,90];for(let i=0;i<4;i++){const n=i/4*Math.PI*2;t.forEach(((t,i)=>{const o=(.2*Math.random()-.1)*(.5*i+1),a={symbol:"✧",color:"#8800AA",fontSize:24,radius:t,angle:n+o,speed:.01,direction:"clockwise",pattern:"oscillating",collisionType:"projectile",damage:playerDamage,damageInterval:0,lifespan:null,options:{wobbleFrequency:2,wobbleAmplitude:.1*t*(i+1)}};OrbitalSystem.create(e,a)}))}e.tweens.add({targets:player,scale:1.2,duration:200,yoyo:!0,ease:"Cubic.easeOut"})}OrbitalPerkRegistry.registerPerkOrbital("WILD_FAIRY",{getConfig:function(){return{symbol:"妖",color:"#FF66CC",fontSize:20,radius:240,speed:.006,direction:"counterclockwise",pattern:"oscillating",collisionType:"persistent",damage:.5*playerDamage,damageInterval:200,lifespan:null,options:{wobbleFrequency:6,wobbleAmplitude:180}}},count:1,activationMethod:"immediate"}),window.activateWildFairy=function(){const e=game.scene.scenes[0];e&&OrbitalPerkRegistry.applyPerkOrbital(e,"WILD_FAIRY")},OrbitalPerkRegistry.registerPerkOrbital("TEAL_OCTOPUS",{getConfig:function(){return{symbol:"★",fontSize:getEffectiveSize(projectileSizeFactor,playerDamage),radius:16*playerLuck,speed:.02,pattern:"standard",collisionType:"projectile",damage:playerDamage,damageInterval:0,lifespan:null,options:{}}},count:1,cooldown:function(){return 1e3/Math.sqrt(playerFireRate/BASE_STATS.AGI)},activationMethod:"timer"}),window.activateOrbitingProjectile=function(){const e=game.scene.scenes[0];if(e){const t=OrbitalPerkRegistry.perkOrbitalConfigs.TEAL_OCTOPUS.getConfig();OrbitalSystem.create(e,t),OrbitalPerkRegistry.applyPerkOrbital(e,"TEAL_OCTOPUS")}},OrbitalPerkRegistry.registerPerkOrbital("INVERTED_OCTOPUS",{getConfig:function(){return{symbol:"★",fontSize:getEffectiveSize(projectileSizeFactor,playerDamage),radius:16*playerLuck,speed:.02,direction:"counterclockwise",pattern:"standard",collisionType:"projectile",damage:playerDamage,damageInterval:0,lifespan:null,options:{}}},count:1,cooldown:function(){return 1e3/Math.sqrt(playerFireRate/BASE_STATS.AGI)},activationMethod:"timer"}),window.activateInvertedOctopus=function(){const e=game.scene.scenes[0];if(!e)return;const t=OrbitalPerkRegistry.perkOrbitalConfigs.INVERTED_OCTOPUS.getConfig();OrbitalSystem.create(e,t),OrbitalPerkRegistry.applyPerkOrbital(e,"INVERTED_OCTOPUS")},OrbitalPerkRegistry.registerPerkOrbital("TENTACLE_GRASP",{getConfig:function(){return{symbol:"✧",color:"#8800AA",fontSize:24,radius:80,angle:Math.random()*Math.PI*2,speed:.01,pattern:"oscillating",collisionType:"projectile",damage:playerDamage,damageInterval:0,lifespan:null}},cooldown:3e4,activationMethod:"timer"}),window.activateTentacleGrasp=function(){const e=game.scene.scenes[0];e&&(launchTentacles(e),OrbitalPerkRegistry.applyPerkOrbital(e,"TENTACLE_GRASP"))};let immortalBodyAngle=Math.random()*Math.PI*2;function updateImmortalBodyAngle(){const e=OrbitalSystem.getAll().find((e=>"腕"===e.entity.text||"頭"===e.entity.text||"脚"===e.entity.text));e&&(immortalBodyAngle=e.angle)}OrbitalPerkRegistry.registerPerkOrbital("IMMORTAL_ARM",{getConfig:function(){return{symbol:"腕",color:"#9932CC",fontSize:32,radius:100,angle:immortalBodyAngle,speed:.01,pattern:"standard",collisionType:"persistent",damage:playerDamage,damageInterval:500,lifespan:null,options:{}}},count:1,activationMethod:"immediate"}),OrbitalPerkRegistry.registerPerkOrbital("IMMORTAL_HEAD",{getConfig:function(){return{symbol:"頭",color:"#9932CC",fontSize:32,radius:50,angle:immortalBodyAngle,speed:.01,pattern:"standard",collisionType:"persistent",damage:playerDamage,damageInterval:500,lifespan:null,options:{}}},count:1,activationMethod:"immediate"}),OrbitalPerkRegistry.registerPerkOrbital("IMMORTAL_LEG",{getConfig:function(){return{symbol:"脚",color:"#9932CC",fontSize:32,radius:150,angle:immortalBodyAngle,speed:.01,pattern:"standard",collisionType:"persistent",damage:playerDamage,damageInterval:500,lifespan:null,options:{}}},count:1,activationMethod:"immediate"}),window.activateImmortalArm=function(){const e=game.scene.scenes[0];e&&(updateImmortalBodyAngle(),OrbitalPerkRegistry.applyPerkOrbital(e,"IMMORTAL_ARM"))},window.activateImmortalHead=function(){const e=game.scene.scenes[0];e&&(updateImmortalBodyAngle(),OrbitalPerkRegistry.applyPerkOrbital(e,"IMMORTAL_HEAD"))},window.activateImmortalLeg=function(){const e=game.scene.scenes[0];e&&(updateImmortalBodyAngle(),OrbitalPerkRegistry.applyPerkOrbital(e,"IMMORTAL_LEG"))},OrbitalPerkRegistry.registerPerkOrbital("SNIPER_FAIRY",{getConfig:function(){return{symbol:"狙",color:"#FF55AA",fontSize:20,radius:80,speed:.01,pattern:"standard",collisionType:"persistent",damage:.1*playerDamage,damageInterval:500,lifespan:null,options:{isFamiliar:!0,familiarType:"sniper",rangeModifier:2}}},count:1,activationMethod:"immediate"}),window.activateSniperFairy=function(){const e=game.scene.scenes[0];if(!e)return;const t=OrbitalPerkRegistry.perkOrbitalConfigs.SNIPER_FAIRY.getConfig(),i=OrbitalSystem.create(e,t);i&&i.options&&i.options.isFamiliar&&(i.firingTimer=FamiliarSystem.setupFamiliarFiringTimer(e,i,i.options.familiarType,4e3))},OrbitalPerkRegistry.registerPerkOrbital("COPY_FAIRY",{getConfig:function(){return{symbol:"写",color:"#55FFAA",fontSize:20,radius:40,speed:.01,pattern:"standard",collisionType:"persistent",damage:.1*playerDamage,damageInterval:500,lifespan:null,options:{isFamiliar:!0,familiarType:"copy"}}},count:1,activationMethod:"immediate"}),OrbitalPerkRegistry.registerPerkOrbital("BERSERK_FAIRY",{getConfig:function(){return{symbol:"狂",color:"#FF5500",fontSize:20,radius:200,speed:.02,pattern:"standard",collisionType:"persistent",damage:.1*playerDamage,damageInterval:500,lifespan:null,options:{isFamiliar:!0,familiarType:"berserk"}}},count:1,activationMethod:"immediate"}),window.activateCopyFairy=function(){const e=game.scene.scenes[0];if(!e)return;const t=OrbitalPerkRegistry.perkOrbitalConfigs.COPY_FAIRY.getConfig(),i=OrbitalSystem.create(e,t);i&&i.options&&i.options.isFamiliar&&(i.firingTimer=FamiliarSystem.setupFamiliarFiringTimer(e,i,i.options.familiarType,1200))},window.activateBerserkFairy=function(){const e=game.scene.scenes[0];if(!e)return;const t=OrbitalPerkRegistry.perkOrbitalConfigs.BERSERK_FAIRY.getConfig(),i=OrbitalSystem.create(e,t);i&&i.options&&i.options.isFamiliar&&(i.firingTimer=FamiliarSystem.setupFamiliarFiringTimer(e,i,i.options.familiarType,600))},OrbitalPerkRegistry.registerPerkOrbital("COLD_FAIRY",{getConfig:function(){return{symbol:"冷",color:"#00FFFF",fontSize:20,radius:60,speed:.01,direction:"counterclockwise",pattern:"standard",collisionType:"persistent",damage:.1*playerDamage,damageInterval:500,lifespan:null,options:{isFamiliar:!0,familiarType:"cold"}}},count:1,activationMethod:"immediate"}),window.activateColdFairy=function(){const e=game.scene.scenes[0];if(!e)return;const t=OrbitalPerkRegistry.perkOrbitalConfigs.COLD_FAIRY.getConfig(),i=OrbitalSystem.create(e,t);i&&i.options&&i.options.isFamiliar&&(i.firingTimer=FamiliarSystem.setupFamiliarFiringTimer(e,i,i.options.familiarType,6e3))},OrbitalPerkRegistry.registerPerkOrbital("FUN_FAIRY",{getConfig:function(){return{symbol:"遊",color:"#FF55FF",fontSize:22,radius:100,speed:.015,direction:"clockwise",pattern:"standard",collisionType:"persistent",damage:.1*playerDamage,damageInterval:500,lifespan:null,options:{isFamiliar:!0,familiarType:"fun"}}},count:1,activationMethod:"immediate"}),window.activateFunFairy=function(){const e=game.scene.scenes[0];if(!e)return;const t=OrbitalPerkRegistry.perkOrbitalConfigs.FUN_FAIRY.getConfig(),i=OrbitalSystem.create(e,t);i&&i.options&&i.options.isFamiliar&&(i.firingTimer=FamiliarSystem.setupFamiliarFiringTimer(e,i,i.options.familiarType,4e3),i.colorTimer=setupFairyColorChanger(e,i))},OrbitalPerkRegistry.registerPerkOrbital("DEATH_FINGER",{getConfig:function(){return{symbol:"指",color:"#FF0000",fontSize:16,radius:32,angle:0,speed:.1,direction:"clockwise",pattern:"directionFollowing",collisionType:"persistent",damage:0,damageInterval:0,lifespan:null,options:{isFamiliar:!0,familiarType:"deathFinger",oscillationSpeed:.01,oscillationAmount:2}}},count:1,activationMethod:"immediate"}),window.activateDeathFinger=function(){const e=game.scene.scenes[0];if(!e)return;const t=OrbitalPerkRegistry.perkOrbitalConfigs.DEATH_FINGER.getConfig(),i=OrbitalSystem.create(e,t);i&&i.options&&i.options.isFamiliar&&(i.firingTimer=FamiliarSystem.setupFamiliarFiringTimer(e,i,i.options.familiarType,500))},OrbitalPerkRegistry.registerPerkOrbital("FINGER_OF_DECAY",{getConfig:function(){return{symbol:"朽",color:"#88AA22",fontSize:16,radius:48,angle:0,speed:.1,direction:"clockwise",pattern:"directionFollowing",collisionType:"persistent",damage:0,damageInterval:0,lifespan:null,options:{isFamiliar:!0,familiarType:"decayFinger",oscillationSpeed:.01,oscillationAmount:2}}},count:1,activationMethod:"immediate"}),window.activateFingerOfDecay=function(){const e=game.scene.scenes[0];if(!e)return;const t=OrbitalPerkRegistry.perkOrbitalConfigs.FINGER_OF_DECAY.getConfig(),i=OrbitalSystem.create(e,t);i&&i.options&&i.options.isFamiliar&&(i.firingTimer=FamiliarSystem.setupFamiliarFiringTimer(e,i,i.options.familiarType,500))},OrbitalPerkRegistry.registerPerkOrbital("BRIGHT_LANCE",{getConfig:function(){return{symbol:"光槍",color:"#ffff00",fontSize:32,radius:96,angle:Math.random()*Math.PI*2,speed:.04,direction:"clockwise",pattern:"directionFollowing",collisionType:"persistent",damage:1*playerDamage,damageInterval:400,lifespan:null,options:{oscillationSpeed:.004,oscillationAmount:32}}},count:1,activationMethod:"immediate"}),window.activateBrightLance=function(){const e=game.scene.scenes[0];e&&OrbitalPerkRegistry.applyPerkOrbital(e,"BRIGHT_LANCE")},OrbitalPerkRegistry.registerPerkOrbital("HEALING_FAIRY",{getConfig:function(){return{symbol:"癒",color:"#00ff00",fontSize:22,radius:100,speed:.01,pattern:"oscillating",collisionType:"projectile",damage:.1*playerDamage,damageInterval:500,lifespan:2e4,options:{isFamiliar:!0,familiarType:"healer",wobbleFrequency:3,wobbleAmplitude:20}}},cooldown:2e4,activationMethod:"timer"}),window.activateHealingFairy=function(){const e=game.scene.scenes[0];if(!e)return;const t=OrbitalPerkRegistry.perkOrbitalConfigs.HEALING_FAIRY.getConfig(),i=OrbitalSystem.create(e,t);i&&i.options&&i.options.isFamiliar&&(i.firingTimer=FamiliarSystem.setupFamiliarFiringTimer(e,i,i.options.familiarType,4e3)),OrbitalPerkRegistry.applyPerkOrbital(e,"HEALING_FAIRY")},OrbitalPerkRegistry.registerPerkOrbital("LAVA_FAIRIES",{getConfig:function(){return{symbol:"溶",color:"#FF6600",fontSize:24,radius:16*playerLuck,speed:.012,pattern:"standard",collisionType:"projectile",damage:.5*playerDamage,damageInterval:500,lifespan:16e3,options:{components:[{name:"magmaDropEffect"}]}}},cooldown:4e3,activationMethod:"timer"}),window.activateLavaFairies=function(){const e=game.scene.scenes[0];if(!e)return;const t=OrbitalPerkRegistry.perkOrbitalConfigs.LAVA_FAIRIES.getConfig();OrbitalSystem.create(e,t);OrbitalPerkRegistry.applyPerkOrbital(e,"LAVA_FAIRIES")},OrbitalPerkRegistry.registerPerkOrbital("WRECKING_BALL",{getConfig:function(){return{symbol:"球",color:"#777777",fontSize:32,radius:192,speed:.015,direction:"clockwise",pattern:"figureEight",collisionType:"explosive",damage:2*playerDamage,damageInterval:0,lifespan:null,options:{blastRadius:128}}},cooldown:function(){return 16e3/Math.sqrt(playerLuck/BASE_STATS.LUK)},activationMethod:"timer"}),window.activateWreckingBall=function(){const e=game.scene.scenes[0];if(!e)return;const t=OrbitalPerkRegistry.perkOrbitalConfigs.WRECKING_BALL.getConfig();OrbitalSystem.create(e,t),OrbitalPerkRegistry.applyPerkOrbital(e,"WRECKING_BALL")},window.OrbitalPerkRegistry=OrbitalPerkRegistry;const OneTimeEffects={shuuen:function(e){if(!e)return;const t=e.add.rectangle(game.config.width/2,game.config.height/2,game.config.width,game.config.height,16777215,.8);t.setDepth(1e3),e.tweens.add({targets:t,alpha:0,duration:500,onComplete:function(){t.destroy()}}),e.time.delayedCall(100,(function(){const t=EnemySystem.enemiesGroup.getChildren();if(!t||0===t.length)return;const i=50*playerDamage,n=player.x,o=player.y,a=`shuuen_${Date.now()}_${Math.random()}`,r=e.add.circle(n,o,10,16724736,.7);e.tweens.add({targets:r,radius:1.2*Math.max(game.config.width,game.config.height),alpha:0,duration:1600,onComplete:function(){r.destroy()}}),t.forEach((t=>{if(!t.active)return;const r=t.x-n,s=t.y-o,l=Math.sqrt(r*r+s*s)/2;e.time.delayedCall(l,(function(){if(!t.active)return;const n=`${a}_${t.x}_${t.y}`;applyContactDamage.call(e,{damageSourceId:n,damage:i,active:!0},t,i,0),e.tweens.add({targets:t,alpha:.2,scale:1.5,duration:200,yoyo:!0})})),e.time.delayedCall(l,(function(){if(!t.active)return;const i=e.add.circle(t.x,t.y,30,16724736,.7);e.tweens.add({targets:i,radius:60,alpha:0,duration:300,onComplete:function(){i.destroy()}})}))}));const s=e.add.text(game.config.width/2,game.config.height/2,"終焉",{fontFamily:"Arial",fontSize:"80px",color:"#FF3300",stroke:"#000000",strokeThickness:6}).setOrigin(.5);e.tweens.add({targets:s,scale:2,alpha:0,duration:1e3,onComplete:function(){s.destroy()}})}))},purpleChaos:function(e){const t={damage:playerDamage,health:maxPlayerHealth,luck:playerLuck,fireRate:playerFireRate},i=Object.keys(t);for(let e=i.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[i[e],i[t]]=[i[t],i[e]]}const n={},o=["damage","health","luck","fireRate"];for(let e=0;e<o.length;e++)n[o[e]]=t[i[e]];if(window.modifyStat("damage",n.damage-playerDamage),window.modifyStat("health",n.health-maxPlayerHealth),window.modifyStat("luck",n.luck-playerLuck),window.modifyStat("fireRate",n.fireRate-playerFireRate),window.modifyStat("luck",2),e){const t=e.add.text(player.x,player.y,"⚡ CHAOS! ⚡",{fontFamily:"Arial",fontSize:"24px",color:"#9932cc",stroke:"#ffffff",strokeThickness:2}).setOrigin(.5);e.tweens.add({targets:t,alpha:{from:1,to:0},y:t.y-50,scale:{from:1,to:2},duration:1500,onComplete:function(){t.destroy()}})}},oblivionBlossom:function(e){if(!e)return;const t=acquiredPerks.length;playerDamage=BASE_STATS.POW,maxPlayerHealth=BASE_STATS.END,playerLuck=BASE_STATS.LUK,playerFireRate=BASE_STATS.AGI,playerHealth=maxPlayerHealth,GameUI.updateHealthBar(e),LifeSystem.setupHealthRegeneration(e);const i=Math.ceil(1.5*t);for(let e=0;e<i;e++){switch(Math.floor(4*Math.random())){case 0:window.modifyStat("damage",1);break;case 1:window.modifyStat("health",1);break;case 2:window.modifyStat("luck",1);break;case 3:window.modifyStat("fireRate",1)}}const n=e.add.text(player.x,player.y,"忘",{fontFamily:"Arial",fontSize:"64px",color:"#BBBBFF",stroke:"#000000",strokeThickness:6}).setOrigin(.5);e.tweens.add({targets:n,alpha:{from:1,to:0},y:n.y-100,scale:{from:1,to:3},duration:2e3,onComplete:function(){n.destroy()}});for(let i=0;i<t;i++){const n=i/t*Math.PI*2,o=100,a=e.add.text(player.x+Math.cos(n)*o,player.y+Math.sin(n)*o,"記憶",{fontFamily:"Arial",fontSize:"24px",color:"#DDDDFF"}).setOrigin(.5);e.tweens.add({targets:a,scale:0,alpha:0,duration:1500,delay:100*i,onComplete:function(){a.destroy()}})}window.clearAllPerkEffects(),PlayerComponentSystem.resetAll(),OnHitEffectSystem.resetAll(),OrbitalSystem.clearAll(),DropperSystem.clearAll(),PlayerHitSystem.init(e),acquiredPerks=["OBLIVION_BLOSSOM"]}};window.triggerOneTimeEffect=function(e){const t=game.scene.scenes[0];return OneTimeEffects[e]?(OneTimeEffects[e](t),!0):(console.log(`One-time effect '${e}' not found`),!1)},window.OneTimeEffects=OneTimeEffects;const OnHitEffectSystem={componentTypes:{},activeComponents:{},registerComponent:function(e,t){this.componentTypes[e]=t},addComponent:function(e,t={}){if(this.activeComponents[e]||!this.componentTypes[e])return!1;const i={...this.componentTypes[e]};return Object.assign(i,t),this.activeComponents[e]=i,i.initialize&&i.initialize(),!0},getComponent:function(e){return this.activeComponents[e]||null},removeComponent:function(e){const t=this.activeComponents[e];return!!t&&(t.cleanup&&t.cleanup(),delete this.activeComponents[e],!0)},processHit:function(e,t){Object.values(this.activeComponents).forEach((i=>{i.onHit&&i.onHit(e,t)}))},hasComponent:function(e){return!!this.activeComponents[e]},resetAll:function(){Object.keys(this.activeComponents).forEach((e=>{this.removeComponent(e)})),this.activeComponents={}}};window.createDefensiveBurst=function(e,t,i,n={}){const o={...{projectileCount:2*playerLuck,color:"#9370db",symbol:"★",speed:400,damage:playerDamage,visualEffect:!0},...n};if(o.visualEffect){const n=e.add.circle(t,i,40,9662683,.5);e.tweens.add({targets:n,alpha:0,scale:2,duration:300,onComplete:function(){n.destroy()}})}const a=[];for(let n=0;n<o.projectileCount;n++){const r=n/o.projectileCount*Math.PI*2,s=WeaponSystem.createProjectile(e,{x:t,y:i,angle:r,symbol:o.symbol,color:o.color,speed:o.speed,damage:o.damage,skipComponents:!1});s.isDefensiveBurst=!0,a.push(s)}return a},OnHitEffectSystem.registerComponent("defensiveBurst",{onHit:function(e,t){window.createDefensiveBurst(e,player.x,player.y)}});const OnHitPerkRegistry={perkEffects:{},registerPerkEffect:function(e,t){this.perkEffects[e]={componentName:t.componentName||null,configGenerator:t.configGenerator||null,condition:t.condition||null}},checkAndApplyEffects:function(){Object.entries(this.perkEffects).forEach((([e,t])=>{if(hasPerk(e)){let e=!0;if(t.condition&&(e=t.condition()),e){if(!OnHitEffectSystem.hasComponent(t.componentName)){let e={};t.configGenerator&&(e=t.configGenerator()),OnHitEffectSystem.addComponent(t.componentName,e)}}else OnHitEffectSystem.hasComponent(t.componentName)&&OnHitEffectSystem.removeComponent(t.componentName)}}))}};function handlePlayerHit(e,t){return processPlayerHit(e,t),!!window.isShieldActive()&&(window.triggerShieldHit(),e.tweens.add({targets:player,alpha:.5,scale:1.2,duration:100,yoyo:!0,repeat:1}),!0)}function processPlayerHit(e,t){OnHitEffectSystem.processHit(e,t)}function resetOnHitEffects(){OnHitEffectSystem.resetAll()}function updateOnHitEffects(){gameOver||gamePaused||OnHitPerkRegistry.checkAndApplyEffects()}OnHitPerkRegistry.registerPerkEffect("PURPLE_HEDGEHOG",{componentName:"defensiveBurst",condition:function(){return!0}}),OnHitEffectSystem.registerComponent("stormVengeanceEffect",{initialize:function(){},onHit:function(e,t){const i=playerLuck;this.createVengeanceStorm(e,i)},createVengeanceStorm:function(e,t){Date.now(),Math.random();for(let i=0;i<t;i++){const t=Math.random()*Math.PI*2,n=192*Math.random(),o=player.x+Math.cos(t)*n,a=player.y+Math.sin(t)*n;e.time.delayedCall(200*i,(function(){createLightningStrike(e,o,a,{segmentCount:4})}),[],e)}},cleanup:function(){}}),OnHitPerkRegistry.registerPerkEffect("STORM_VENGEANCE",{componentName:"stormVengeanceEffect",condition:function(){return!0}}),window.TimeDilationSystem={isActive:!1,currentTimeScale:1,playerSpeedFactor:1,enemySlowdown:1,originalPlayerSpeed:null,exitTimer:null,slowMoTween:null,isExiting:!1,initialize:function(){this.isActive=!1,this.currentTimeScale=1,this.playerSpeedFactor=1,this.enemySlowdown=1},applyMusicDilation:function(e){window.MusicSystem&&window.MusicSystem.applyTimeDilation&&window.MusicSystem.applyTimeDilation(e)},enterSlowMotion:function(e,t=null){this.slowMoTween&&this.slowMoTween.stop(),this.isExiting=!1,this.slowMoTween=e.tweens.add({targets:this,currentTimeScale:.5,playerSpeedFactor:.5,enemySlowdown:.25,duration:500,ease:"Sine.easeOut",onUpdate:()=>{e.time.timeScale=this.currentTimeScale,this.applyMusicDilation(this.currentTimeScale),EnemySystem.setEnemySpeedFactor(this.enemySlowdown),playerSpeed=basePlayerSpeed*this.playerSpeedFactor},onComplete:()=>{this.isActive=!0,null!==t&&this.setExitTimer(e,t)}})},exitSlowMotion:function(e){this.isExiting=!0,this.slowMoTween&&this.slowMoTween.stop(),this.slowMoTween=e.tweens.add({targets:this,currentTimeScale:1,playerSpeedFactor:1,enemySlowdown:1,duration:500,ease:"Sine.easeIn",onUpdate:()=>{e.time.timeScale=this.currentTimeScale,this.applyMusicDilation(this.currentTimeScale),EnemySystem.setEnemySpeedFactor(this.enemySlowdown),playerSpeed=basePlayerSpeed*this.playerSpeedFactor},onComplete:()=>{this.isActive=!1,this.isExiting=!1,EnemySystem.setEnemySpeedFactor(this.enemySlowdown),playerSpeed=basePlayerSpeed}})},setExitTimer:function(e,t){this.exitTimer&&(this.exitTimer.remove(),this.exitTimer=null);const i=t/this.currentTimeScale;this.exitTimer=e.time.addEvent({delay:i,callback:()=>{this.exitSlowMotion(e)},callbackScope:this}),registerTimer(this.exitTimer)},showVisualEffect:function(e){const t=e.add.text(player.x,player.y-40,"異世界",{fontFamily:"Arial",fontSize:"24px",color:"#00ffff",stroke:"#000000",strokeThickness:3}).setOrigin(.5);e.tweens.add({targets:t,y:t.y-30,alpha:0,scale:1.5,duration:1e3,onComplete:function(){t.destroy()}})},cleanup:function(){const e=game.scene.scenes[0];e&&(e.time.timeScale=1,EnemySystem.setEnemySpeedFactor(this.enemySlowdown),this.slowMoTween&&(this.slowMoTween.stop(),this.slowMoTween=null),this.exitTimer&&(this.exitTimer.remove(),this.exitTimer=null),this.isActive=!1,this.currentTimeScale=1,this.playerSpeedFactor=1,this.enemySlowdown=1)}},window.activateTimeDilation=function(e=null,t=!0){const i=game.scene.scenes[0];if(!i)return!1;const n=e??1e3*Math.sqrt(playerLuck/BASE_STATS.LUK);return window.TimeDilationSystem.isActive||window.TimeDilationSystem.isExiting||window.TimeDilationSystem.initialize(),window.TimeDilationSystem.isExiting?window.TimeDilationSystem.enterSlowMotion(i,n):window.TimeDilationSystem.isActive?(window.TimeDilationSystem.exitTimer&&(window.TimeDilationSystem.exitTimer.remove(),window.TimeDilationSystem.exitTimer=null),window.TimeDilationSystem.setExitTimer(i,n)):window.TimeDilationSystem.enterSlowMotion(i,n),t&&window.TimeDilationSystem.showVisualEffect(i),!0},OnHitEffectSystem.registerComponent("timeDilationEffect",{initialize:function(){},onHit:function(e,t){const i=1e3*Math.sqrt(playerLuck/BASE_STATS.LUK);window.activateTimeDilation(i)},cleanup:function(){window.TimeDilationSystem.cleanup()}}),OnHitPerkRegistry.registerPerkEffect("ALIEN_WORLD",{componentName:"timeDilationEffect",condition:function(){return!0}}),OnHitEffectSystem.registerComponent("flawlessFightEffect",{stepTimer:null,stepCount:0,maxSteps:10,stepInterval:4e3,stepSize:.05,berserkContribution:0,archerContribution:0,initialize:function(){this.berserkContribution=0,this.archerContribution=0,this.stepCount=0,this.startStepTimer()},onHit:function(e,t){this.stepCount=0,berserkMultiplier-=this.berserkContribution,archerMultiplier-=this.archerContribution,this.berserkContribution=0,this.archerContribution=0,this.restartStepTimer(e),GameUI.updateStatCircles(e)},startStepTimer:function(){const e=game.scene.scenes[0];e&&(this.clearStepTimer(),this.stepTimer=e.time.addEvent({delay:this.stepInterval,callback:this.incrementStep,callbackScope:this,loop:!0}),window.registerEffect("timer",this.stepTimer))},restartStepTimer:function(e){this.clearStepTimer(),this.startStepTimer()},clearStepTimer:function(){this.stepTimer&&(this.stepTimer.remove(),this.stepTimer=null)},incrementStep:function(){if(!gameOver&&!gamePaused&&this.stepCount<this.maxSteps){this.stepCount++,berserkMultiplier-=this.berserkContribution,archerMultiplier-=this.archerContribution,this.berserkContribution=this.stepCount*this.stepSize,this.archerContribution=this.stepCount*this.stepSize,berserkMultiplier+=this.berserkContribution,archerMultiplier+=this.archerContribution;const e=game.scene.scenes[0];if(e&&player&&player.active){const t=player.style.color||"#ffffff";e.tweens.add({targets:{value:0},value:1,duration:600,yoyo:!0,onUpdate:function(e){if(!player||!player.active)return;const i=e.getValue();let n=255,o=255,a=255;if(t.startsWith("#")){const e=t.slice(1);e.length>=6&&(n=parseInt(e.slice(0,2),16),o=parseInt(e.slice(2,4),16),a=parseInt(e.slice(4,6),16))}const r=`rgb(${Math.floor(n*(1-i)+0*i)},${Math.floor(o*(1-i)+136*i)},${Math.floor(a*(1-i)+255*i)})`;player.setColor(r)},onComplete:function(){player&&player.active&&player.setColor(t)}});GameUI.updateStatCircles(e)}}},cleanup:function(){berserkMultiplier-=this.berserkContribution,archerMultiplier-=this.archerContribution,this.clearStepTimer();const e=game.scene.scenes[0];e&&GameUI.updateStatCircles(e)}}),OnHitPerkRegistry.registerPerkEffect("FLAWLESS_FIGHT",{componentName:"flawlessFightEffect",condition:function(){return!0}}),OnHitEffectSystem.registerComponent("angerRisingEffect",{multiplierContribution:0,maxMultiplier:1,multiplierStep:.1,decayTimer:null,decayInterval:3e4,originalColor:null,initialize:function(){this.multiplierContribution=0,this.originalColor=player.style?player.style.color:"#ffffff",this.startDecayTimer()},startDecayTimer:function(){const e=game.scene.scenes[0];e&&(this.decayTimer=e.time.addEvent({delay:this.decayInterval,callback:this.decayRage,callbackScope:this,loop:!0}),window.registerEffect("timer",this.decayTimer))},decayRage:function(){if(this.multiplierContribution<=0)return;const e=game.scene.scenes[0];e&&(this.multiplierContribution-=this.multiplierStep,berserkMultiplier-=this.multiplierStep,this.multiplierContribution<0&&(berserkMultiplier-=this.multiplierContribution,this.multiplierContribution=0),this.updatePlayerColor(),GameUI.updateStatCircles(e))},onHit:function(e,t){if(this.multiplierContribution<this.maxMultiplier){if(this.multiplierContribution+=this.multiplierStep,berserkMultiplier+=this.multiplierStep,this.multiplierContribution>this.maxMultiplier){const e=this.multiplierContribution-this.maxMultiplier;this.multiplierContribution=this.maxMultiplier,berserkMultiplier-=e}e.tweens.add({targets:player,alpha:.6,scale:1.1,duration:100,yoyo:!0,onComplete:()=>{this.updatePlayerColor()}}),GameUI.updateStatCircles(e)}},updatePlayerColor:function(){if(!player||!player.active)return;if(this.multiplierContribution<=0)return void player.setColor(this.originalColor);const e=`rgb(255,${Math.floor(255-this.multiplierContribution/this.maxMultiplier*155)},${Math.floor(255-this.multiplierContribution/this.maxMultiplier*255)})`;player.setColor(e)},cleanup:function(){this.decayTimer&&(this.decayTimer.remove(),this.decayTimer=null),berserkMultiplier-=this.multiplierContribution,berserkMultiplier<1&&(berserkMultiplier=1),player&&player.active&&this.originalColor&&player.setColor(this.originalColor),this.multiplierContribution=0}}),OnHitPerkRegistry.registerPerkEffect("ANGER_RISING",{componentName:"angerRisingEffect",condition:function(){return!0}}),window.OnHitEffectSystem=OnHitEffectSystem,window.OnHitPerkRegistry=OnHitPerkRegistry,window.handlePlayerHit=handlePlayerHit,window.processPlayerHit=processPlayerHit,window.resetOnHitEffects=resetOnHitEffects,window.updateOnHitEffects=updateOnHitEffects;const orbitals=[],MovementPatterns={standard:function(e,t){e.angle+=e.speed*("clockwise"===e.direction?1:-1);const i=player.x+Math.cos(e.angle)*e.radius,n=player.y+Math.sin(e.angle)*e.radius;e.entity.setPosition(i,n)},elliptical:function(e,t){e.angle+=e.speed*("clockwise"===e.direction?1:-1);const i=e.options.stretchX??1.5,n=e.options.stretchY??1,o=player.x+Math.cos(e.angle)*e.radius*i,a=player.y+Math.sin(e.angle)*e.radius*n;e.entity.setPosition(o,a)},figureEight:function(e,t){e.angle+=e.speed*("clockwise"===e.direction?1:-1);const i=e.radius,n=e.angle,o=1+Math.sin(n)*Math.sin(n),a=player.x+i*Math.cos(n)/o,r=player.y+i*Math.sin(n)*Math.cos(n)/o;e.entity.setPosition(a,r)},spiral:function(e,t){e.angle+=e.speed*("clockwise"===e.direction?1:-1);const i=e.options.pulseSpeed??.02,n=e.options.minRadius??.5*e.radius,o=e.options.maxRadius??1.5*e.radius,a=n+(Math.sin(t*i)+1)/2*(o-n),r=player.x+Math.cos(e.angle)*a,s=player.y+Math.sin(e.angle)*a;e.entity.setPosition(r,s)},oscillating:function(e,t){e.angle+=e.speed*("clockwise"===e.direction?1:-1);const i=e.options.wobbleFrequency??5,n=e.options.wobbleAmplitude??.2*e.radius,o=e.radius+Math.sin(e.angle*i)*n,a=player.x+Math.cos(e.angle)*o,r=player.y+Math.sin(e.angle)*o;e.entity.setPosition(a,r)},directionFollowing:function(e,t){if(!player||!player.body||!player.active)return;const i=player.body.velocity;if(Math.sqrt(i.x*i.x+i.y*i.y)>10){const t=Math.atan2(i.y,i.x);void 0===e.lastAngle&&(e.lastAngle=t);const n=e.lastAngle%(2*Math.PI),o=t%(2*Math.PI),a=n>=0?n:n+2*Math.PI,r=o>=0?o:o+2*Math.PI,s=r<=a?r+2*Math.PI-a:r-a,l=r>=a?a+2*Math.PI-r:a-r;let c=s<=l?s:-l;e.lastAngle+=c*e.speed,e.lastAngle=e.lastAngle%(2*Math.PI),e.angle=e.lastAngle}const n=e.options.oscillationSpeed??.002,o=e.options.oscillationAmount??20,a=Math.sin(t*n)*o,r=e.radius+a,s=player.x+Math.cos(e.angle)*r,l=player.y+Math.sin(e.angle)*r;e.entity.setPosition(s,l),e.entity.setAngle(180*e.angle/Math.PI)}};function processOrbitalComponentEvent(e,t,i,n){t.entity&&t.entity.components&&Object.values(t.entity.components).forEach((o=>{o[n]&&o[n](t.entity,i,e)}))}const CollisionBehaviors={persistent:function(e,t,i){processOrbitalComponentEvent(e,t,i,"onHit"),applyContactDamage.call(e,t.entity,i,t.entity.damage,t.damageInterval)},projectile:function(e,t,i){processOrbitalComponentEvent(e,t,i,"onHit"),applyContactDamage.call(e,t.entity,i,t.entity.damage,0),destroyOrbital(t)},explosive:function(e,t,i){processOrbitalComponentEvent(e,t,i,"onHit");const n=i.x,o=i.y,a=t.options.blastRadius??128,r=`orbital_explosion_${Date.now()}_${Math.random()}`;EnemySystem.enemiesGroup.getChildren().forEach((i=>{if(!i.active)return;const s=i.x-n,l=i.y-o;if(Math.sqrt(s*s+l*l)<=a){const n=`${r}_${i.x}_${i.y}`;applyContactDamage.call(e,{damageSourceId:n,damage:t.entity.damage,active:!0},i,t.entity.damage,0)}}));const s=VisualEffects.convertToColorValue(t.entity.style.color);VisualEffects.createExplosion(e,n,o,a,s,{startScale:.2}),destroyOrbital(t)}};function destroyOrbital(e){if(e.entity&&e.entity.active){if(e.entity.components){const t=game.scene.scenes[0];t&&Object.values(e.entity.components).forEach((i=>{i.onDestroy&&i.onDestroy(e.entity,t)}))}e.entity.destroy()}e.destroyed=!0}const OrbitalSystem={init:function(){this.clearAll(),console.log("Orbital system initialized")},create:function(e,t){const i={...{symbol:"★",color:"#ffff00",fontSize:32,radius:80,angle:Math.random()*Math.PI*2,speed:.02,direction:"clockwise",pattern:"standard",collisionType:"persistent",damage:playerDamage,damageInterval:500,colliderSize:.8,lifespan:null,options:{}},...t},n=e.add.text(player.x+Math.cos(i.angle)*i.radius,player.y+Math.sin(i.angle)*i.radius,i.symbol,{fontFamily:"Arial",fontSize:`${i.fontSize}px`,color:i.color,fontStyle:"bold"}).setOrigin(.5);e.physics.world.enable(n),n.body.setSize(n.width*i.colliderSize,n.height*i.colliderSize),n.damageSourceId=`orbital_${Date.now()}_${Math.random()}`,n.damage=i.damage,i.options&&i.options.components&&(n.components={},i.options.components.forEach((e=>{e.name&&ProjectileComponentSystem.componentTypes[e.name]&&ProjectileComponentSystem.addComponent(n,e.name,e.config||{})})));const o={entity:n,radius:i.radius,angle:i.angle,speed:i.speed,direction:i.direction,pattern:i.pattern,collisionType:i.collisionType,damageInterval:i.damageInterval,createdAt:e.time.now,lifespan:i.lifespan,options:i.options,lastUpdate:0,destroyed:!1};orbitals.push(o),window.registerEffect("entity",n);const a=CollisionBehaviors[i.collisionType]??CollisionBehaviors.persistent;if(e.physics.add.overlap(n,EnemySystem.enemiesGroup,(function(t,i){o.destroyed||a(e,o,i)}),null,e),e.tweens.add({targets:n,scale:{from:0,to:1},duration:500,ease:"Back.out"}),null!==o.lifespan){const t=e.time.delayedCall(o.lifespan,(function(){e.tweens.add({targets:n,alpha:0,scale:0,duration:300,onComplete:function(){destroyOrbital(o)}})}));window.registerEffect("timer",t)}return o},update:function(e,t){gameOver||gamePaused||0===orbitals.length||(orbitals.forEach((e=>{if(e.destroyed||!e.entity||!e.entity.active)return;(MovementPatterns[e.pattern]??MovementPatterns.standard)(e,t),e.lastUpdate=t})),this.cleanupInactive())},cleanupInactive:function(){for(let e=orbitals.length-1;e>=0;e--){const t=orbitals[e];!t.destroyed&&t.entity&&t.entity.active||orbitals.splice(e,1)}},clearAll:function(){orbitals.forEach((e=>{e.firingTimer&&(CooldownManager.removeTimer(e.firingTimer),e.firingTimer=null),e.entity&&e.entity.active&&e.entity.destroy()})),orbitals.length=0},getAll:function(){return orbitals.filter((e=>!e.destroyed&&e.entity&&e.entity.active))},getCount:function(){return this.getAll().length},createMultiple:function(e,t,i){const n=[];for(let o=0;o<t;o++){const a={...i,angle:o/t*Math.PI*2},r=this.create(e,a);n.push(r)}return n}};window.OrbitalSystem=OrbitalSystem;const PauseSystem={elements:{pauseScreen:null,resumeButton:null,pauseMessage:null,perkIcons:[],paginationControls:[],activePerkCard:null,pausePerksContainer:null,statsContainer:null,statCircles:[]},currentPerkPage:0,isInitialized:!1,init:function(e){if(!e||!e.add)return void console.error("Cannot initialize PauseSystem: Invalid scene provided");this.createPauseScreen(e);e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.P).on("down",(function(){gameOver||(gamePaused?PauseSystem.resumeGame():PauseSystem.pauseGameWithOverlay())})),document.addEventListener("visibilitychange",(function(){!document.hidden||gameOver||gamePaused||PauseSystem.pauseGameWithOverlay()})),this.isInitialized=!0,console.log("Pause system initialized successfully")},createPauseScreen:function(e){if(!e||!e.add)return void console.error("Cannot create pause screen: Invalid scene");const t=game.config.width/2,i=game.config.height/2;this.elements.pauseScreen=e.add.rectangle(t,i,game.config.width,game.config.height,0,.7),this.elements.pauseScreen.setVisible(!1),this.elements.pauseScreen.setDepth(1e3),this.elements.pauseMessage=e.add.text(t,.125*game.config.height,"GAME PAUSED",{fontFamily:"Arial",fontSize:"40px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),this.elements.pauseMessage.setVisible(!1),this.elements.pauseMessage.setDepth(1001),this.elements.resumeButton=e.add.text(t,.875*game.config.height,"RESUME GAME",{fontFamily:"Arial",fontSize:"36px",color:"#ffffff",backgroundColor:"#008800",padding:{left:15,right:15,top:10,bottom:10}}).setOrigin(.5),this.elements.resumeButton.setVisible(!1),this.elements.resumeButton.setDepth(1001),this.elements.resumeButton.setInteractive(),this.elements.resumeButton.on("pointerdown",(function(){PauseSystem.resumeGame()})),this.elements.resumeButton.on("pointerover",(function(){this.setStyle({backgroundColor:"#00aa00"})})),this.elements.resumeButton.on("pointerout",(function(){this.setStyle({backgroundColor:"#008800"})})),this.elements.pausePerksContainer=e.add.container(0,0),this.elements.pausePerksContainer.setDepth(1001),this.elements.pausePerksContainer.setVisible(!1),this.elements.statsContainer=e.add.container(0,0),this.elements.statsContainer.setDepth(1001),this.elements.statsContainer.setVisible(!1);const n=KAJISULI_MODE?.32*game.config.height:.25*game.config.height,o=e.add.text(t,n,"MY PERKS",{fontFamily:"Arial",fontSize:"32px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5);this.elements.pausePerksContainer.add(o),console.log("Pause screen elements created successfully")},ensureInitialized:function(){if(!this.isInitialized||!this.elements.pauseScreen){console.warn("PauseSystem not fully initialized, attempting to initialize now");const e=game.scene.scenes[0];if(!e)return console.error("Cannot initialize PauseSystem: No active scene available"),!1;this.init(e)}return!0},pauseGame:function(e=!1){gamePaused=!0;const t=game.scene.scenes[0];t&&t.physics&&t.physics.pause(),t.tweens&&t.tweens.pauseAll(),gameTimers.forEach((e=>{e&&void 0!==e.paused&&(e.paused=!0)})),activeEffects.timers.forEach((e=>{e&&void 0!==e.paused&&(e.paused=!0)})),window.MusicSystem&&window.MusicSystem.onGamePause()},resumeGame:function(){if(gameOver)return;if(levelUpCards&&levelUpCards.length>0)return void console.log("Cannot resume, level up screen is active");gamePaused=!1;const e=game.scene.scenes[0];e&&e.physics&&e.physics.resume(),e.tweens&&e.tweens.resumeAll(),gameTimers.forEach((e=>{e&&void 0!==e.paused&&(e.paused=!1)})),activeEffects.timers.forEach((e=>{e&&void 0!==e.paused&&(e.paused=!1)})),window.MusicSystem&&window.MusicSystem.onGameResume(),this.elements.pauseScreen&&(this.elements.pauseScreen.setVisible(!1),this.elements.pauseMessage.setVisible(!1),this.elements.resumeButton.setVisible(!1),this.elements.pausePerksContainer&&this.elements.pausePerksContainer.setVisible(!1),this.elements.statsContainer&&this.elements.statsContainer.setVisible(!1),console.log("Game resumed"))},pauseGameWithOverlay:function(){if(gameOver)return;if(!this.elements.pauseScreen){console.warn("Pause UI elements not initialized, recreating...");const e=game.scene.scenes[0];if(!e)return void console.error("Cannot access scene to create pause elements");this.createPauseScreen(e)}this.pauseGame(),this.elements.pauseScreen.setVisible(!0),this.elements.pauseMessage.setVisible(!0),this.elements.resumeButton.setVisible(!0);const e=game.scene.scenes[0];e&&(KAJISULI_MODE&&this.showStatsDisplay(e),this.updatePauseScreenPerks(e)),console.log("Game paused with overlay")},showStatsDisplay:function(e,t={}){const i={container:t.container??this.elements.statsContainer,positionY:t.positionY??.2*game.config.height,storeInElements:t.storeInElements??!0,clearContainer:t.clearContainer??!0,setVisible:t.setVisible??!0,fontSize:t.fontSize??"24px"};i.clearContainer&&i.container&&i.container.removeAll(!0);const n=[{symbol:UI.statDisplay.symbols.POW,value:getEffectiveDamage(),color:UI.statDisplay.symbolColors.POW},{symbol:UI.statDisplay.symbols.AGI,value:getEffectiveFireRate(),color:UI.statDisplay.symbolColors.AGI},{symbol:UI.statDisplay.symbols.LUK,value:playerLuck,color:UI.statDisplay.symbolColors.LUK},{symbol:UI.statDisplay.symbols.END,value:maxPlayerHealth,color:UI.statDisplay.symbolColors.END}],o=game.config.width/2,a=i.positionY;i.container===this.elements.statsContainer&&(i.container.setPosition(0,0),i.setVisible&&i.container.setVisible(!0));const r=.15*game.config.width,s=.05*game.config.height,l=.06*game.config.width,c=o-(r*n.length+l*(n.length-1))/2+r/2,d=[];return n.forEach(((t,n)=>{const o=c+(l+r)*n,m=e.add.rectangle(o,a,r,s,UI.colors.gold),u=e.add.rectangle(o,a,r-4,s-4,0),h=e.add.text(o,a,`${t.symbol} ${Math.floor(t.value)}`,{fontFamily:"Arial",fontSize:i.fontSize,color:t.color,fontStyle:"bold"}).setOrigin(.5),p={border:m,background:u,statText:h};d.push(p),i.container&&i.container.add([m,u,h])})),d},updatePauseScreenPerks:function(e){if(!this.elements.pausePerksContainer)return void console.warn("Pause perks container not initialized");const t=game.config.width/2;if(this.elements.perkIcons&&this.elements.perkIcons.forEach((e=>{e&&e.destroy&&e.destroy()})),this.elements.perkIcons=[],this.elements.activePerkCard&&(this.elements.activePerkCard.forEach((e=>{e&&e.destroy&&e.destroy()})),this.elements.activePerkCard=null),this.elements.paginationControls&&this.elements.paginationControls.forEach((e=>{e&&e.destroy&&e.destroy()})),this.elements.paginationControls=[],this.elements.pausePerksContainer.setVisible(!0),0===acquiredPerks.length){const i=e.add.text(t,.4375*game.config.height,"No perks acquired yet",{fontFamily:"Arial",fontSize:"20px",color:"#aaaaaa"}).setOrigin(.5);return this.elements.perkIcons.push(i),void this.elements.pausePerksContainer.add(i)}const i=[];acquiredPerks.forEach((t=>{const n=PERKS[t];if(!n)return;const o=e.add.text(0,0,n.kanji,{fontFamily:"Arial",fontSize:"32px",fontStyle:"bold"});i.push({perkId:t,width:o.width}),o.destroy()}));const n=KAJISULI_MODE?4:8,o=n*(KAJISULI_MODE?5:4),a=.04*game.config.width,r=.075*game.config.height,s=KAJISULI_MODE?.4*game.config.height:.35*game.config.height,l=Math.ceil(i.length/o);this.currentPerkPage=Math.min(this.currentPerkPage,l-1),this.currentPerkPage=Math.max(0,this.currentPerkPage);const c=this.currentPerkPage*o,d=i.slice(c,c+o),m=[];for(let e=0;e<d.length;e+=n)m.push(d.slice(e,e+n));if(m.forEach(((i,n)=>{const o=i.reduce(((e,t)=>e+t.width),0)+a*(i.length-1);let l=t-o/2;const c=s+n*r;i.forEach((t=>{const i=t.perkId,n=PERKS[i],o=l+t.width/2,r=e.add.text(o,c,n.kanji,{fontFamily:"Arial",fontSize:"32px",color:n.color,fontStyle:"bold",stroke:"#000000",strokeThickness:4}).setOrigin(.5);r.setInteractive({useHandCursor:!0}),r.on("pointerover",(function(){this.setScale(1.2);const t=KAJISULI_MODE?Math.min(c+.15*game.config.height,.7*game.config.height):c+.1875*game.config.height;PauseSystem.showPerkCard(e,i,o,t)})),r.on("pointerout",(function(){this.setScale(1),PauseSystem.hidePerkCard(e)})),this.elements.perkIcons.push(r),this.elements.pausePerksContainer.add(r),l+=t.width+a}))})),l>1){const i=KAJISULI_MODE?.8*game.config.height:.725*game.config.height;if(this.currentPerkPage>0){const n=e.add.text(t-.15*game.config.width,i,"◀",{fontFamily:"Arial",fontSize:"48px",color:"#ffffff"}).setOrigin(.5);n.setInteractive({useHandCursor:!0}),n.on("pointerdown",(()=>{this.currentPerkPage--,this.updatePauseScreenPerks(e)})),n.on("pointerover",(function(){this.setColor("#aaffaa"),this.setScale(1.2)})),n.on("pointerout",(function(){this.setColor("#ffffff"),this.setScale(1)})),this.elements.paginationControls.push(n),this.elements.pausePerksContainer.add(n)}const n=e.add.text(t,i,`${this.currentPerkPage+1}/${l}`,{fontFamily:"Arial",fontSize:"40px",color:"#ffffff"}).setOrigin(.5);if(this.elements.paginationControls.push(n),this.elements.pausePerksContainer.add(n),this.currentPerkPage<l-1){const n=e.add.text(t+.15*game.config.width,i,"▶",{fontFamily:"Arial",fontSize:"48px",color:"#ffffff"}).setOrigin(.5);n.setInteractive({useHandCursor:!0}),n.on("pointerdown",(()=>{this.currentPerkPage++,this.updatePauseScreenPerks(e)})),n.on("pointerover",(function(){this.setColor("#aaffaa"),this.setScale(1.2)})),n.on("pointerout",(function(){this.setColor("#ffffff"),this.setScale(1)})),this.elements.paginationControls.push(n),this.elements.pausePerksContainer.add(n)}}},showPerkCard:function(e,t,i,n){this.hidePerkCard(e),this.elements.activePerkCard=window.CardSystem.createPerkCard(t,i,n,{container:this.elements.pausePerksContainer,backgroundColor:3355443,strokeWidth:3,strokeColor:15658734,scale:KAJISULI_MODE?.85:1})},hidePerkCard:function(e){this.elements.activePerkCard&&(this.elements.activePerkCard.forEach((e=>{e&&e.destroy&&e.destroy()})),this.elements.activePerkCard=null)},cleanup:function(){Object.values(this.elements).forEach((e=>{e&&e.destroy?e.destroy():Array.isArray(e)&&e.forEach((e=>{e&&e.destroy&&e.destroy()}))})),this.elements={pauseScreen:null,resumeButton:null,pauseMessage:null,perkIcons:[],paginationControls:[],activePerkCard:null,pausePerksContainer:null,statsContainer:null},this.currentPerkPage=0,this.isInitialized=!1}};window.PauseSystem=PauseSystem;const PERKS={RED_DRAGON:{kanji:"赤竜",kana:"あかりゅう",romaji:"akaryuu",english:"Red Dragon",description:"+2 POW / -1 AGI",color:"#ff3333",hoverColor:12263970,onAcquire:function(){window.modifyStat("damage",2),window.modifyStat("fireRate",-1)}},BLUE_WHALE:{kanji:"青鯨",kana:"あおくじら",romaji:"aokujira",english:"Blue Whale",description:"Permanent Protection",color:"#3498db",hoverColor:2719929,onAcquire:function(){}},FATED_SHIELD:{kanji:"運命の盾",kana:"うんめいのたて",romaji:"unmeinotate",english:"Fated Shield",description:"Auto Shield when at 1 HP",color:"#FF5555",hoverColor:14496563,onAcquire:function(){}},BLOOMING_FLOWER:{kanji:"花咲く",kana:"はなさく",romaji:"hanasaku",english:"Blooming Flower",description:"This flower attacks nearby enemies",color:"#FF66AA",hoverColor:14501e3,onAcquire:function(){window.activateBloomingFlower()}},TEAL_OCTOPUS:{kanji:"青緑蛸",kana:"あおみどりたこ",romaji:"aomidoritako",english:"Teal Octopus",description:"Gain orbiting projectiles",color:"#008080",hoverColor:24415,onAcquire:function(){window.activateOrbitingProjectile()}},INVERTED_OCTOPUS:{kanji:"逆蛸",kana:"ぎゃくたこ",romaji:"gyakutako",english:"Inverted Octopus",description:"More orbiting projectiles",color:"#FF55FF",hoverColor:14496733,onAcquire:function(){window.activateInvertedOctopus()}},TENTACLE_GRASP:{kanji:"触手",kana:"しょくしゅ",romaji:"shokushu",english:"Tentacle Grasp",description:"Tentacles extend in all directions",color:"#8800AA",hoverColor:6684808,onAcquire:function(){window.activateTentacleGrasp()}},GLASS_CANNON:{kanji:"硝子砲",kana:"がらすほう",romaji:"garasuhou",english:"Glass Cannon",description:"+5 POW / END reduced to 1",color:"#FF0000",hoverColor:14483456,onAcquire:function(){window.modifyStat("damage",5),window.modifyStat("health",-999)}},DEATH_FINGER:{kanji:"死指",kana:"しゆび",romaji:"shiyubi",english:"Death Finger",description:"Point and deal damage",color:"#FF0000",hoverColor:14483456,onAcquire:function(){window.activateDeathFinger()}},HEALING_FAIRY:{kanji:"癒精",kana:"いやせい",romaji:"iyasei",english:"Healing Fairy",description:"Protect her and stay close",color:"#7FFF7F",hoverColor:6283103,onAcquire:function(){window.activateHealingFairy()}},WRECKING_BALL:{kanji:"破球",kana:"はきゅう",romaji:"hakyuu",english:"Wrecking Ball",description:"Orbits and explodes",color:"#777777",hoverColor:5592405,onAcquire:function(){window.activateWreckingBall()}},GOLD_FORTRESS:{kanji:"金城",kana:"きんじょう",romaji:"kinjou",english:"Gold Fortress",description:"-1 POW / -1 AGI / -1 LUK / +5 END",color:"#FFD700",hoverColor:12092939,onAcquire:function(){window.modifyStat("damage",-1),window.modifyStat("fireRate",-1),window.modifyStat("luck",-1),window.modifyStat("health",5)}},DENIAL_OF_FATE:{kanji:"運命否定",kana:"うんめいひてい",romaji:"unmeihitei",english:"Denial of Fate",description:"+3 POW / +3 AGI / -5 LUK",color:"#ff6600",hoverColor:14500864,onAcquire:function(){window.modifyStat("damage",2),window.modifyStat("fireRate",2),window.modifyStat("luck",-3)}},AMBER_BEETLE:{kanji:"琥珀甲虫",kana:"こはくこうちゅう",romaji:"kohakukouchuu",english:"Amber Beetle",description:"Drops projectiles that damage enemies",color:"#ffbf00",hoverColor:12291072,onAcquire:function(){window.activateLandmines()}},SNIPER_FAIRY:{kanji:"狙撃精",kana:"そげきせい",romaji:"sogeikisei",english:"Sniper Fairy",description:"A fairy with slow but powerful long range shots",color:"#FF55AA",hoverColor:14496648,onAcquire:function(){window.activateSniperFairy()}},WILD_FAIRY:{kanji:"野妖精",kana:"のようせい",romaji:"noyousei",english:"Wild Fairy",description:"This erratic fairy orbits at high speed and damages enemies",color:"#FF66CC",hoverColor:14501034,onAcquire:function(){window.activateWildFairy(),window.modifyStat("luck",1)}},ANGEL_HONEY:{kanji:"天蜜",kana:"てんみつ",romaji:"tenmitsu",english:"Angel Honey",description:"Periodically spawns honey for a full heal",color:"#00CC00",hoverColor:43520,onAcquire:function(){}},SUSHI:{kanji:"寿司",kana:"すし",romaji:"sushi",english:"Sushi",description:"+1 END, full heal",color:"#FFFFFF",hoverColor:14737632,onAcquire:function(){window.modifyStat("health",1),window.fullHeal()}},RAMEN:{kanji:"拉麺",kana:"ラーメン",romaji:"raamen",english:"Ramen",description:"+1 END and temporary shield",color:"#FFA07A",hoverColor:14518374,onAcquire:function(){window.modifyStat("health",1),ShieldSystem.activateShield()}},ONIGIRI:{kanji:"御握り",kana:"おにぎり",romaji:"onigiri",english:"Rice Ball",description:"+1 END and fully heals",color:"#F5F5DC",hoverColor:15066572,onAcquire:function(){window.modifyStat("health",1),window.fullHeal()}},MOCHI:{kanji:"餅",kana:"もち",romaji:"mochi",english:"Rice Cake",description:"+1 END and fully heals",color:"#FFE4E1",hoverColor:15652049,onAcquire:function(){window.modifyStat("health",1),window.fullHeal()}},DANGO:{kanji:"団子",kana:"だんご",romaji:"dango",english:"Dumpling",description:"+1 END and fully heals",color:"#F0E68C",hoverColor:14734972,onAcquire:function(){window.modifyStat("health",1),window.fullHeal()}},TEMPURA:{kanji:"天ぷら",kana:"てんぷら",romaji:"tenpura",english:"Tempura",description:"+1 END and fully heals",color:"#FFD700",hoverColor:15648512,onAcquire:function(){window.modifyStat("health",1),window.fullHeal()}},UDON:{kanji:"饂飩",kana:"うどん",romaji:"udon",english:"Udon Noodles",description:"+1 END and fully heals",color:"#FAEBD7",hoverColor:15391687,onAcquire:function(){window.modifyStat("health",1),window.fullHeal()}},YAKITORI:{kanji:"焼鳥",kana:"やきとり",romaji:"yakitori",english:"Grilled Chicken",description:"+1 END and fully heals",color:"#CD853F",hoverColor:12416303,onAcquire:function(){window.modifyStat("health",1),window.fullHeal()}},TAKOYAKI:{kanji:"蛸焼き",kana:"たこやき",romaji:"takoyaki",english:"Octopus Balls",description:"+1 END and fully heals",color:"#8B4513",hoverColor:8074499,onAcquire:function(){window.modifyStat("health",1),window.fullHeal()}},GYOZA:{kanji:"餃子",kana:"ぎょうざ",romaji:"gyouza",english:"Dumplings",description:"+1 END and fully heals",color:"#D3D3D3",hoverColor:12829635,onAcquire:function(){window.modifyStat("health",1),window.fullHeal()}},TAIYAKI:{kanji:"鯛焼き",kana:"たいやき",romaji:"taiyaki",english:"Fish-shaped Cake",description:"+1 END and fully heals",color:"#DEB887",hoverColor:13543543,onAcquire:function(){window.modifyStat("health",1),window.fullHeal()}},BENTO:{kanji:"弁当",kana:"べんとう",romaji:"bentou",english:"Lunch Box",description:"+1 END and fully heals",color:"#FF6347",hoverColor:15684407,onAcquire:function(){window.modifyStat("health",1),window.fullHeal()}},GREEN_VENOM:{kanji:"緑毒",kana:"みどりどく",romaji:"midoridoku",english:"Green Venom",description:"Poisonous projectiles deal damage over time",color:"#2aad27",hoverColor:1740055,onAcquire:function(){}},AZURE_FORK:{kanji:"蒼の叉",kana:"あおのまた",romaji:"aonomata",english:"Azure Fork",description:"Chance to split in two when hitting enemies",color:"#1E90FF",hoverColor:28893,onAcquire:function(){}},POISON_FLOWER:{kanji:"毒花",kana:"どくばな",romaji:"dokubana",english:"Poison Flower",description:"This flower pulses poison, damaging enemies over time",color:"#2aad27",hoverColor:1740055,onAcquire:function(){window.activatePoisonFlower()}},COLD_FLOWER:{kanji:"冷花",kana:"れいばな",romaji:"reibana",english:"Frost Flower",description:"This flower slows down enemies",color:"#00ffff",hoverColor:56797,onAcquire:function(){window.activateColdFlower()}},BRIGHT_LANCE:{kanji:"光槍",kana:"こうそう",romaji:"kousou",english:"Bright Lance",description:"A glowing lance that follows your movement direction",color:"#FFFF33",hoverColor:14540032,onAcquire:function(){window.activateBrightLance()}},LAVA_FAIRIES:{kanji:"溶岩精",kana:"ようがんせい",romaji:"yougansei",english:"Lava Fairies",description:"On death, they drop magma that damages enemies",color:"#FF6600",hoverColor:14500864,onAcquire:function(){window.activateLavaFairies()}},TOXIC_TRAIL:{kanji:"毒痕",kana:"どくあと",romaji:"dokuato",english:"Toxic Trail",description:"A path of shared sickness",color:"#33cc33",hoverColor:2271778,onAcquire:function(){window.activateToxicTrail(),window.modifyStat("health",-1),window.modifyStat("damage",-1),window.modifyStat("fireRate",-1),window.modifyStat("luck",-1)}},FINGER_OF_DECAY:{kanji:"朽指",kana:"くちゆび",romaji:"kuchiyubi",english:"Finger of Decay",description:"Point and deal poison",color:"#88AA22",hoverColor:6719488,onAcquire:function(){window.activateFingerOfDecay()}},STORM_CALLER:{kanji:"雷神",kana:"らいじん",romaji:"raijin",english:"Storm Caller",description:"Lightning strikes your enemies",color:"#FFDD00",hoverColor:14531328,onAcquire:function(){window.activateStormCaller()}},STORM_BRINGER:{kanji:"雷招",kana:"らいまねき",romaji:"raimaneki",english:"Storm Bringer",description:"Beacons bring down lightning",color:"#00DDFF",hoverColor:48093,onAcquire:function(){}},STORM_VENGEANCE:{kanji:"雷怨",kana:"らいえん",romaji:"raien",english:"Storm Vengeance",description:"Lightning strikes back after a hit",color:"#FFAAFF",hoverColor:14518493,onAcquire:function(){}},SCARLET_EMBER:{kanji:"緋炎",kana:"ひえん",romaji:"hien",english:"Scarlet Ember",description:"Fires burn enemies over time",color:"#FF4500",hoverColor:13383424,onAcquire:function(){}},RED_TIGER:{kanji:"赤虎",kana:"あかとら",romaji:"akatora",english:"Red Tiger",description:"+1 POW",color:"#ff3333",hoverColor:12263970,onAcquire:function(){window.modifyStat("damage",1)}},RED_HAWK:{kanji:"赤鷹",kana:"あかたか",romaji:"akataka",english:"Red Hawk",description:"+1 POW / +1 AGI",color:"#ff3333",hoverColor:12263970,onAcquire:function(){window.modifyStat("damage",1),window.modifyStat("fireRate",1)}},RED_BEAR:{kanji:"赤熊",kana:"あかくま",romaji:"akakuma",english:"Red Bear",description:"+2 POW / -1 AGI",color:"#ff3333",hoverColor:12263970,onAcquire:function(){window.modifyStat("damage",2),window.modifyStat("fireRate",-1)}},RED_SCORPION:{kanji:"赤蠍",kana:"あかさそり",romaji:"akasasori",english:"Red Scorpion",description:"+2 POW / -1 LUK",color:"#ff3333",hoverColor:12263970,onAcquire:function(){window.modifyStat("damage",2),window.modifyStat("luck",-1)}},RED_FOX:{kanji:"赤狐",kana:"あかきつね",romaji:"akakitsune",english:"Red Fox",description:"+1 POW / +1 LUK",color:"#ff3333",hoverColor:12263970,onAcquire:function(){window.modifyStat("damage",1),window.modifyStat("luck",1)}},RED_WOLF:{kanji:"赤狼",kana:"あかおおかみ",romaji:"akaookami",english:"Red Wolf",description:"+1 POW",color:"#ff3333",hoverColor:12263970,onAcquire:function(){window.modifyStat("damage",1)}},RED_SNAKE:{kanji:"赤蛇",kana:"あかへび",romaji:"akahebi",english:"Red Snake",description:"+1 POW",color:"#ff3333",hoverColor:12263970,onAcquire:function(){window.modifyStat("damage",1)}},RED_MANTIS:{kanji:"赤蟷螂",kana:"あかかまきり",romaji:"akakamakiri",english:"Red Mantis",description:"+1 POW",color:"#ff3333",hoverColor:12263970,onAcquire:function(){window.modifyStat("damage",1)}},RED_LION:{kanji:"赤獅子",kana:"あかしし",romaji:"akashishi",english:"Red Lion",description:"+1 POW",color:"#ff3333",hoverColor:12263970,onAcquire:function(){window.modifyStat("damage",1)}},RED_FALCON:{kanji:"赤隼",kana:"あかはやぶさ",romaji:"akahayabusa",english:"Red Falcon",description:"+1 POW",color:"#ff3333",hoverColor:12263970,onAcquire:function(){window.modifyStat("damage",1)}},YELLOW_CHEETAH:{kanji:"黄豹",kana:"きひょう",romaji:"kihyou",english:"Yellow Cheetah",description:"+1 AGI",color:"#ffd700",hoverColor:13412096,onAcquire:function(){window.modifyStat("fireRate",1)}},YELLOW_HUMMINGBIRD:{kanji:"黄蜂鳥",kana:"きはちどり",romaji:"kihachidori",english:"Yellow Hummingbird",description:"+4 AGI / -2 POW",color:"#ffd700",hoverColor:13412096,onAcquire:function(){window.modifyStat("fireRate",4),window.modifyStat("damage",-2)}},YELLOW_WASP:{kanji:"黄蜂",kana:"きばち",romaji:"kibachi",english:"Yellow Wasp",description:"+2 AGI / -2 END",color:"#ffd700",hoverColor:13412096,onAcquire:function(){window.modifyStat("fireRate",2),window.modifyStat("health",-2)}},YELLOW_JACKAL:{kanji:"黄豺",kana:"きやまいぬ",romaji:"kiyamainu",english:"Yellow Jackal",description:"+3 AGI / -1 POW / -1 END",color:"#ffd700",hoverColor:13412096,onAcquire:function(){window.modifyStat("fireRate",3),window.modifyStat("damage",-1),window.modifyStat("health",-1)}},YELLOW_CANARY:{kanji:"黄鳥",kana:"きどり",romaji:"kidori",english:"Yellow Canary",description:"+1 AGI",color:"#ffd700",hoverColor:13412096,onAcquire:function(){window.modifyStat("fireRate",1)}},YELLOW_HORNET:{kanji:"黄雀蜂",kana:"きすずめばち",romaji:"kisuzumebachi",english:"Yellow Hornet",description:"+1 AGI",color:"#ffd700",hoverColor:13412096,onAcquire:function(){window.modifyStat("fireRate",1)}},YELLOW_BEE:{kanji:"黄蜜蜂",kana:"きみつばち",romaji:"kimitsubachi",english:"Yellow Bee",description:"+1 AGI",color:"#ffd700",hoverColor:13412096,onAcquire:function(){window.modifyStat("fireRate",1)}},YELLOW_FINCH:{kanji:"黄雀",kana:"きひわ",romaji:"kihiwa",english:"Yellow Finch",description:"+1 AGI",color:"#ffd700",hoverColor:13412096,onAcquire:function(){window.modifyStat("fireRate",1)}},YELLOW_SQUIRREL:{kanji:"黄栗鼠",kana:"きりす",romaji:"kirisu",english:"Yellow Squirrel",description:"+1 AGI",color:"#ffd700",hoverColor:13412096,onAcquire:function(){window.modifyStat("fireRate",1)}},YELLOW_CICADA:{kanji:"黄蝉",kana:"きせみ",romaji:"kisemi",english:"Yellow Cicada",description:"+1 AGI",color:"#ffd700",hoverColor:13412096,onAcquire:function(){window.modifyStat("fireRate",1)}},YELLOW_CRICKET:{kanji:"黄蟋蟀",kana:"きこおろぎ",romaji:"kikoorogi",english:"Yellow Cricket",description:"+1 AGI",color:"#ffd700",hoverColor:13412096,onAcquire:function(){window.modifyStat("fireRate",1)}},PURPLE_MONKEY:{kanji:"紫猿",kana:"むらさきざる",romaji:"murasakizaru",english:"Purple Monkey",description:"+1 LUK",color:"#9370db",hoverColor:7557307,onAcquire:function(){window.modifyStat("luck",1)}},PURPLE_CAT:{kanji:"紫猫",kana:"むらさきねこ",romaji:"murasakineko",english:"Purple Cat",description:"+1 LUK",color:"#9370db",hoverColor:7557307,onAcquire:function(){window.modifyStat("luck",1)}},PURPLE_BUTTERFLY:{kanji:"紫蝶",kana:"むらさきちょう",romaji:"murasakichou",english:"Purple Butterfly",description:"+1 LUK",color:"#9370db",hoverColor:7557307,onAcquire:function(){window.modifyStat("luck",1)}},PURPLE_RABBIT:{kanji:"紫兎",kana:"むらさきうさぎ",romaji:"murasakiusagi",english:"Purple Rabbit",description:"+2 LUK / -1 END",color:"#9370db",hoverColor:7557307,onAcquire:function(){window.modifyStat("luck",2),window.modifyStat("health",-1)}},PURPLE_OWL:{kanji:"紫梟",kana:"むらさきふくろう",romaji:"murasakifukurou",english:"Purple Owl",description:"+1 LUK",color:"#9370db",hoverColor:7557307,onAcquire:function(){window.modifyStat("luck",1)}},PURPLE_FOX:{kanji:"紫狐",kana:"むらさききつね",romaji:"murasakikitsune",english:"Purple Fox",description:"+3 LUK / -1 POW / -1 AGI",color:"#9370db",hoverColor:7557307,onAcquire:function(){window.modifyStat("luck",3),window.modifyStat("damage",-1),window.modifyStat("fireRate",-1)}},PURPLE_LADYBUG:{kanji:"紫瓢虫",kana:"むらさきてんとうむし",romaji:"murasakitentoumushi",english:"Purple Ladybug",description:"+1 LUK",color:"#9370db",hoverColor:7557307,onAcquire:function(){window.modifyStat("luck",1)}},PURPLE_BAT:{kanji:"紫蝙蝠",kana:"むらさきこうもり",romaji:"murasakikoumori",english:"Purple Bat",description:"+1 LUK",color:"#9370db",hoverColor:7557307,onAcquire:function(){window.modifyStat("luck",1)}},PURPLE_HARE:{kanji:"紫野兎",kana:"むらさきのうさぎ",romaji:"murasakinousagi",english:"Purple Hare",description:"+1 LUK",color:"#9370db",hoverColor:7557307,onAcquire:function(){window.modifyStat("luck",1)}},PURPLE_MOTH:{kanji:"紫蛾",kana:"むらさきが",romaji:"murasakiga",english:"Purple Moth",description:"+1 LUK",color:"#9370db",hoverColor:7557307,onAcquire:function(){window.modifyStat("luck",1)}},PIERCING_SHOTS:{kanji:"貫通",kana:"かんつう",romaji:"kantsuu",english:"Piercing Shot",description:"Pierce through enemies",color:"#00ff88",hoverColor:52326,onAcquire:function(){}},YELLOW_BOOMERANG:{kanji:"黄回",kana:"きかい",romaji:"kikai",english:"Yellow Boomerang",description:"Return with benefits",color:"#FFA500",hoverColor:14518272,onAcquire:function(){}},FINAL_CATASTROPHE:{kanji:"終焉",kana:"しゅうえん",romaji:"shuuen",english:"Final Catastrophe",description:"Apocalyptic blast damages all enemies",color:"#FF3300",hoverColor:13378048,onAcquire:function(){window.triggerOneTimeEffect("shuuen")}},PURPLE_CHAOS:{kanji:"紫混沌",kana:"むらさきこんとん",romaji:"murasakikonton",english:"Purple Chaos",description:"Randomly rearranges all your stats, then +2 LUK",color:"#9932cc",hoverColor:8921788,onAcquire:function(){window.triggerOneTimeEffect("purpleChaos")}},ANGER_RISING:{kanji:"怒上昇",kana:"いかりじょうしょう",romaji:"ikarijoushou",english:"Anger Rising",description:"Get hit, deal more damage (+10%, up to +100%)",color:"#FF4500",hoverColor:14496512,onAcquire:function(){}},ALIEN_MUSHROOM:{kanji:"異菇",kana:"いきのこ",romaji:"ikinoko",english:"Alien Mushroom",description:"+1 to all stats and a brief time dilation",color:"#9966FF",hoverColor:7816413,onAcquire:function(){window.modifyStat("damage",1),window.modifyStat("fireRate",1),window.modifyStat("luck",1),window.modifyStat("health",1),window.TimeDilationSystem&&window.activateTimeDilation&&window.activateTimeDilation(2e3)}},MAGMA_FLOOR:{kanji:"熔地",kana:"ようち",romaji:"youchi",english:"Magma Floor",description:"Creates pools of magma that damage enemies",color:"#FF4400",hoverColor:14492160,onAcquire:function(){window.activateMagmaFloor()}},FROST_SHRAPNEL:{kanji:"氷片",kana:"ひょうへん",romaji:"hyouhen",english:"Frost Shrapnel",description:"Regularly drops ice shards that damage and slow enemies",color:"#00FFFF",hoverColor:56797,onAcquire:function(){window.activateFrostShrapnel()}},OBLIVION_BLOSSOM:{kanji:"忘却の花",kana:"ぼうきゃくのはな",romaji:"boukyakunohana",english:"Oblivion Blossom",description:"Sacrifice all your perks, gaining permanent strength from each memory lost",color:"#BBBBFF",hoverColor:10066397,onAcquire:function(){window.triggerOneTimeEffect("oblivionBlossom")}},COPY_FAIRY:{kanji:"写精",kana:"うつしせい",romaji:"utsushisei",english:"Copy Fairy",description:"Your biggest fan",color:"#55FFAA",hoverColor:3399048,onAcquire:function(){window.activateCopyFairy()}},FUN_FAIRY:{kanji:"遊精",kana:"ゆうせい",romaji:"yuusei",english:"Fun Fairy",description:"Full of tricks",color:"#FF55FF",hoverColor:14496733,onAcquire:function(){window.activateFunFairy()}},COLD_FAIRY:{kanji:"冷精",kana:"れいせい",romaji:"reisei",english:"Cold Fairy",description:"Slow shots",color:"#00FFFF",hoverColor:56797,onAcquire:function(){window.activateColdFairy()}},BERSERK_FAIRY:{kanji:"狂精",kana:"きょうせい",romaji:"kyousei",english:"Berserk Fairy",description:"Wild partner",color:"#FF5500",hoverColor:14496512,onAcquire:function(){window.activateBerserkFairy()}},FLAWLESS_FIGHT:{kanji:"完璧",kana:"かんぺき",romaji:"kanpeki",english:"Flawless Fight",description:"+POW/+AGI as long as you avoid hits",color:"#00FFFF",hoverColor:56797,onAcquire:function(){}},GREEN_DEER:{kanji:"緑鹿",kana:"みどりしか",romaji:"midorishika",english:"Green Deer",description:"+2 END",color:"#00cc66",hoverColor:43588,onAcquire:function(){window.modifyStat("health",2)}},GREEN_FROG:{kanji:"緑蛙",kana:"みどりかえる",romaji:"midorikaeru",english:"Green Frog",description:"+1 POW",color:"#00cc66",hoverColor:43588,onAcquire:function(){window.modifyStat("damage",1)}},GREEN_GAZELLE:{kanji:"緑ガゼル",kana:"みどりガゼル",romaji:"midorigazeru",english:"Green Gazelle",description:"+2 AGI / -1 END",color:"#00cc66",hoverColor:43588,onAcquire:function(){window.modifyStat("fireRate",2),window.modifyStat("health",-1)}},GREEN_HORSE:{kanji:"緑馬",kana:"みどりうま",romaji:"midoriuma",english:"Green Horse",description:"+3 AGI / -1 POW",color:"#00cc66",hoverColor:43588,onAcquire:function(){window.modifyStat("fireRate",3),window.modifyStat("damage",-1)}},GREEN_CRICKET:{kanji:"緑蟋蟀",kana:"みどりこおろぎ",romaji:"midorikoorogi",english:"Green Cricket",description:"+1 LUK",color:"#00cc66",hoverColor:43588,onAcquire:function(){window.modifyStat("luck",1)}},GREEN_RABBIT:{kanji:"緑兎",kana:"みどりうさぎ",romaji:"midoriusagi",english:"Green Rabbit",description:"+2 LUK / -1 AGI",color:"#00cc66",hoverColor:43588,onAcquire:function(){window.modifyStat("luck",2),window.modifyStat("fireRate",-1)}},GREEN_LIZARD:{kanji:"緑蜥蜴",kana:"みどりとかげ",romaji:"midoritokage",english:"Green Lizard",description:"+1 AGI",color:"#00cc66",hoverColor:43588,onAcquire:function(){window.modifyStat("fireRate",1)}},GREEN_HUMMINGBIRD:{kanji:"緑蜂鳥",kana:"みどりはちどり",romaji:"midorihachidori",english:"Green Hummingbird",description:"+1 AGI / +1 POW",color:"#00cc66",hoverColor:43588,onAcquire:function(){window.modifyStat("fireRate",1),window.modifyStat("damage",1)}},GREEN_DOLPHIN:{kanji:"緑海豚",kana:"みどりいるか",romaji:"midoriiruka",english:"Green Dolphin",description:"+2 AGI / -1 END",color:"#00cc66",hoverColor:43588,onAcquire:function(){window.modifyStat("fireRate",2),window.modifyStat("health",-1)}},GREEN_GRASSHOPPER:{kanji:"緑飛蝗",kana:"みどりばった",romaji:"midoribatta",english:"Green Grasshopper",description:"+1 AGI / +1 LUK",color:"#00cc66",hoverColor:43588,onAcquire:function(){window.modifyStat("fireRate",1),window.modifyStat("luck",1)}},GREEN_SNAKE:{kanji:"緑蛇",kana:"みどりへび",romaji:"midorihebi",english:"Green Snake",description:"+1 AGI",color:"#00cc66",hoverColor:43588,onAcquire:function(){window.modifyStat("fireRate",1)}},GREEN_DREAM:{kanji:"緑の夢",kana:"みどりのゆめ",romaji:"midorinoyume",english:"Green Dream",description:"Creates after-images that damage enemies",color:"#00cc66",hoverColor:43588,onAcquire:function(){window.activateAfterImages()}},PURPLE_OWL:{kanji:"紫梟",kana:"むらさきふくろう",romaji:"murasakifukurou",english:"Purple Owl",description:"Chance to fire a second projectile",color:"#9370db",hoverColor:7557307,onAcquire:function(){}},ALIEN_WORLD:{kanji:"異世界",kana:"いせかい",romaji:"isekai",english:"Alien World",description:"When hit, the streams of time shift",color:"#00ffff",hoverColor:56797,onAcquire:function(){}},ALIEN_CLOCK:{kanji:"時の砂",kana:"ときのすな",romaji:"tokinosuna",english:"Alien Clock",description:"Time moves differently on pickup",color:"#00ffff",hoverColor:56797,onAcquire:function(){window.activateAlienClock()}},PURPLE_HEDGEHOG:{kanji:"紫針鼠",kana:"むらさきはりねずみ",romaji:"murasakiharinezumi",english:"Purple Hedgehog",description:"Release projectiles in all directions when hit",color:"#9370db",hoverColor:7557307,onAcquire:function(){window.modifyStat("health",1)}},CRIMSON_SCATTER:{kanji:"紅散弾",kana:"べにさんだん",romaji:"benisandan",english:"Crimson Scatter",description:"Higher damage at short range",color:"#FF3030",hoverColor:12591136,onAcquire:function(){}},CRIMSON_FURY:{kanji:"紅の怒り",kana:"くれないのいかり",romaji:"kurenainoikari",english:"Crimson Fury",description:"Double damage when below 25% health",color:"#FF0000",hoverColor:13369344,onAcquire:function(){}},IMMORTAL_ARM:{kanji:"不死の腕",kana:"ふしのうで",romaji:"fushinoude",english:"Immortal Arm",description:"Summons an arm that orbits you and damages enemies",color:"#9932CC",hoverColor:7938748,onAcquire:function(){window.activateImmortalArm()}},IMMORTAL_HEAD:{kanji:"不死の頭",kana:"ふしのあたま",romaji:"fushinoatama",english:"Immortal Head",description:"Summons a head that orbits close to you and damages enemies",color:"#9932CC",hoverColor:7938748,onAcquire:function(){window.activateImmortalHead()}},IMMORTAL_LEG:{kanji:"不死の脚",kana:"ふしのあし",romaji:"fushinoashi",english:"Immortal Leg",description:"Summons a leg that orbits far from you and damages enemies",color:"#9932CC",hoverColor:7938748,onAcquire:function(){window.activateImmortalLeg()}},GOD_HAMMER:{kanji:"神の鎚",kana:"かみのつち",romaji:"kaminotsuchi",english:"God Hammer",description:"Periodically drops a divine hammer on enemies",color:"#FFD700",hoverColor:14329120,onAcquire:function(){}},ETERNAL_RHYTHM:{kanji:"永遠の律動",kana:"えいえんのりつどう",romaji:"eiennoritsudou",english:"Eternal Rhythm",description:"While moving, gradually increases fire rate up to 2x",color:"#FFDD00",hoverColor:14531328,onAcquire:function(){}},AMBER_NOVA:{kanji:"琥珀爆",kana:"こはくばく",romaji:"kohakubaku",english:"Amber Nova",description:"Projectiles explode on impact, damaging nearby enemies",color:"#FF9500",hoverColor:14512128,onAcquire:function(){}},TITAN_STOMP:{kanji:"巨踏",kana:"きょとう",romaji:"kyotou",english:"Titan Stomp",description:"Chance to create shockwaves around you when firing",color:"#8B4513",hoverColor:7025923,onAcquire:function(){}},AZURE_FROST:{kanji:"蒼霜",kana:"あおしも",romaji:"aoshimo",english:"Azure Frost",description:"Projectiles may slow enemies upon impact",color:"#00ffff",hoverColor:56797,onAcquire:function(){}},DIVINE_BEACON:{kanji:"天の標",kana:"てんのしるべ",romaji:"tennoshirube",english:"Divine Beacon",description:"Heavenly markers summon God Hammers when collected",color:"#FFD700",hoverColor:14596231,onAcquire:function(){}}},PerkSystem={getAllPerks:function(){return Object.keys(PERKS).map((e=>({id:e,...PERKS[e]})))},getPerksByCategory:function(e){return Object.keys(PERKS).filter((t=>PERKS[t].category===e)).map((e=>({id:e,...PERKS[e]})))},getPerkById:function(e){return PERKS[e]?{id:e,...PERKS[e]}:null},getRandomPerks:function(e,t=[]){const i=Object.keys(PERKS).filter((e=>!t.includes(e))).map((e=>({id:e,...PERKS[e]})));for(let e=i.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[i[e],i[t]]=[i[t],i[e]]}return i.slice(0,e)},applyPerk:function(e,t){const i=PERKS[t];return!!i&&(console.log("Applying perk:",t),i.onAcquire(),!0)}};let playerInvincible=!1,playerInvincibilityDuration=960,damageVignette=null;function initPlayerHitSystem(e){cleanupDamageEffects(),createDamageVignette(e),console.log("Player hit system initialized")}function createDamageVignette(e){damageVignette=e.add.container(0,0),damageVignette.setDepth(900),damageVignette.setAlpha(0);const t=game.config.width,i=game.config.height;for(let n=0;n<10;n++){const o=.5*(1-n/10),a=.2*n/9*Math.min(t,i)/2,r=.35/10*Math.min(t,i)/2,s=e.add.rectangle(t/2,a-r/2,t,r,16711680,o);s.setOrigin(.5,.5),damageVignette.add(s);const l=e.add.rectangle(t/2,i-(a-r/2),t,r,16711680,o);l.setOrigin(.5,.5),damageVignette.add(l);const c=e.add.rectangle(a-r/2,i/2,r,i,16711680,o);c.setOrigin(.5,.5),damageVignette.add(c);const d=e.add.rectangle(t-(a-r/2),i/2,r,i,16711680,o);d.setOrigin(.5,.5),damageVignette.add(d)}window.registerEffect("entity",damageVignette)}function showDamageVignette(e,t=1){damageVignette||createDamageVignette(e),damageVignette.fadeTween&&damageVignette.fadeTween.stop(),damageVignette.setAlpha(.9*t),damageVignette.fadeTween=e.tweens.add({targets:damageVignette,alpha:0,duration:.95*playerInvincibilityDuration,ease:"Sine.easeOut",onComplete:function(){damageVignette.setAlpha(0)}})}function cleanupDamageEffects(){damageVignette&&(damageVignette.fadeTween&&(damageVignette.fadeTween.stop(),damageVignette.fadeTween=null),damageVignette.destroy&&damageVignette.destroy(),damageVignette=null)}function playerIsHit(e,t){const i=this;if(playerInvincible)return;if(playerInvincible=!0,i.tweens.add({targets:e,alpha:.5,scale:1.2,duration:playerInvincibilityDuration/6,yoyo:!0,repeat:6,onComplete:function(){e.alpha=1,e.scale=1}}),i.time.delayedCall(playerInvincibilityDuration,(function(){playerInvincible=!1,e.active&&(e.alpha=1,e.scale=1)})),window.handlePlayerHit(i,t))return;const n=t.damage??1;playerHealth-=n,showDamageVignette(i,1),window.GameUI.updateHealthBar(i),playerHealth<1&&playerDeath.call(i,t)}function playerDeath(e){gameOver=!0,PauseSystem.pauseGame(),window.MusicSystem&&window.MusicSystem.applyTimeDilation(1),MusicSystem.removeBossFightEffect();const t=e?e.text:null;window.GameEndMenu.showDefeatScreen(this,t),"undefined"!=typeof gameOverText&&gameOverText.setVisible&&gameOverText.setVisible(!1),"undefined"!=typeof restartButton&&restartButton.setVisible&&restartButton.setVisible(!1)}function resetPlayerHitSystem(){playerInvincible=!1,cleanupDamageEffects()}window.PlayerHitSystem={init:initPlayerHitSystem,playerIsHit:playerIsHit,playerDeath:playerDeath,reset:resetPlayerHitSystem};const ScoreSystem={calculateScore:function(e){const t=rankEnemyStartTimes[BOSS_CONFIG.max_rank]||1200,i=2*t;let n;if(e){const e=3*i,o=Math.min(elapsedTime-t,i);n=Math.floor(e-o)}else{const e=Math.min(elapsedTime,i);n=Math.floor(e)}return console.log("Score calculation:",e?"Victory":"Defeat","Boss spawn time:",t,"Maximum score time:",i,"Elapsed time:",elapsedTime,"Final score:",n),n},animateScoreReveal:function(e,t,i){if(!e||!t)return void console.error("Missing scene or statsText in animateScoreReveal");("number"!=typeof i||isNaN(i))&&(console.error("Invalid finalScore:",i),i=0),console.log("Starting score animation with finalScore:",i);const n=t.text,o=t.x,a=t.y,r=t.depth||0,s=t.parentContainer,l=n.split(/\s{2,}/);if(2!==l.length)return void console.error("Stats text doesn't have expected format:",n);const c=e.add.text(o-150,a,l[0],{fontFamily:"Arial",fontSize:t.style.fontSize,color:"#FFD700"}).setOrigin(.5),d=e.add.text(o+150,a,l[1],{fontFamily:"Arial",fontSize:t.style.fontSize,color:"#FFD700"}).setOrigin(.5);c.setDepth(r),d.setDepth(r),s&&(s.add(c),s.add(d)),t.setVisible(!1);const m=[c,d];e.tweens.add({targets:c,x:o,alpha:0,duration:1e3,delay:500}),e.tweens.add({targets:d,x:o,alpha:0,duration:1e3,delay:500,onComplete:()=>{console.log("Segments merged, creating score text");const n=e.add.text(o,a,"0",{fontFamily:"Arial",fontSize:2*parseInt(t.style.fontSize),color:"#FFD700",fontStyle:"bold"}).setOrigin(.5).setAlpha(0);m.push(n),n.setDepth(r),s&&s.add(n),e.tweens.add({targets:n,alpha:1,duration:500,onComplete:()=>{console.log("Score text fade-in complete, starting counter animation"),this.animateScoreCounter(e,n,i,m)}})}})},activeAnimation:null,showFinalScore:function(e,t,i){e&&t&&!1!==t.active&&(t.setText(i.toString()),e.tweens.add({targets:t,scale:1.2,duration:200,yoyo:!0}))},skipToFinalScore:function(e){return!!this.activeAnimation&&(this.activeAnimation.tween&&this.activeAnimation.tween.stop(),this.showFinalScore(e,this.activeAnimation.textObject,this.activeAnimation.finalScore),this.activeAnimation=null,!0)},animateScoreCounter:function(e,t,i,n){if(!e||!t)return void console.error("Missing scene or textObject in animateScoreCounter");i=Math.floor(i),console.log("Starting counter animation to:",i);const o={value:0},a=Math.min(2e3,1e3+10*i),r=e.tweens.add({targets:o,value:i,duration:a,ease:"Linear",onUpdate:function(){if(t&&!1!==t.active){const e=Math.floor(o.value);t.setText(e.toString())}},onComplete:()=>{console.log("Counter animation complete!"),this.activeAnimation=null,this.showFinalScore(e,t,i)}});return this.activeAnimation={tween:r,textObject:t,finalScore:i},r},cleanup:function(e){e&&Array.isArray(e)&&e.forEach((e=>{e&&e.destroy&&e.destroy()}))}};window.ScoreSystem=ScoreSystem;const VisualEffects={createExplosion:function(e,t,i,n,o=16776960,a={}){const r=a.duration??1e3,s=a.startScale??.01,l=a.strokeWidth??4,c=a.alpha??1,d=e.add.circle(t,i,1*n,o,0);return d.setStrokeStyle(l,o,c),d.setScale(s),e.tweens.add({targets:d,scale:1,alpha:0,duration:r,ease:"Power2",onComplete:function(){d.destroy()}}),d},createPulsing:function(e,t,i={}){const n=i.scaleFrom??.9,o=i.scaleTo??1.1,a=i.duration??1e3,r=i.yoyo??!0,s=i.repeat??-1,l=i.ease??"Sine.InOut",c=i.delay??0;return e.tweens.add({targets:t,scale:{from:n,to:o},duration:a,yoyo:r,repeat:s,ease:l,delay:c})},createDamageFlash:function(e,t){if(t&&t.active)return void 0===t.originalAlpha&&(t.originalAlpha=t.alpha),t.damageAnimation&&!t.damageAnimation.isDestroyed&&(t.damageAnimation.stop(),t.alpha=t.originalAlpha),t.damageAnimation=e.tweens.add({targets:t,alpha:{from:t.originalAlpha,to:.3},duration:100,yoyo:!0,repeat:1,onComplete:function(){t.active&&!t.alphaControlledByEffect&&(t.alpha=t.originalAlpha),t.damageAnimation=null},onStop:function(){t.active&&!t.alphaControlledByEffect&&(t.alpha=t.originalAlpha)}}),t.damageAnimation},createLightningFlash:function(e,t,i,n={}){const o=n.radius??48,a=n.color??16777062,r=n.alpha??.5,s=n.duration??1e3,l=e.add.circle(t,i,o,a,r);return e.tweens.add({targets:l,alpha:0,radius:1.5*o,duration:s,onComplete:function(){l.destroy()}}),l},createLightningStrike:function(e,t,i,n={}){const o=n.damage??playerDamage,a=n.color??"#FFDD00",r=n.size??32,s=n.symbol??"雷",l=e.add.text(t,i-300,s,{fontFamily:"Arial",fontSize:`${r}px`,color:a,fontStyle:"bold"}).setOrigin(.5);return e.tweens.add({targets:l,y:i,duration:500,ease:"Bounce.easeOut",onComplete:function(){VisualEffects.createLightningFlash(e,t,i);const n={symbol:s,color:a,fontSize:r,x:t,y:i,behaviorType:"persistent",damage:o,damageInterval:1e3,lifespan:1e3};DropperSystem.create(e,n),l.destroy()}}),l},convertToColorValue:function(e){if("number"==typeof e)return e;if("string"==typeof e){const t=e.startsWith("#")?e.substring(1):e;return parseInt(t,16)}return 16777215}};window.VisualEffects=VisualEffects;const WeaponSystem={activeWeaponType:"BASIC_PROJECTILE",weaponTimer:null,projectilesGroup:null,piercingProjectilesGroup:null,initialize:function(e){return console.log("Initializing weapon system"),this.initPhysicsGroups(e),this.createWeaponTimer(e),this},initPhysicsGroups:function(e){this.projectilesGroup=e.physics.add.group(),this.piercingProjectilesGroup=e.physics.add.group(),window.projectiles=this.projectilesGroup,window.piercingProjectiles=this.piercingProjectilesGroup,e.physics.add.collider(this.projectilesGroup,EnemySystem.enemiesGroup,this.projectileHitEnemy,null,e),e.physics.add.overlap(this.piercingProjectilesGroup,EnemySystem.enemiesGroup,this.projectileHitEnemy,null,e)},projectileHitEnemy:function(e,t){const i=this;e.active&&t.active&&(e.damageSourceId||(e.damageSourceId=`proj_${Date.now()}_${Math.random()}`),e.components&&ProjectileComponentSystem.processEvent(e,"onHit",t,i),applyContactDamage.call(i,e,t,e.damage,1e3),e.piercing||e.destroy())},createWeaponTimer:function(e){this.weaponTimer&&this.weaponTimer.remove();const t=this.calculateFiringDelay();this.weaponTimer=registerTimer(e.time.addEvent({delay:t,callback:function(){gameOver||gamePaused||WeaponSystem.fireWeapon(this)},callbackScope:e,loop:!0})),console.log(`Weapon timer created with delay: ${t}ms`)},calculateFiringDelay:function(){return shootingDelay/getEffectiveFireRate()},updateFiringRate:function(e){if(!this.weaponTimer)return;const t=this.calculateFiringDelay(),i=this.weaponTimer.delay;if(Math.abs(i-t)>.1*i){const n=this.weaponTimer.elapsed/i;this.weaponTimer.delay=t,this.weaponTimer.reset({delay:t,callback:function(){gameOver||gamePaused||WeaponSystem.fireWeapon(this)},callbackScope:e,loop:!0}),this.weaponTimer.elapsed=n*t,console.log(`Firing rate updated: ${i}ms -> ${t}ms`)}},updateProjectiles:function(e){this.updateProjectileGroup(this.projectilesGroup),this.updateProjectileGroup(this.piercingProjectilesGroup)},updateProjectileGroup:function(e){e&&e.getChildren().forEach((e=>{e&&e.active&&(e.y<-50||e.y>game.config.height+50||e.x<-50||e.x>game.config.width+50?e.destroy():e.components&&Object.keys(e.components).length>0&&(e.components.boomerangEffect&&console.log("Processing boomerang update"),ProjectileComponentSystem.processEvent(e,"update")))}))},fireWeapon:function(e){distance=400*Math.sqrt(playerFireRate/BASE_STATS.AGI);const t=this.findClosestEnemy(e,distance);if(t){const i=Phaser.Math.Angle.Between(player.x,player.y,t.x,t.y);"BASIC_PROJECTILE"===this.activeWeaponType&&this.fireBasicProjectile(e,i)}},fireBasicProjectile:function(e,t){return this.createProjectile(e,{x:player.x,y:player.y,angle:t})},createProjectile:function(e,t){const i={...{x:player.x,y:player.y,symbol:"★",color:"#ffff00",angle:0,speed:400,damage:getEffectiveDamage(),fontSize:getEffectiveSize(),skipComponents:!1},...t},n=e.add.text(i.x,i.y,i.symbol,{fontFamily:"Arial",fontSize:`${i.fontSize}px`,color:i.color,fontStyle:"bold"}).setOrigin(.5);return n.piercing=!1,n.components={},i.skipComponents||ProjectilePerkRegistry.applyPerkEffects(n,e),n.piercing?this.piercingProjectilesGroup.add(n):this.projectilesGroup.add(n),n.body.setSize(n.width/2,n.height/2),n.damage=i.damage,n.body.setVelocity(Math.cos(i.angle)*i.speed,Math.sin(i.angle)*i.speed),n.needsOnFireEvent&&n.components&&Object.values(n.components).forEach((t=>{t.onFire&&t.onFire(n,e,i.angle)})),n},findClosestEnemy:function(e,t){if(!EnemySystem.enemiesGroup||0===EnemySystem.enemiesGroup.getChildren().length)return null;let i=null,n=t;return EnemySystem.enemiesGroup.getChildren().forEach((e=>{if(!e||!e.active)return;const t=Phaser.Math.Distance.Between(player.x,player.y,e.x,e.y);t<n&&(n=t,i=e)})),i},reset:function(e){this.weaponTimer&&(this.weaponTimer.remove(),this.weaponTimer=null),this.projectilesGroup&&this.projectilesGroup.clear(!0,!0),this.piercingProjectilesGroup&&this.piercingProjectilesGroup.clear(!0,!0),this.activeWeaponType="BASIC_PROJECTILE",console.log("Weapon system reset")}};window.WeaponSystem=WeaponSystem;
</script><style>
        html,
        body {
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            height: 100vh;
            height: 100dvh;
            /* Dynamic viewport height for better mobile support */
            color: white;
            font-family: Arial, sans-serif;
            touch-action: none;
            overflow: hidden;
            position: fixed;
            /* Fix to viewport */
            width: 100%;
            top: 0;
            left: 0;
        }

        #game-container {
            width: 100%;
            height: 100vh;
            height: 100dvh;
            /* Dynamic viewport height */
            position: fixed;
            top: 0;
            left: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            /* Change from center to flex-start */
            max-width: 1200px;
            max-height: 800px;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
                margin: 0;
            }

            #game-container {
                width: 100%;
                height: 100vh;
                max-width: none;
                /* Allow full width on mobile */
                max-height: none;
                /* Allow full height on mobile */
            }

            /* Adjust border decorations for smaller screens */
            .border-decoration {
                display: none;
                /* Optional: hide decorations on small screens */
            }
        }

        #game-ui {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 5px;
            z-index: 10;
            pointer-events: none;
            font-size: 14px;
        }

        /* Game border decorations */
        .border-decoration {
            position: absolute;
            background-color: transparent;
            border-style: solid;
            border-color: #FFD700;
            /* Golden color */
            z-index: 5;
        }

        /* Top-left L */
        #border-top-left {
            top: -8px;
            left: -8px;
            width: 200px;
            height: 100px;
            border-width: 8px 0 0 8px;
        }

        /* Top-right L */
        #border-top-right {
            top: -8px;
            right: -8px;
            width: 100px;
            height: 200px;
            border-width: 8px 8px 0 0;
        }

        /* Bottom-left L */
        #border-bottom-left {
            bottom: -8px;
            left: -8px;
            width: 100px;
            height: 200px;
            border-width: 0 0 8px 8px;
        }

        /* Bottom-right L */
        #border-bottom-right {
            bottom: -8px;
            right: -8px;
            width: 200px;
            height: 100px;
            border-width: 0 8px 8px 0;
        }
    </style>
</head>

<body>
    <div id="game-container">
        <!-- L-shaped border decorations -->
        <div id="border-top-left" class="border-decoration"></div>
        <div id="border-top-right" class="border-decoration"></div>
        <div id="border-bottom-left" class="border-decoration"></div>
        <div id="border-bottom-right" class="border-decoration"></div>
    </div>

    <script>
        const KAJISULI_MODE = true;

        // Game configuration
        const config = {
            type: Phaser.AUTO,
            width: KAJISULI_MODE ? 720 : 1200,
            height: KAJISULI_MODE ? 1280 : 800,
            parent: 'game-container',
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            },
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: KAJISULI_MODE ? Phaser.Scale.CENTER_HORIZONTALLY : Phaser.Scale.CENTER_BOTH,
                width: KAJISULI_MODE ? 720 : 1200,
                height: KAJISULI_MODE ? 1280 : 800,
                parent: 'game-container',
                // This is important - it ensures the canvas actually resizes
                // when the browser window changes
                expandParent: false
            }
        };

        // Game variables
        let player;
        let cursors;
        let wasdKeys;
        let keyboardLayout = 'qwerty'; // Default to QWERTY

        // Global variables for pause system
        let pauseScreen = null;
        let resumeButton = null;
        let pauseMessage = null;
        let pauseKeyP = null;

        // Add these variables for stats tracking
        let statsText = null;
        let statsVisible = false;
        let debugModeEnabled = false;

        // Store all game timers in a central array
        let gameTimers = [];

        // Register a timer with the central system
        function registerTimer(timer) {
            if (timer && timer instanceof Phaser.Time.TimerEvent) {
                gameTimers.push(timer);
                // If game is currently paused, pause the new timer too
                if (gamePaused && timer.paused !== undefined) {
                    timer.paused = true;
                }
            }
            return timer; // Return the timer for convenience
        }

        // Clean up timers that are no longer active
        function cleanupTimers() {
            gameTimers = gameTimers.filter(timer =>
                timer && !timer.hasOwnProperty('removed') && !timer.removed);
        }

        let activeEffects = {
            timers: [],         // Store all active timers
            entities: [],       // Store all entities created by perks 
            activePerks: []     // Store all acquired perks
        };

        // Initial player stats
        let basePlayerSpeed = 8;
        let baseProcChance = 0.2;
        let baseShootingDelay = 2000;
        let baseHeroExpToLevel = 5;
        let acquiredPerks = [];
        let playerHealth = BASE_STATS.END;
        let maxPlayerHealth = BASE_STATS.END;
        let playerSpeed = basePlayerSpeed;
        let playerDamage = BASE_STATS.POW;
        let playerLuck = BASE_STATS.LUK;
        let shootingDelay = baseShootingDelay; // ms between shots
        let playerFireRate = BASE_STATS.AGI; // Multiplier for shooting rate
        let projectileSizeFactor = 4; // Multiply player damage by this to get proj size
        let berserkMultiplier = 1.0;
        let archerMultiplier = 1.0;
        let score = 0;
        let level = 1;
        let touchInput = { x: 0, y: 0, isActive: false };
        let gameOver = false;
        let gameOverText;
        let restartButton;

        // Track elapsed time
        let elapsedTime = 0; // in seconds

        // Hero experience system
        let playerLevel = 1;
        let heroExp = 0;
        let levelUpCards = [];
        let gamePaused = false;
        let levelUpInProgress = false;

        // Perk system variables
        let playerPerks = {};
        let shieldVisual = null;
        let healthRegenTimer = null;

        // Format time to hh:mm:ss
        function formatTime(seconds) {
            if (seconds < 3600) {
                // Under 1 hour, use mm:ss format
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                // Over 1 hour, use hh:mm format (no seconds)
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            }
        }

        // Helper function to calculate XP needed for next level
        function xpForNextLevel(heroLevel) {
            return Math.ceil(baseHeroExpToLevel * Math.pow(1.2, heroLevel - 1));
        }

        // Effective Damage
        function getEffectiveDamage() {
            return playerDamage * berserkMultiplier;
        }

        // Function to calculate the effective fire rate
        function getEffectiveFireRate() {
            return playerFireRate * archerMultiplier;
        }

        // Calculate effective projectile size based on damage
        function getEffectiveSize(baseFontSize, damageValue) {
            // If no base size provided, use the global projectileSizeFactor
            const baseSize = baseFontSize ?? projectileSizeFactor;

            // Use provided damage or default to getEffectiveDamage()
            const damage = damageValue ?? getEffectiveDamage();

            // Get the scaling factor using square root approach
            const scalingFactor = Math.sqrt(damage / BASE_STATS.POW);

            // Apply scaling to base size with the multiplier of 4
            return baseSize * scalingFactor * 4;
        }

        // Proc chance
        function calculateProcChance(luck, baseChance) {
            return baseChance * Math.sqrt(luck / BASE_STATS.LUK);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Add this helper function to register effects
        window.registerEffect = function (type, item) {
            if (type === 'timer' && item) {
                activeEffects.timers.push(item);
                // If game is paused, also pause the new timer
                if (gamePaused && item.paused !== undefined) {
                    item.paused = true;
                }
            } else if (type === 'entity' && item) {
                activeEffects.entities.push(item);
            }
        };

        // Perk system helper functions
        function initializePerks() {
            playerPerks = {};
        }

        // Update the acquirePerk function to register perks
        function acquirePerk(scene, perkId) {
            // Skip if already acquired
            if (acquiredPerks.includes(perkId)) return false;

            // Add to acquired perks list
            acquiredPerks.push(perkId);
            activeEffects.activePerks.push(perkId);

            // Apply the perk
            return PerkSystem.applyPerk(scene, perkId);
        }

        // Add this cleanup function to your startGame function
        function clearAllPerkEffects() {
            // Clear all timers
            activeEffects.timers.forEach(timer => {
                if (timer) {
                    timer.remove();
                }
            });

            // Clear all entities
            activeEffects.entities.forEach(entity => {
                if (entity && entity.active) {
                    entity.destroy();
                }
            });

            // Reset active effects
            activeEffects.timers = [];
            activeEffects.entities = [];
            activeEffects.activePerks = [];

            // Make sure time flows
            window.TimeDilationSystem.cleanup();
        }

        function resetAllPerks() {
            // Call onReset for all perks that were acquired
            for (const perkId in playerPerks) {
                if (perkRegistry[perkId] && perkRegistry[perkId].onReset) {
                    perkRegistry[perkId].onReset();
                }
            }
            // Reset the perks object
            playerPerks = {};
        }

        function hasPerk(perkId) {
            return acquiredPerks.includes(perkId);
        }

        // Create the game instance
        const game = new Phaser.Game(config);

        function preload() {
            // No image assets to preload
        }

        function create() {
            // Listen for the Phaser-specific resize event which is more reliable
            this.scale.on('resize', (gameSize, baseSize, displaySize, resolution) => {
                console.log(`Game resized: ${displaySize.width}x${displaySize.height}`);

                // Update UI with the new dimensions
                setTimeout(() => {
                    // Get the active scene
                    const activeScene = this;
                    if (activeScene) {
                        // Refresh the UI with the new dimensions
                        GameUI.resize(activeScene);
                    }
                }, 100);
            });

            // Initialize perk system first
            initializePerks();

            // Record game start time for difficulty scaling
            gameStartTime = this.time.now;

            // Detect keyboard layout
            detectKeyboardLayout.call(this);

            // Initialize our new systems
            RomajiChallengeSystem.init(this);
            PauseSystem.init(this);
            DebugSystem.init(this);
            LifeSystem.initialize(this);
            WeaponSystem.initialize(this);
            PlayerHitSystem.init(this);
            InputSystem.setupCursorHiding(this);
            BackgroundAnimationSystem.init(this);

            // Initialize music system
            if (window.MusicSystem) {
                MusicSystem.initialize(this);
                MusicSystem.preload(this);

                // Create music tracks once preload is complete
                this.load.once('complete', function () {
                    MusicSystem.create(this);
                    MusicSystem.start();
                }, this);

                // Start loading
                this.load.start();
            }

            // Create player text - using kanji character
            player = this.add.text(game.config.width / 2, game.config.height / 2, HERO_CHARACTER, {
                fontFamily: 'Arial',
                fontSize: '32px',
                color: '#ffffff',
                fontStyle: 'bold'
            }).setOrigin(0.5).setDepth(50);

            // Store all language and educational properties
            player.kana = HERO_KANA;
            player.romaji = HERO_ROMAJI;
            player.english = HERO_ENGLISH;

            // Add physics to player
            this.physics.world.enable(player);
            player.body.setCollideWorldBounds(true);

            GameUI.createUI(this);
            OrbitalSystem.init();

            // Create shield visual (initially invisible)
            shieldVisual = this.add.circle(player.x, player.y, 30, 0x3498db, 0.4);
            shieldVisual.setStrokeStyle(3, 0x0088ff);
            shieldVisual.setVisible(false);

            // Add health regeneration
            LifeSystem.setupHealthRegeneration(this);

            // Create enemy group
            EnemySystem.initialize(this);

            // Create projectile group
            projectiles = this.physics.add.group();

            // Set up collision between player and EnemySystem.enemiesGroup
            this.physics.add.overlap(player, EnemySystem.enemiesGroup, PlayerHitSystem.playerIsHit, null, this);

            // Set up cursor keys for movement
            cursors = this.input.keyboard.createCursorKeys();

            // Set up WASD keys for movement based on detected layout
            updateWASDKeys.call(this);

            // Set up touch controls
            this.input.on('pointerdown', (pointer) => {
                touchInput.isActive = true;
                touchInput.x = pointer.x;
                touchInput.y = pointer.y;
            });

            this.input.on('pointermove', (pointer) => {
                if (touchInput.isActive) {
                    touchInput.x = pointer.x;
                    touchInput.y = pointer.y;
                }
            });

            this.input.on('pointerup', () => {
                touchInput.isActive = false;
            });

            // Create the game over screen (hidden initially)
            gameOverText = this.add.text(game.config.width / 2, game.config.height / 2,
                'GAME OVER',
                { fontFamily: 'Arial', fontSize: '40px', color: '#ff0000', fontStyle: 'bold' }
            ).setOrigin(0.5).setVisible(false);

            // Create restart button (hidden initially)
            restartButton = this.add.text(game.config.width / 2, game.config.height * 0.75,
                'PLAY AGAIN',
                { fontFamily: 'Arial', fontSize: '24px', color: '#ffffff', backgroundColor: '#880000', padding: { left: 15, right: 15, top: 10, bottom: 10 } }
            ).setOrigin(0.5).setVisible(false).setInteractive();

            // Add restart button functionality
            restartButton.on('pointerdown', startGame, this);

            // Create learning feedback text (initially empty)
            this.learningFeedback = this.add.text(game.config.width / 2, game.config.height * 0.9625, '', {
                fontFamily: 'Arial',
                fontSize: '32px',
                color: '#ffffff',
                stroke: '#000000', // Add stroke for better readability with different colors
                strokeThickness: 2,
                align: 'center'
            }
            ).setOrigin(0.5).setDepth(100); // Ensure it displays above other elements

            // Start the game by calling startGame (replaces the need for duplicate initialization)
            startGame.call(this);
        }

        // Add this to your update function
        function update(time, delta) {
            if (gameOver) return;
            if (gamePaused) return; // Skip updates when game is paused for level up

            if (window.BackgroundAnimationSystem && BackgroundAnimationSystem.isInitialized) {
                BackgroundAnimationSystem.update(time, delta);
            }

            DebugSystem.updatePerformanceStats(this, time, delta);
            updatePlayerStatus();
            updateOnHitEffects();

            // Increment elapsed time
            elapsedTime += (delta / 1000) * this.time.timeScale;

            // Update weapon firing rate if needed
            WeaponSystem.updateFiringRate(this);
            WeaponSystem.updateProjectiles(this);

            // Update the level display to show time survived
            GameUI.updateStatusDisplay(this, elapsedTime, score);

            // Player movement with keyboard
            player.body.setVelocity(0);

            if (cursors.left.isDown || wasdKeys.left.isDown) {
                player.body.setVelocityX(-playerSpeed * 50);
            } else if (cursors.right.isDown || wasdKeys.right.isDown) {
                player.body.setVelocityX(playerSpeed * 50);
            }

            if (cursors.up.isDown || wasdKeys.up.isDown) {
                player.body.setVelocityY(-playerSpeed * 50);
            } else if (cursors.down.isDown || wasdKeys.down.isDown) {
                player.body.setVelocityY(playerSpeed * 50);
            }

            // Player movement with touch
            if (touchInput.isActive) {
                // Calculate direction vector
                const dx = touchInput.x - player.x;
                const dy = touchInput.y - player.y;

                // Normalize and scale
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance > 5) {  // Add a small threshold to prevent jitter
                    player.body.setVelocityX((dx / distance) * playerSpeed * 50);
                    player.body.setVelocityY((dy / distance) * playerSpeed * 50);
                }
            }

            // Update enemies
            EnemySystem.updateEnemies();

            // Update enemy spawners
            EnemySystem.updateEnemySpawners();

            // Keep shield visual positioned on player
            if (shieldVisual) {
                shieldVisual.x = player.x;
                shieldVisual.y = player.y;
            }


            // Updated projectile processing
            projectiles.getChildren().forEach(projectile => {
                // Check if out of bounds
                if (projectile.y < -50 || projectile.y > game.config.height + 50 ||
                    projectile.x < -50 || projectile.x > game.config.width + 50) {
                    projectile.destroy();
                    return;
                }

                // Process component updates
                if (projectile.components && Object.keys(projectile.components).length > 0) {
                    ProjectileComponentSystem.processEvent(projectile, 'update');
                }
            });

            // Update health bar
            GameUI.updateHealthBar(this);
            GameUI.updateExpBar(this);


            // Update orbitals
            OrbitalSystem.update(this, time);
            DropperSystem.update(this, time);

            if (window.MusicSystem) {
                MusicSystem.update(time, delta);
            }

            // Calculate difficulty scaling based on elapsed time instead of raw time
            const minutesElapsed = elapsedTime / 60;

            // Update player stats text
            GameUI.updateStatCircles(this);

            // Update player level
            if (heroExp >= xpForNextLevel(playerLevel)) {
                levelUp.call(this);
            }
        }

        function levelUp() {
            // Calculate excess XP
            const excessXP = heroExp - xpForNextLevel(playerLevel);

            // Increase player level
            playerLevel++;

            // Set XP to excess amount (instead of resetting to 0)
            heroExp = Math.max(0, excessXP);

            // Update the XP bar with new values
            GameUI.updateExpBar(this);

            CardSystem.showLevelUpScreen(this);
        }

        function detectKeyboardLayout() {
            // Check if we're running locally
            const isLocalEnvironment =
                window.location.hostname === 'localhost' ||
                window.location.hostname === '127.0.0.1' ||
                window.location.hostname.startsWith('192.168.1.') ||
                window.location.protocol === 'file:'; // For direct file access

            // Default to AZERTY for local development, QWERTY otherwise
            keyboardLayout = isLocalEnvironment ? 'azerty' : 'qwerty';

            console.log(`Keyboard layout set to ${keyboardLayout} (${isLocalEnvironment ? 'local environment' : 'remote environment'})`);

            // Try the API detection if we're in a secure context and not local
            if (window.isSecureContext && !isLocalEnvironment && navigator.keyboard && navigator.keyboard.getLayoutMap) {
                navigator.keyboard.getLayoutMap()
                    .then(keyboardLayoutMap => {
                        const qKey = keyboardLayoutMap.get('KeyQ');
                        if (qKey === 'a' || qKey === 'A') {
                            keyboardLayout = 'azerty';
                            updateWASDKeys.call(this);
                            console.log("AZERTY keyboard detected via API");
                        }
                    })
                    .catch(error => {
                        console.log('Error in keyboard API detection:', error);
                    });
            }

            // Update keys based on our determined layout
            updateWASDKeys.call(this);

            // Always add a keyboard shortcut to toggle layout if needed
            this.input.keyboard.once('keydown-L', function () {
                keyboardLayout = keyboardLayout === 'qwerty' ? 'azerty' : 'qwerty';
                updateWASDKeys.call(this);

                // Show confirmation
                const confirmation = this.add.text(
                    game.config.width / 2,
                    game.config.height / 2,
                    `Switched to ${keyboardLayout.toUpperCase()} layout`,
                    {
                        fontFamily: 'Arial',
                        fontSize: '24px',
                        color: '#ffffff',
                        backgroundColor: '#333333',
                        padding: { x: 10, y: 5 }
                    }
                ).setOrigin(0.5).setDepth(1000);

                // Fade out
                this.tweens.add({
                    targets: confirmation,
                    alpha: 0,
                    y: confirmation.y - 30,
                    duration: 2000,
                    onComplete: function () { confirmation.destroy(); }
                });

                // Add another listener for additional toggles
                this.input.keyboard.once('keydown-L', arguments.callee, this);
            }, this);
        }

        function updateWASDKeys() {
            // Update keys based on detected layout
            if (keyboardLayout === 'azerty') {
                // AZERTY layout uses ZQSD for movement
                wasdKeys = this.input.keyboard.addKeys({
                    up: Phaser.Input.Keyboard.KeyCodes.Z,
                    down: Phaser.Input.Keyboard.KeyCodes.S,
                    left: Phaser.Input.Keyboard.KeyCodes.Q,
                    right: Phaser.Input.Keyboard.KeyCodes.D
                });
            } else {
                // QWERTY layout uses WASD for movement
                wasdKeys = this.input.keyboard.addKeys({
                    up: Phaser.Input.Keyboard.KeyCodes.W,
                    down: Phaser.Input.Keyboard.KeyCodes.S,
                    left: Phaser.Input.Keyboard.KeyCodes.A,
                    right: Phaser.Input.Keyboard.KeyCodes.D
                });
            }
        }

        // Updated modifyStat function that handles negative values
        window.modifyStat = function (statName, amount) {
            const scene = game.scene.scenes[0];
            if (!scene) return;

            switch (statName) {
                case 'damage':
                    playerDamage += amount;
                    // Ensure damage doesn't go below 1
                    playerDamage = Math.max(1, playerDamage);
                    break;
                case 'speed':
                    playerSpeed += amount;
                    // Ensure speed doesn't go below 1
                    playerSpeed = Math.max(1, playerSpeed);
                    break;
                case 'health':
                    maxPlayerHealth += amount;
                    // Ensure maxHealth doesn't go below 1
                    maxPlayerHealth = Math.max(1, maxPlayerHealth);
                    // If reducing max health, also cap current health
                    if (amount < 0 && playerHealth > maxPlayerHealth) {
                        playerHealth = maxPlayerHealth;
                    } else if (amount > 0) {
                        // If increasing max health, also increase current health
                        playerHealth += amount;
                    }
                    LifeSystem.setupHealthRegeneration(scene);
                    break;
                case 'luck':
                    playerLuck += amount;
                    // Ensure luck doesn't go below 1
                    playerLuck = Math.max(1, playerLuck);
                    break;
                case 'fireRate':
                    playerFireRate += amount;

                    // Ensure fire rate doesn't go below 1
                    playerFireRate = Math.max(1, playerFireRate);
                    break;
            }
            // Update UI
            GameUI.updateStatCircles(this);
        };

        function startGame() {


            // Reset game state variables
            gameOver = false;
            gamePaused = false;
            levelUpInProgress = false;
            elapsedTime = 0;
            score = 0;
            level = 1;

            // Clean up game end screens if they exist
            if (window.GameEndMenu) {
                window.GameEndMenu.destroy();
            }

            // Reset player status components
            resetPlayerStatus();
            CooldownManager.initialize();
            PlayerHitSystem.reset();

            // Reset enemy system
            EnemySystem.reset();

            // Initialize enemy spawners
            EnemySystem.initializeEnemySpawners();

            // Initialize enemy tiers with dynamic assignments
            initializeEnemyTiers();

            // Reset and initialize weapon system
            WeaponSystem.reset(this);
            WeaponSystem.initialize(this);

            resetOnHitEffects();

            // Clean up old timers
            cleanupTimers();

            // Reset our new systems (quick pause/unpause hack to clean tweens)
            if (PauseSystem) {
                PauseSystem.pauseGame(false);
                PauseSystem.resumeGame();
                PauseSystem.cleanup();
            }

            // Ensure music is playing when game restarts
            if (window.MusicSystem && !MusicSystem.currentTrack) {
                MusicSystem.start();
            }

            if (RomajiChallengeSystem) {
                RomajiChallengeSystem.resetState();
            }

            // Hide pause screen if it was visible
            if (pauseScreen) pauseScreen.setVisible(false);
            if (pauseMessage) pauseMessage.setVisible(false);
            if (resumeButton) resumeButton.setVisible(false);

            // Hide legacy game over elements if they exist
            if (typeof gameOverText !== 'undefined' && gameOverText.setVisible) {
                gameOverText.setVisible(false);
            }
            if (typeof restartButton !== 'undefined' && restartButton.setVisible) {
                restartButton.setVisible(false);
            }

            // Reset player stats to base values
            playerHealth = BASE_STATS.END;
            maxPlayerHealth = BASE_STATS.END;
            playerSpeed = basePlayerSpeed;
            playerDamage = BASE_STATS.POW;
            playerLuck = BASE_STATS.LUK;
            playerFireRate = BASE_STATS.AGI;

            // Reset XP and level
            heroExp = 0;
            playerLevel = 1;

            // Reset player position
            player.x = game.config.width / 2;
            player.y = game.config.height / 2;

            // Reset UI
            player.setFontSize(32);
            GameUI.updateHealthBar(this);
            GameUI.updateExpBar(this);

            // Reset all perk effects
            clearAllPerkEffects();
            acquiredPerks = [];

            // Clear learning feedback
            if (this.learningFeedback) {
                this.learningFeedback.setText('');
            }

            // Restart health regeneration
            LifeSystem.setupHealthRegeneration(this);

            // Reset difficulty scaling
            gameStartTime = this.time.now;

            // Clear projectiles
            projectiles.clear(true, true);

            // Resume physics
            this.physics.resume();

            // Reset perks system
            resetAllPerks();
            // If using the new perks system
            if (typeof acquiredPerks !== 'undefined') {
                acquiredPerks = [];
            }

            // Update player stats text
            GameUI.updateStatCircles(this);
        }</script>
</body>

</html>